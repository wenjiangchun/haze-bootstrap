// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper dojo/_base/lang ../../../../Color ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./ElevationAligners ./Graphics3DSymbolCommonCode ./graphicUtils ./FastSymbolUpdates ./objectResourceUtils ../../lib/glMatrix ../../support/aaBoundingBox ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/materials/Material ../../webgl-engine/materials/internal/MaterialUtil".split(" "),function(f,
u,J,A,B,v,y,C,n,K,r,D,E,m,l,L,g,M,z){var w=E.mat4d,F=E.vec3d,p=[1,1,1],x=[1,1,1,1],G=[0,0,0];f=[-.5,-.5,-.5,.5,.5,.5];u=[-.5,-.5,0,.5,.5,1];var H={sphere:f,cube:f,cylinder:u,cone:u,"inverted-cone":u,tetrahedron:[-.5,-.5,0,.5,.5,.5],diamond:f},I=[l.ModelContentType.MATERIAL,l.ModelContentType.TEXTURE,l.ModelContentType.GEOMETRY];v=function(f){function d(){return null!==f&&f.apply(this,arguments)||this}J(d,f);d.prototype._prepareResources=function(){var a=this.symbol,b=this._getStageIdHint();a.resource&&
a.resource.href?this._prepareModelResources(a.resource.href,b):this._preparePrimitiveResources(a.resource?a.resource.primitive:"sphere",b)};d.prototype._preparePrimitiveResources=function(a,b){var c=this.symbol;if("sphere"===a)this._geometryData=g.createPolySphereGeometry(.5,2,!0);else if("cube"===a)this._geometryData=g.createBoxGeometry(1);else if("cylinder"===a)this._geometryData=g.createCylinderGeometry(1,.5,32,[0,0,1],[0,0,.5]);else if("cone"===a)0>c.height?(this._geometryData=g.createConeGeometry(1,
.5,15,!0),c.height=-c.height):this._geometryData=g.createConeGeometry(1,.5,15,!1),g.cgToGIS(this._geometryData);else if("inverted-cone"===a)this._geometryData=g.createConeGeometry(1,.5,15,!0),g.cgToGIS(this._geometryData);else if("tetrahedron"===a)this._geometryData=g.createTetrahedronGeometry(1),g.cgToGIS(this._geometryData);else if("diamond"===a)this._geometryData=g.createDiamondGeometry(1),g.cgToGIS(this._geometryData);else{console.warn("Unknown object symbol primitive: "+a);this.reject();return}this._geometry=
new L(this._geometryData,b);this._context.stage.add(l.ModelContentType.GEOMETRY,this._geometry);this._resourceBoundingBox=H[a];this._resourceSize=m.size(this._resourceBoundingBox);this._symbolSize=c.computeSizeWithResourceSize(this._resourceSize);a=this._getMaterialOpacity();a={specular:[0,0,0],shininess:3,opacity:a,transparent:1>a||this._isPropertyDriven("opacity"),instanced:["transformation"],ambient:p,diffuse:p};if(this._isPropertyDriven("color"))a.externalColor=x;else{var h=c.material?B.toUnitRGBA(c.material.color):
x;a.externalColor=h}c.material&&c.material.colorMixMode&&(a.externalColorMixMode=z.externalColorMixModes[c.material.colorMixMode]);this._fastUpdates=r.initFastSymbolUpdatesState(this._context.renderer,this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions());this._fastUpdates.enabled?(A.mixin(a,this._fastUpdates.materialParameters),a.instanced.push("featureAttribute")):this._hasPerInstanceColor()&&a.instanced.push("color");this._material=new M(a,b+"_objectmat");this._context.stage.add(l.ModelContentType.MATERIAL,
this._material);this.resolve()};d.prototype._prepareModelResources=function(a,b){var c=this;b={materialParamsMixin:{instanced:["transformation"]},bakeTransformations:!0,idHint:b,streamDataSupplier:this._context.streamDataSupplier};this._fastUpdates=r.initFastSymbolUpdatesState(this._context.renderer,this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions());this._fastUpdates.enabled?(A.mixin(b.materialParamsMixin,this._fastUpdates.materialParameters),b.materialParamsMixin.instanced.push("featureAttribute")):
this._hasPerInstanceColor()&&b.materialParamsMixin.instanced.push("color");this._symbolLoaderPromise=D.fetch(a,b);this._symbolLoaderPromise.then(function(a){c._symbolLoaderPromise=null;if(!c.isRejected()){var b=a.stageResources,h=c._context.stage,d=c._computeModelColorOverride(c.symbol.material),k=c._computeModelOpacityOverride(),t=b[l.ModelContentType.MATERIAL];a.originalMaterialOpacities=Array(t.length);t.forEach(function(b,c){var e=b.getParameterValues();a.originalMaterialOpacities[c]=e.opacity;
d&&b.setParameterValues(d);null!=k.overwrite?b.setParameterValues({opacity:k.overwrite,transparent:k.blendingRequired}):null!=k.multiply&&(e.opacity*=k.multiply,e.transparent=1>e.opacity,b.setParameterValues({opacity:e.opacity,transparent:e.transparent}))});I.forEach(function(a){for(var c=b[a],e=0;c&&e<c.length;e++)h.add(a,c[e])});c._resourceBoundingBox=D.computeBoundingBox(a);c._resourceSize=m.size(c._resourceBoundingBox);c._pivotOffset=a.pivotOffset;c._symbolSize=c.symbol.computeSizeWithResourceSize(c._resourceSize);
c._i3sModel=a;r.updateFastSymbolUpdatesState(c._fastUpdates,c._context.renderer,c._fastVisualVariableConvertOptions())&&t.forEach(function(a){return a.setParameterValues(c._fastUpdates.materialParameters)});c.resolve()}},function(){c._symbolLoaderPromise=null;c.isFulfilled()||c.reject()})};d.prototype._forEachMaterial=function(a){this._i3sModel?this._i3sModel.stageResources[l.ModelContentType.MATERIAL].forEach(a):a(this._material)};d.prototype._computeModelOpacityOverride=function(){var a={overwrite:null,
blendingRequired:!1,multiply:null},b=this._getMaterialOpacity();this._isPropertyDriven("opacity")?(a.overwrite=b,a.blendingRequired=!0):this.symbol.material&&void 0!==this.symbol.material.transparency?(a.overwrite=b,a.blendingRequired=1>a.overwrite):1>b&&(a.multiply=b,a.blendingRequired=!0);return a};d.prototype._computeModelColorOverride=function(a){var b={};a&&a.colorMixMode&&(b.externalColorMixMode=z.externalColorMixModes[a.colorMixMode]);this._isPropertyDriven("color")?b.externalColor=x:a&&a.color?
b.externalColor=B.toUnitRGBA(a.color):(b.externalColor=x,b.externalColorMixMode=z.externalColorMixModes.ignore);return b};d.prototype.destroy=function(){this.isFulfilled()||this.reject();this._symbolLoaderPromise&&this._symbolLoaderPromise.cancel();var a=this._context.stage;if(this._i3sModel){var b=this._i3sModel.stageResources;I.forEach(function(c){for(var h=b[c],e=0;h&&e<h.length;e++)a.remove(c,h[e].getId())})}else this._material&&a.remove(l.ModelContentType.MATERIAL,this._material.getId()),this._geometry&&
a.remove(l.ModelContentType.GEOMETRY,this._geometry.getId())};d.prototype._getGeometry=function(a){a=a.geometry;return"polyline"===a.type?n.placePointOnPolyline(a):"polygon"===a.type?n.placePointOnPolygon(a):"extent"===a.type?a.center:"point"!==a.type?(this._logWarning("unsupported geometry type for object symbol: "+a.type),null):a};d.prototype.createGraphics3DGraphic=function(a,b){var c=this._getGeometry(a);if(null===c)return null;var h="graphic"+a.uid,e=this._getGraphicElevationInfo(a);return this._createAs3DShape(a,
c,b,e,h,a.uid)};d.prototype.layerPropertyChanged=function(a,b,c){var h=this;if("opacity"===a){if(this._i3sModel){var e=this._computeModelOpacityOverride();this._i3sModel.stageResources[l.ModelContentType.MATERIAL].forEach(function(a,b){null!=e.overwrite?a.setParameterValues({opacity:e.overwrite,transparent:e.blendingRequired}):(b=h._i3sModel.originalMaterialOpacities[b],null!=e.multiply&&(b*=e.multiply),a.setParameterValues({opacity:b,transparent:1>b}))})}else b=this._getMaterialOpacity(),this._material.setParameterValues({opacity:b,
transparent:1>b||this._isPropertyDriven("opacity")});return!0}if("elevationInfo"===a){this._updateElevationInfo();a=this._context.elevationProvider;var d=this._context.renderCoordsHelper,g=C.perObjectElevationAligner,k=n.ELEV_MODES.ABSOLUTE_HEIGHT,t;for(t in b){var f=b[t],q=f._graphics[c];q&&q instanceof y&&(f=this._getGraphicElevationInfo(f.graphic),q.elevationAligner=f.mode!==k?g:null,q.elevationInfo.set(f),g(q,a,d))}return!0}return!1};d.prototype.applyRendererDiff=function(a,b,c,d){var e=this,
h;for(h in a.diff)switch(h){case "visualVariables":if(r.updateFastSymbolUpdatesState(this._fastUpdates,b,this._fastVisualVariableConvertOptions()))this._forEachMaterial(function(a){return a.setParameterValues(e._fastUpdates.materialParameters)});else return!1;break;default:return!1}return!0};d.prototype._createAs3DShape=function(a,b,c,h,e,d){var g=this,k=null,f=null;if(a=this._getFastUpdateAttrValues(a))k=k||{},k.featureAttribute=a,f=function(a){return r.evaluateModelTransform(g._fastUpdates.materialParameters,
k.featureAttribute,a)};!this._fastUpdates.enabled&&this._hasPerInstanceColor()&&(k=k||{},k.color=K.mixinColorAndOpacity(c.color,c.opacity));var m=this._context.layer.id;a=w.identity();this._applyObjectRotation(c,this.symbol,a);this._applyObjectScale(c,a);this._applyAnchor(a);if(this._i3sModel){c=this._i3sModel.stageResources[l.ModelContentType.GEOMETRY];var q=this._i3sModel.materialsByComponent;e=n.createStageObjectForPoint.call(this,b,null,null,null,null,h,e,m,d);if(null===e)return null;for(d=0;d<
c.length;d++)e.object.addGeometry(c[d],q[d],a,k,null,f)}else e=n.createStageObjectForPoint.call(this,b,[this._geometry],[[this._material]],[a],k,h,e,m,d,null,f);if(null===e)return null;if(this._fastUpdates.enabled){var p=r.getMaterialParams(this._fastUpdates.visualVariables,this._fastVisualVariableConvertOptions());this._forEachMaterial(function(a){return a.setParameterValues(p)})}e.object.setCastShadow(!0);f=null;h.mode!==n.ELEV_MODES.ABSOLUTE_HEIGHT&&(f=C.perObjectElevationAligner);h=new y(this,
e.object,null,null,null,f,h,y.VisibilityModes.REMOVE_OBJECT);h.alignedTerrainElevation=e.terrainElevation;n.extendPointGraphicElevationInfo(h,b,this._context.elevationProvider);return h};d.prototype._computeObjectScale=function(a){var b=Array(3),c=this._isPropertyDriven("size")&&a&&a.size?a.size:this._symbolSize,d,e=0;for(a=2;0<=a;a--){var f=c[a],g=void 0;if(null!=f&&isFinite(f))g=f/this._resourceSize[a];else if("symbolValue"===f||0===a&&!d)g=this._symbolSize[a]/this._resourceSize[a];null!=g&&(d=
b[a]=g,e=Math.max(e,Math.abs(g)))}for(a=2;0<=a;a--)null==b[a]?b[a]=d:0===b[a]&&(b[a]=.001*e);d=this._context.renderCoordsHelper.unitInMeters;for(a=2;0<=a;a--)b[a]/=d;return b};d.prototype._applyObjectScale=function(a,b){this._fastUpdates.enabled&&this._fastUpdates.customTransformation||(a=this._computeObjectScale(a),1===a[0]&&1===a[1]&&1===a[2]||w.scale(b,a))};d.prototype._applyObjectRotation=function(a,b,c){if(!this._fastUpdates.enabled||!this._fastUpdates.customTransformation)return a=(a.rotationAngle||
0)+(b.heading||0),0!==a?w.rotateZ(c,-a/180*Math.PI,c):null};d.prototype._computeAnchor=function(){switch(this.symbol.anchor){case "center":return F.scale(m.center(this._resourceBoundingBox),-1);case "bottom":var a=m.center(this._resourceBoundingBox);return[-a[0],-a[1],-this._resourceBoundingBox[2]];default:return this._pivotOffset?F.scale(this._pivotOffset,-1,Array(3)):G}};d.prototype._applyAnchor=function(a){if(!this._fastUpdates.enabled||!this._fastUpdates.customTransformation){var b=this._computeAnchor();
b&&w.translate(a,b)}};d.prototype._hasPerInstanceColor=function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")};d.prototype._supportsShaderVisualVariables=function(){return this._context.stage.has("angleInstancedArrays")?!0:!1};d.prototype._fastVisualVariableConvertOptions=function(){var a=this._resourceBoundingBox?m.size(this._resourceBoundingBox):p,b=this._resourceBoundingBox?this._computeAnchor():G;return{modelSize:a,symbolSize:this._symbolSize||p,unitInMeters:this._context.renderCoordsHelper.unitInMeters,
transformation:{anchor:b,scale:this._symbolSize&&this._resourceSize?this._computeObjectScale():p,rotation:this.symbol.heading||0}}};return d}(v);v.PRIMITIVE_BOUNDING_BOX=H;return v});