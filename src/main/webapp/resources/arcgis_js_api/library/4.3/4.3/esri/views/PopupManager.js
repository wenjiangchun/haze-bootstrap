// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require ../core/promiseUtils dojo/_base/array dojo/on dojo/Deferred dojo/promise/all ../layers/support/layerUtils ../geometry/support/scaleUtils ../geometry/Extent ../tasks/support/Query ../layers/GroupLayer ../core/Accessor".split(" "),function(H,w,l,D,y,I,E,F,J,K,G,L){var z;return L.createSubclass({declaredClass:"esri.views.PopupManager",properties:{map:{dependsOn:["view.map"],readOnly:!0}},constructor:function(){this._featureLayersCache={}},destroy:function(){this._featureLayersCache={};
this.view=null},_clickHandle:null,_featureLayersCache:null,enabled:!1,_enabledSetter:function(a){this._clickHandle&&(a?this._clickHandle.resume():this._clickHandle.pause());this._set("enabled",a)},_mapGetter:function(){return this.get("view.map")||null},view:null,_viewSetter:function(a){this._clickHandle&&(this._clickHandle.remove(),this._clickHandle=null);a&&(this._clickHandle=D.pausable(a,"click",this._clickHandler.bind(this)),this.enabled||this._clickHandle.pause());this._set("view",a)},getMapLayer:function(a){var c;
if(a&&(c=a.findLayerById())&&(a=c.id,this._featureLayersCache[a])){var b=a.lastIndexOf("_");-1<b&&(a=a.substring(0,b),c=this.map.findLayerById(a))}return c},_showPopup:function(a){function c(){r.clear();r.close()}function b(d){return m.allLayerViews.find(function(a){return a.layer===d})}function g(d){if(null==d)return!1;var a=b(d);return null==a?!1:d.loaded&&!a.suspended&&(d.popupEnabled&&d.popupTemplate||"graphics"===d.type||a.getPopupData)}function A(a){return(a=b(a))&&a.hasDraped}var m=this.view,
r=m.popup,x=this,p=[],k="3d"===m.type;l.forEach(this.map.layers.toArray(),function(a){a.isInstanceOf(G)?l.forEach(a.layers.toArray(),function(a){!g(a)||k&&!A(a)||p.push(a)}):!g(a)||k&&!A(a)||p.push(a)});0<m.graphics.length&&p.push(m.graphics);var e=null;a.graphic&&(a.graphic.popupTemplate||g(a.graphic.layer))&&(e=a.graphic);if(p.length||e){var h=[],t=!!e;if(e)e.layer&&"scene"===e.layer.type?h.unshift(this._fetchSceneAttributes(e.layer,[e])):e.getEffectivePopupTemplate()&&(q=new y,h.unshift(q.resolve([e])));
else{var q=x._calculateClickTolerance(p),e=a.mapPoint;if(!e){c();return}var v=1;m.state&&(v=m.state.resolution);(h=m.basemapTerrain)&&h.overlayManager&&(v=h.overlayManager.overlayPixelSizeInMapUnits(e));q*=v;h&&!h.spatialReference.equals(m.spatialReference)&&(q*=F.getUnitValueForSR(h.spatialReference)/F.getUnitValueForSR(m.spatialReference));var h=e.clone().offset(-q,-q),e=e.clone().offset(q,q),u=new J(Math.min(h.x,e.x),Math.min(h.y,e.y),Math.max(h.x,e.x),Math.max(h.y,e.y),m.spatialReference),h=p.map(function(d){var c;
if("imagery"===d.type){c=new K;c.geometry=a.mapPoint;var f=b(d),g={rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0};g.layerView=f;c=d.queryVisibleRasters(c,g).then(function(a){t=t||0<a.length;return a})}else if("csv"===d.type||!x._featureLayersCache[d.id]&&"function"!==typeof d.queryFeatures){if("map-image"===d.type)return f=b(d),f.getPopupData(u);var g=[],e;"esri.core.Collection\x3cesri.Graphic\x3e"===d.declaredClass?(f=d,e=!0):"graphics"===d.type?(f=d.graphics,e=!0):(f=(f=b(d))&&
f.loadedGraphics,e=!1);f&&(g=f.filter(function(a){return a&&(!e||a.popupTemplate)&&a.visible&&u.intersects(a.geometry)}).toArray());0<g.length&&(t=!0,c="scene"===d.type?x._fetchSceneAttributes(d,g):w.resolve(g))}else f=d.createQuery(),f.geometry=u,c=d.queryFeatures(f).then(function(a){a=a.features;t=t||0<a.length;return a});return c}).filter(function(a){return!!a}),n=function(a){return a.reduce(function(a,b){return a.concat(b.items?n(b.items):b)},[])},h=n(h)}l.some(h,function(a){return!a.isFulfilled()})||
t?h.length&&r.open({promises:h,location:a.mapPoint}):c()}else c()},_fetchSceneAttributes:function(a,c){return this.view.whenLayerView(a).then(function(b){var g=this._getOutFields(a.popupTemplate),l=c.map(function(a){return b.whenGraphicAttributes(a,g).otherwise(function(){return a})});return w.eachAlways(l)}.bind(this)).then(function(a){return a.map(function(a){return a.value})})},_getSubLayerFeatureLayers:function(a,c){var b=c||new y,g=[];c=a.length;var A=Math.floor(this.view.extent.width/this.view.width),
m=this.view.scale,r=!1,x=this,p=0;a:for(;p<c;p++){var k=a[p],e=k.dynamicLayerInfos||k.layerInfos;if(e){var h=null;k._params&&(k._params.layers||k._params.dynamicLayers)&&(h=k.visibleLayers);for(var h=E._getVisibleLayers(e,h),t=E._getLayersForScale(m,e),q=e.length,v=0;v<q;v++){var u=e[v],n=u.id,d=k.popupTemplates[n];if(!u.subLayerIds&&d&&d.popupTemplate&&-1<l.indexOf(h,n)&&-1<l.indexOf(t,n)){if(!z){r=!0;break a}var B=k.id+"_"+n,f=this._featureLayersCache[B];f&&f.loadError||(f||((f=d.layerUrl)||(f=
u.source?this._getLayerUrl(k.url,"/dynamicLayer"):this._getLayerUrl(k.url,n)),f=new z(f,{id:B,drawMode:!1,mode:z.MODE_SELECTION,outFields:this._getOutFields(d.popupTemplate),resourceInfo:d.resourceInfo,source:u.source}),this._featureLayersCache[B]=f),f.setDefinitionExpression(k.layerDefinitions&&k.layerDefinitions[n]),f.setGDBVersion(k.gdbVersion),f.popupTemplate=d.popupTemplate,f.setMaxAllowableOffset(A),f.setUseMapTime(!!k.useMapTime),k.layerDrawingOptions&&k.layerDrawingOptions[n]&&k.layerDrawingOptions[n].renderer&&
f.setRenderer(k.layerDrawingOptions[n].renderer),g.push(f))}}}}if(r){var w=new y;H(["../layers/FeatureLayer"],function(a){z=a;w.resolve()});w.then(function(){x._getSubLayerFeatureLayers(a,b)})}else{var C=[];l.forEach(g,function(a){if(!a.loaded){var b=new y;D.once(a,"load, error",function(){b.resolve()});C.push(b.promise)}});C.length?I(C).then(function(){g=l.filter(g,function(a){return!a.loadError&&a.isVisibleAtScale(m)});b.resolve(g)}):(g=l.filter(g,function(a){return a.isVisibleAtScale(m)}),b.resolve(g))}return b.promise},
_getLayerUrl:function(a,c){var b=a.indexOf("?");return-1===b?a+"/"+c:a.substring(0,b)+"/"+c+a.substring(b)},_getOutFields:function(a){var c;"esri.PopupTemplate"===a.declaredClass&&a.fieldInfos?(c=[],l.forEach(a.fieldInfos,function(a){var b=a.fieldName&&a.fieldName.toLowerCase();b&&"shape"!==b&&0!==b.indexOf("relationships/")&&c.push(a.fieldName)})):c=["*"];return c},_calculateClickTolerance:function(a){var c=6;l.forEach(a,function(a){if(a=a.renderer)"simple"===a.type?((a=a.symbol)&&a.xoffset&&(c=
Math.max(c,Math.abs(a.xoffset))),a&&a.yoffset&&(c=Math.max(c,Math.abs(a.yoffset)))):"uniqueValue"!==a.type&&"classBreaks"!==a.type||l.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(c=Math.max(c,Math.abs(a.xoffset)));a&&a.yoffset&&(c=Math.max(c,Math.abs(a.yoffset)))})});return c},_clickHandler:function(a){function c(a){return b.allLayerViews.find(function(c){return c.layer===a})}var b=this.view,g=a.screenPoint,l=this;if(0===a.button&&b.popup&&b.ready){var m="3d"===b.type,r=b.map.allLayers.some(function(a){if(a.isInstanceOf(G))return!1;
var b;null==a?b=!1:(b=c(a),b=null==b?!1:a.loaded&&!b.suspended&&(a.popupEnabled&&a.popupTemplate||"graphics"===a.type||b.getPopupData));b&&!(b=!m)&&(b=(a=c(a))&&a.hasDraped);return b?!0:!1});null!=g?this.view.hitTest(g.x,g.y).then(function(b){0<b.results.length?l._showPopup(b.results[0]):r&&l._showPopup(a)}):l._showPopup(a)}}})});