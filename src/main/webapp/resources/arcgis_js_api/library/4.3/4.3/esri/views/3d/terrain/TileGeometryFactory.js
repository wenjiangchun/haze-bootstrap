// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("../webgl-engine/lib/Geometry ../webgl-engine/lib/GeometryData ../lib/glMatrix ../support/earthUtils ../support/mathUtils ./TerrainConst".split(" "),function(ba,ca,da,ea,K,G){function P(c,f,g,k,d){c<k[0]&&(k[0]=c);c>d[0]&&(d[0]=c);f<k[1]&&(k[1]=f);f>d[1]&&(d[1]=f);g<k[2]&&(k[2]=g);g>d[2]&&(d[2]=g)}function R(c,f,g){for(var k=0;k<g.length;k++){var d=g[k];if(d){var b=d.safeWidth,x=d.width,t=d.pixelData,m=K.clamp(d.dy*(d.y1-f),0,b),d=K.clamp(d.dx*(c-d.x0),0,b),b=Math.floor(m),n=Math.floor(d),
A=b*x+n,a=A+x,y=t[A],x=t[a],A=t[A+1],t=t[a+1];if(y+x+A+t<.5*G.ELEVATION_NODATA_VALUE)return m-=b,d-=n,c=y+(A-y)*d,c+(x+(t-x)*d-c)*m}}return null}function S(c){N||65536<c*c+4*(c-1)&&(c=1<<Math.floor(K.log2(.5*(-4+Math.sqrt(262176)))));return c}var T=ea.earthRadius,H=da.vec3d,fa=K.lerp,N=!1,ga=function(){var c=H.create(),f=H.create(),g=H.create(),k,d,b;this.init=function(x,t){d=x;b=t;H.subtract(g,f,c);k=.5*H.length(c);H.lerp(f,g,.5,c)};this.getCenter=function(){return c};this.getBSRadius=function(){return k};
this.getBBMin=function(){return f};this.getBBMax=function(){return g};this.getPosition=function(){return d};this.getIndices=function(){return b};this.getPrimitiveIndices=function(){};this.getChildren=function(){}},U=function(c,f,g,k){c*=T;for(var d=0;d<=f;d++)g[5*k]=0,g[5*k+1]=0,g[5*k+2]=c,k++},Q=new function(){var c=Array(50),f=0,g={};this.get=function(d){var b=g[d];b||(b={ptr:0,data:Array(50)},g[d]=b);0<b.ptr?(k.vertexArrayHits++,d=b.data[--b.ptr],b.data[b.ptr]=null):(k.vertexArrayMisses++,d=new Float32Array(d));
if(0<f)return k.geometryHits++,b=c[--f],c[f]=null,b.getData().getVertexAttr().terrain.data=d,b;k.geometryMisses++;b={};b.terrain={size:5,data:d};d=new ga;return new ba(new ca([{type:"triangle",indices:{terrain:null},positionKey:"terrain"}],b),"tile",[d])};this.put=function(d){var b=d.getData(),k=b.getVertexAttr(),t=k.terrain.data,m=g[t.length];50>m.ptr&&(m.data[m.ptr++]=t);k.terrain.data=null;b.getFaces()[0].indices.terrain=null;50>f&&(c[f++]=d)};var k={geometryHits:0,geometryMisses:0,vertexArrayHits:0,
vertexArrayMisses:0};this.stats=k;this._pools={geometry:c,vertexArray:g}},V=[],W=Array(G.MAX_TILE_TESSELATION+1),X=Array(G.MAX_TILE_TESSELATION+1),Y=Array(G.MAX_TILE_TESSELATION+1),Z=Array(G.MAX_TILE_TESSELATION+1),ha={values:null,numSurfaceIndices:0,numSkirtIndices:0},O=function(c,f,g){g||(c.values=f.values);c.numSurfaceIndices=f.numSurfaceIndices;c.numSkirtIndices=f.numSkirtIndices;return c},aa=function(c,f,g,k,d){var b;b=ha;var x=g&2,t=f+(k?1024:0)+(x?2048:0),m=V[t];b||(b={});if(m)O(b,m);else{var m=
f-1,n=f-1,A=f*f,a=2*m+2*n,y=m*n*6,D=6*a,C=6*(2*m+n-1);k&&(y*=2,D*=2,C*=2);for(var a=N&&65536<A+a?new Uint32Array(y+D):new Uint16Array(y+D),r=0,l=0,h=y,p,w,q,v,z=0,u=0;u<=n;u++){x&&(z=0===u?C:u===n?-C:0);for(var h=h+z,e=0;e<=m;e++)v=w=-1,0===u&&(w=A+e,e!==m&&(v=r+1)),e===m&&(w=A+m+u,u<n&&(v=r+m+1)),u===n&&(w=A+m+n+(m-e),0<e&&(v=r-1)),0===e&&0<u&&(w=A+2*m+n+(n-u),v=r-(m+1)),-1<w&&(q=0===e&&1===u?A:w+1,-1<v&&(p=r,k?(a[h+0]=p,a[h+1]=w,a[h+2]=w,a[h+3]=q,a[h+4]=q,a[h+5]=p,a[h+6]=q,a[h+7]=v,a[h+8]=v,a[h+
9]=p,a[h+10]=p,a[h+11]=q,h+=12):(a[h+0]=p,a[h+1]=w,a[h+2]=q,a[h+3]=q,a[h+4]=v,a[h+5]=p,h+=6))),++r,e<m&&u<n&&(p=u*(m+1)+e,w=p+1,q=w+(m+1),v=q-1,k?(a[l+0]=p,a[l+1]=w,a[l+2]=w,a[l+3]=q,a[l+4]=q,a[l+5]=p,a[l+6]=q,a[l+7]=v,a[l+8]=v,a[l+9]=p,a[l+10]=p,a[l+11]=q,l+=12):(a[l+0]=p,a[l+1]=w,a[l+2]=q,a[l+3]=q,a[l+4]=v,a[l+5]=p,l+=6));h-=z}b.values=a;b.numSurfaceIndices=y;b.numSkirtIndices=D;V[t]=O({},b)}x=c.getData();t=x.getVertexAttr();x.getFaces()[0].indices.terrain=b.values;c.getBoundingInfo(0).init(t.terrain,
b.values);d||(d={});d.geometry=c;d.numWithoutSkirtIndices=b.numSurfaceIndices+(g?6*(f-1)*(k?2:1):0);d.numVertsPerRow=f;return O(d,b,!0)};return{createPlanarGlobeTile:function(c,f,g,k,d,b,x){var t=f[0],m=f[1],n=f[2]-t;f=f[3]-m;var A=.1*n;c=S(c);var a=c-1,y=c-1,D=c*c,C=Q.get(5*(D+(2*a+2*y))),r=C.getData().getVertexAttr().terrain.data,l,h,p=0;l=C.getBoundingInfo(0);var w=l.getBBMin(),q=l.getBBMax();H.set3(1E7,1E7,1E7,w);H.set3(-1E7,-1E7,-1E7,q);for(h=0;h<=y;h++){var v=h/y,z=m+v*f;b&&(z<b[1]?(z=b[1],
v=(z-m)/f):z>b[3]&&(z=b[3],v=(z-m)/f));for(l=0;l<=a;l++){var u=l/a,e=t+u*n;b&&(e<b[0]?(e=b[0],u=(e-t)/n):e>b[2]&&(e=b[2],u=(e-t)/n));var F=g?R(e,z,g)||0:0,e=e-k[0],I=z-k[1],F=F-k[2];P(e,I,F,w,q);r[5*p]=e;r[5*p+1]=I;r[5*p+2]=F;r[5*p+3]=u;r[5*p+4]=v;var E=-1;0===h&&(E=D+l);l===a&&(E=D+a+h);h===y&&(E=D+a+y+(a-l));0===l&&0<h&&(E=D+2*a+y+(y-h));-1<E&&(r[5*E]=e,r[5*E+1]=I,r[5*E+2]=F-A,r[5*E+3]=u,r[5*E+4]=v,P(e,I-A,F,w,q));++p}}return aa(C,c,0,d,x)},createSphericalGlobeTile:function(c,f,g,k,d,b,x,t,m){var n=
g[0],A=g[1],a=g[2],y=g[3],D=Math.max(.9,1-.5*(a-n));c=S(c);g=c-1;var C=c-1,r=c*c,l=Q.get(5*(r+(2*g+2*C))),h=l.getData().getVertexAttr().terrain.data,p=f[2]-f[0],w=f[3]-f[1],q=a-n,a=b[0],v=b[1];b=b[2];var z=l.getBoundingInfo(0),u=z.getBBMin(),z=z.getBBMax();H.set3(1E7,1E7,1E7,u);H.set3(-1E7,-1E7,-1E7,z);var e;for(e=0;e<=g;e++){var F=e/g,I=n+F*q;W[e]=Math.sin(I);X[e]=Math.cos(I);Y[e]=F;Z[e]=f[0]+F*p}for(n=p=0;n<=C;n++){q=n/C;e=fa(A,y,q);var I=Math.cos(e),E=Math.sin(e),G;k?(G=T/2*Math.log((1+E)/(1-E)),
q=(G-f[1])/w):G=180*e/Math.PI;for(e=0;e<=g;e++){var F=Y[e],L=W[e],M=X[e],J=T;d&&(J+=R(Z[e],G,d)||0);var M=M*I*J,L=L*I*J,J=E*J,K=M-a,N=L-v,O=J-b;P(K,N,O,u,z);var B=5*p;h[B+0]=K;h[B+1]=N;h[B+2]=O;h[B+3]=F;h[B+4]=q;B=-1;0===n&&(B=r+e);e===g&&(B=r+g+n);n===C&&(B=r+g+C+(g-e));0===e&&0<n&&(B=r+2*g+C+(C-n));-1<B&&(M=M*D-a,L=L*D-v,J=J*D-b,P(M,L,J,u,z),B*=5,h[B+0]=M,h[B+1]=L,h[B+2]=J,h[B+3]=F,h[B+4]=q);++p}}k&&(f=!!(x&2),x&1&&U(-1,g,h,r),f&&U(1,g,h,r+g+C));return aa(l,c,k?x:0,t,m)},releaseGeometry:Q.put,elevationSampler:R,
_geometryObjectPool:Q,supportedNumVertsPerRow:S,setSupportsUintIndices:function(c){N=c}}});