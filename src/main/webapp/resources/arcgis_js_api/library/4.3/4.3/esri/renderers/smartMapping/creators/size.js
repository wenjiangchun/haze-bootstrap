// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports dojo/i18n!../../nls/smartMapping dojo/_base/lang ../../../core/lang ../../ClassBreaksRenderer ../statistics/summaryStatistics ../symbology/size ../../support/utils ../../../core/promiseUtils ../../../views/SceneView ./support/utils ../support/utils".split(" "),function(H,r,y,p,z,A,B,q,t,f,u,e,m){function C(b){if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))return f.reject(e.createError("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));
var a=p.mixin({},b);a.basemap=e.getBasemapId(a.basemap);a.layer=m.createLayerAdapter(a.layer);return a.layer?!a.worldScale||a.view instanceof u?a.layer.load().then(function(){var b=a.layer.geometryType;if(a.worldScale&&"point"!==b&&"multipoint"!==b)return f.reject(e.createError("size-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers"));b=m.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression});return(b=
e.verifyBasicFieldValidity(a.layer,b,"size-visual-variable:invalid-parameters"))?f.reject(b):a}):f.reject(e.createError("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true")):f.reject(e.createError("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+v))}function D(b){if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))return f.reject(e.createError("size-continuous-renderer:missing-parameters",
"'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));var a=p.mixin({},b);a.basemap=e.getBasemapId(a.basemap);a.symbolType=a.symbolType||"2d";a.layer=m.createLayerAdapter(a.layer);return a.layer?-1<a.symbolType.indexOf("3d-volumetric")&&!(a.view instanceof u)?f.reject(e.createError("size-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric'")):a.layer.load().then(function(){var b=
a.layer.geometryType;if(-1<a.symbolType.indexOf("3d")&&"point"!==b&&"multipoint"!==b)return f.reject(e.createError("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers"));b=m.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression});return(b=e.verifyBasicFieldValidity(a.layer,b,"size-continuous-renderer:invalid-parameters"))?f.reject(b):a}):f.reject(e.createError("size-continuous-renderer:invalid-parameters",
"'layer' must be one of these types: "+v))}function E(b){b=p.mixin({},b);var a=-1<b.symbolType.indexOf("3d-volumetric");if(b.worldScale=a)b.axis="3d-volumetric-uniform"===b.symbolType?"all":"height";delete b.symbolType;delete b.defaultSymbolEnabled;return b}function F(b,a,f,c){var G=c.field,d=c.layer.geometryType,n=null==c.defaultSymbolEnabled?!0:c.defaultSymbolEnabled,k=q.cloneScheme(b.sizeScheme),l="polygon"===d,g=l?k.marker:k,h=l?k.background:null,k="polyline"===d?g.noDataWidth:g.noDataSize,h=
h?e.createSymbol(h,h.color,d,c.symbolType):null;return{renderer:new A({backgroundFillSymbol:h,classBreakInfos:[{minValue:-w,maxValue:w,symbol:e.createSymbol(g,g.color,l?"point":d,c.symbolType)}],defaultLabel:n?y.other:null,defaultSymbol:n?e.createSymbol(g,g.noDataColor,l?"point":d,c.symbolType,k):null,field:G,normalizationField:f,normalizationType:a,valueExpression:c.valueExpression,visualVariables:b.visualVariables.map(function(a){return t.cloneSizeVariable(a)}),authoringInfo:z.clone(b.authoringInfo)}),
visualVariables:b.visualVariables.map(function(a){return t.cloneSizeVariable(a)}),statistics:b.statistics,defaultValuesUsed:b.defaultValuesUsed,sizeScheme:q.cloneScheme(b.sizeScheme),basemapId:b.basemapId}}function x(b){return C(b).then(function(a){var b=a.normalizationField,c=b?"field":void 0;return(a.statistics?f.resolve(a.statistics):B({layer:a.layer,field:a.field,valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:c,normalizationField:b,minValue:a.minValue,
maxValue:a.maxValue})).then(function(c){var d=a.layer,n=a.field,k=n&&"function"!==typeof n?d.getField(n):null,k=k&&"date"===k.type,l=d.geometryType;d=(d=a.sizeScheme)?q.cloneScheme(d):(d=q.getSchemes({basemap:a.basemap,geometryType:l,worldScale:a.worldScale,view:a.view}))&&d.primaryScheme;if(d){var g,h;switch(l){case "point":case "multipoint":h=[d.minSize,d.maxSize];break;case "polyline":h=[d.minWidth,d.maxWidth];break;case "polygon":h=[d.marker.minSize,d.marker.maxSize]}g=h;h=(k=e.getDefaultDataRange(c,
k,!1))||[c.min,c.max];var l=[],m=g[0];g=g[1];var p=void 0;"height"===a.axis&&(l.push({type:"size",axis:"width-and-depth",minSize:((g-m)/2+m)/4.6}),p="height",g*=2);l.unshift({type:"size",field:n,valueExpression:a.valueExpression,valueUnit:"unknown",normalizationField:b,axis:p,minSize:m,maxSize:g,minDataValue:h[0],maxDataValue:h[1],legendOptions:a.legendOptions});c=f.resolve({basemapId:a.basemap,visualVariables:l,statistics:c,defaultValuesUsed:!!k,sizeScheme:q.cloneScheme(d),authoringInfo:{visualVariables:[{type:"size",
minSliderValue:c.min,maxSliderValue:c.max}]}})}else c=f.reject(e.createError("size-visual-variable:insufficient-info","Unable to find size scheme"));return c})})}var w=Math.pow(2,53)-1,v=m.supportedLayerTypes.join(", ");r.createVisualVariables=x;r.createContinuousRenderer=function(b){return D(b).then(function(a){return x(E(a)).then(function(b){var c=a.normalizationField;return F(b,c?"field":void 0,c,a)})})}});