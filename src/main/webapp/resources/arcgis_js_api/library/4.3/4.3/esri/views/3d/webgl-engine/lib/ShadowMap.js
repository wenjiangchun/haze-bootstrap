// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("./Camera ./Util ./gl-matrix ../../../../core/Logger ../../../webgl/Texture ../../../webgl/FramebufferObject ../../../webgl/VertexArrayObject ../../../webgl/BufferObject ./DefaultVertexAttributeLocations ./DefaultVertexBufferLayouts ../../../webgl/Util".split(" "),function(ta,m,u,aa,ga,ua,va,wa,xa,ya,ha){var b=u.vec2d,L=u.vec3d,ba=u.vec4d,za=u.mat3d,E=u.mat4d,I=u.mat4,Aa=aa.getLogger("esri.views.3d.webgl-engine");return function(u,h){function v(a,b){L.set3(a[b],a[b+3],a[b+6],ia);return ia}
var A=h.gl,w,M=4096,W,ca=new ga(h,{target:A.TEXTURE_2D,pixelFormat:A.RGBA,dataType:A.UNSIGNED_BYTE,samplingMode:A.NEAREST,width:4,height:4}),N=1,da=2,O=[0,0,0,0,0];this.dispose=function(){ca.dispose();ca=null};var c=function(){this.camera=new ta;this.lightMat=E.create()},Q=[],p,k,x;for(p=0;4>p;++p)Q[p]=new c;this.getIsSupported=function(){return h.extensions.standardDerivatives};this.setTextureResolution=function(a){M=a};this.getTextureResolution=function(){return M};this.setMaxNumCascades=function(a){da=
m.clamp(Math.floor(a),1,4)};this.getMaxNumCascades=function(){return da};this.setEnableState=function(a){a?this.enable():this.disable()};this.getEnableState=function(){return void 0!==w};this.getDepthTexture=function(){return w};this.enable=function(){this.getEnableState()||(this.getIsSupported()?(w=new ga(h,{target:A.TEXTURE_2D,pixelFormat:A.RGBA,dataType:A.UNSIGNED_BYTE,wrapMode:A.CLAMP_TO_EDGE,samplingMode:A.NEAREST,flipped:!0,width:M,height:M}),W=ua.createWithAttachments(h,w,{colorTarget:0,depthStencilTarget:1,
width:M,height:M})):Aa.warn("Shadow maps are not supported for this browser or hardware"))};this.disable=function(){this.getEnableState()&&W&&(W.dispose(),w=W=void 0)};var ja=E.create(),ka=E.create(),la=ba.create(),y=Array(8);for(p=0;8>p;++p)y[p]=ba.create();var J=L.create(),K=L.create(),ma=b.create(),na=b.create(),aa=b.create(),oa=b.create(),pa=b.create(),qa=E.create(),ra=L.create();this.prepare=function(z,S,T,c,t){m.assert(this.getEnableState());E.multiply(z.projectionMatrix,z.viewMatrix,ja);var d=
t[0],q=t[1];2>d&&(d=2);2>q&&(q=2);d>=q&&(d=2,q=4);N=Math.min(1+Math.floor(m.logWithBase(q/d,4)),da);T=Math.pow(q/d,1/N);for(t=0;t<N+1;++t)O[t]=d*Math.pow(T,t);E.inverse(ja,ka);E.lookAt([0,0,0],[-S[0],-S[1],-S[2]],[0,1,0],qa);T=z.viewMatrix;z=z.projectionMatrix;for(t=0;t<N;++t){c=Q[t];d=-O[t];q=-O[t+1];d=(z[10]*d+z[14])/Math.abs(z[11]*d+z[15]);q=(z[10]*q+z[14])/Math.abs(z[11]*q+z[15]);m.assert(d<q);for(k=0;8>k;++k)for(ba.set4(0===k%4||3==k%4?-1:1,0===k%4||1==k%4?-1:1,4>k?d:q,1,la),E.multiplyVec4(ka,
la,y[k]),x=0;3>x;++x)y[k][x]/=y[k][3];L.negate(y[0],ra);E.translate(qa,ra,c.camera.viewMatrix);for(k=0;8>k;++k)E.multiplyVec3(c.camera.viewMatrix,y[k]);L.set(y[0],J);L.set(y[0],K);for(k=1;8>k;++k)for(x=0;3>x;++x)J[x]=Math.min(J[x],y[k][x]),K[x]=Math.max(K[x],y[k][x]);J[2]-=200;K[2]+=200;c.camera.near=-K[2];c.camera.far=-J[2];d=1/y[0][3];q=1/y[4][3];m.assert(d<q);var g=d+Math.sqrt(d*q),l=Math.sin(Math.acos(T[2]*S[0]+T[6]*S[1]+T[10]*S[2])),g=g/l,d=y,u=g,p=l,l=ma,B=na,f=aa,F=oa,g=pa;b.set2(0,0,D);for(var e=
void 0,e=0;4>e;++e)b.add(D,d[e],D);b.scale(D,.25);b.set2(0,0,X);for(e=4;8>e;++e)b.add(X,d[e],X);b.scale(X,.25);b.lerp(d[4],d[5],.5,R[0]);b.lerp(d[5],d[6],.5,R[1]);b.lerp(d[6],d[7],.5,R[2]);b.lerp(d[7],d[4],.5,R[3]);for(var n=0,G=b.dist2(R[0],D),e=1;4>e;++e){var w=b.dist2(R[e],D);w<G&&(G=w,n=e)}b.subtract(R[n],d[n+4],r);e=r[0];r[0]=-r[1];r[1]=e;b.subtract(X,D,sa);b.lerp(r,sa,p);b.normalize(r);n=p=void 0;p=n=b.dot(b.subtract(d[0],D,P),r);for(e=1;8>e;++e)G=b.dot(b.subtract(d[e],D,P),r),G<p?p=G:G>n&&
(n=G);b.set(D,l);b.scale(r,p-u,P);b.add(l,P,l);for(var w=-1,I=1,e=u=G=0;8>e;++e){b.subtract(d[e],l,Y);b.normalize(Y);var H=r[0]*Y[1]-r[1]*Y[0];0<H?H>w&&(w=H,G=e):H<I&&(I=H,u=e)}m.verify(0<w,"leftArea");m.verify(0>I,"rightArea");b.scale(r,p,U);b.add(U,D,U);b.scale(r,n,V);b.add(V,D,V);Z[0]=-r[1];Z[1]=r[0];B=m.rayRay2D(l,d[u],V,b.add(V,Z,P),1,B);f=m.rayRay2D(l,d[G],V,P,1,f);F=m.rayRay2D(l,d[G],U,b.add(U,Z,P),1,F);d=m.rayRay2D(l,d[u],U,P,1,g);m.verify(B,"rayRay");m.verify(f,"rayRay");m.verify(F,"rayRay");
m.verify(d,"rayRay");f=ma;d=na;l=oa;F=pa;g=c.camera.projectionMatrix;b.scale(b.subtract(l,F,C),.5);a[0]=C[0];a[1]=C[1];a[2]=0;a[3]=C[1];a[4]=-C[0];a[5]=0;a[6]=C[0]*C[0]+C[1]*C[1];a[7]=C[0]*C[1]-C[1]*C[0];a[8]=1;a[6]=-b.dot(v(a,0),f);a[7]=-b.dot(v(a,1),f);f=b.dot(v(a,0),l)+a[6];B=b.dot(v(a,1),l)+a[7];e=b.dot(v(a,0),F)+a[6];F=b.dot(v(a,1),F)+a[7];f=-(f+e)/(B+F);a[0]+=a[1]*f;a[3]+=a[4]*f;a[6]+=a[7]*f;f=1/(b.dot(v(a,0),l)+a[6]);B=1/(b.dot(v(a,1),l)+a[7]);a[0]*=f;a[3]*=f;a[6]*=f;a[1]*=B;a[4]*=B;a[7]*=
B;a[2]=a[1];a[5]=a[4];a[8]=a[7];a[7]+=1;f=b.dot(v(a,1),d)+a[7];B=b.dot(v(a,2),d)+a[8];e=b.dot(v(a,1),l)+a[7];F=b.dot(v(a,2),l)+a[8];f=-.5*(f/B+e/F);a[1]+=a[2]*f;a[4]+=a[5]*f;a[7]+=a[8]*f;f=b.dot(v(a,1),d)+a[7];B=b.dot(v(a,2),d)+a[8];e=-B/f;a[1]*=e;a[4]*=e;a[7]*=e;g[0]=a[0];g[1]=a[1];g[2]=0;g[3]=a[2];g[4]=a[3];g[5]=a[4];g[6]=0;g[7]=a[5];g[8]=0;g[9]=0;g[10]=1;g[11]=0;g[12]=a[6];g[13]=a[7];g[14]=0;g[15]=a[8];c.camera.projectionMatrix[10]=2/(J[2]-K[2]);c.camera.projectionMatrix[14]=-(J[2]+K[2])/(J[2]-
K[2]);E.multiply(c.camera.projectionMatrix,c.camera.viewMatrix,c.lightMat);d=M/2;c.camera.viewport[0]=0===t%2?0:d;c.camera.viewport[1]=0===Math.floor(t/2)?0:d;c.camera.viewport[2]=d;c.camera.viewport[3]=d}O[N]=100*q;h.bindFramebuffer(W);h.bindTexture(null,7);h.setClearColor(1,1,1,1);h.clear(A.COLOR_BUFFER_BIT|A.DEPTH_BUFFER_BIT);h.setBlendingEnabled(!1)};var ea=[];this.getCascades=function(){for(var a=0;a<N;++a)ea[a]=Q[a];ea.length=N;return ea};this.finish=function(a){m.assert(this.getEnableState());
h.bindFramebuffer(a)};this.bind=function(a){var b=this.getEnableState();h.bindTexture(b?w:ca,7);h.bindProgram(a);a.setUniform1i("depthTex",7);a.setUniform1f("depthHalfPixelSz",b?.5/M:-1);a.setUniform1i("shadowMapNum",N);a.setUniform4f("shadowMapDistance",O[0],O[1],O[2],O[3])};this.bindAll=function(a){a=a.getProgramsUsingUniform("shadowMapDistance");for(var b=0;b<a.length;b++)this.bind(a[b])};var n=I.create(),H=new Float32Array(64);this.bindView=function(a,b){if(this.getEnableState()){var c;I.translate(Q[0].lightMat,
b,n);for(c=0;16>c;++c)H[c]=n[c];I.translate(Q[1].lightMat,b,n);for(c=0;16>c;++c)H[16+c]=n[c];I.translate(Q[2].lightMat,b,n);for(c=0;16>c;++c)H[32+c]=n[c];I.translate(Q[3].lightMat,b,n);for(c=0;16>c;++c)H[48+c]=n[c];a.setUniformMatrix4fv("shadowMapMatrix",H)}};c=new Float32Array(16);c[0]=0;c[1]=0;c[2]=0;c[3]=0;c[4]=256;c[5]=0;c[6]=1;c[7]=0;c[8]=0;c[9]=256;c[10]=0;c[11]=1;c[12]=256;c[13]=256;c[14]=1;c[15]=1;var fa=new va(h,xa.Default3D,{geometry:ya.Pos2Tex},{geometry:wa.createVertex(h,A.STATIC_DRAW,
c)});this.drawDebugQuad=function(a){m.assert(this.getEnableState());var b=u.get("showDepth");h.setDepthTestEnabled(!1);h.bindProgram(b);b.setUniformMatrix4fv("proj",a);b.setUniform1i("depthTex",0);h.bindTexture(w,0);h.bindVAO(fa);ha.assertCompatibleVertexAttributeLocations(fa,b);h.drawArrays(A.TRIANGLE_STRIP,0,ha.vertexCount(fa,"geometry"));h.setDepthTestEnabled(!0)};var D=b.create(),X=b.create(),R=[b.create(),b.create(),b.create(),b.create()],r=b.create(),sa=b.create(),P=b.create(),Y=b.create(),
U=b.create(),V=b.create(),Z=b.create(),ia=L.create(),C=b.create(),a=za.create()}});