// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("../../../../core/declare ../../../../core/screenUtils ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./Graphics3DDrapedGraphicLayer ./ElevationAligners ./Graphics3DSymbolCommonCode ./lineUtils ./graphicUtils ../../../../geometry/Polygon ../../../../Color ../../lib/glMatrix ../../support/aaBoundingBox ../../webgl-engine/Stage ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/ColorMaterial ../../webgl-engine/lib/Util ./earcut/earcut".split(" "),
function(v,E,F,G,H,w,l,q,I,J,K,y,r,t,L,z,M,A,N,x,B){var u=x.VertexAttrConstants;x=y.vec3d;var p=y.mat4d;v=v([F],{_prepareResources:function(){this._prepareFillResources();this._prepareOutlineResources();this.resolve()},_prepareFillResources:function(){var a=this._getStageIdHint(),b=this._getMaterialOpacityAndColor(),b={color:b,transparent:1>b[3]||this._isPropertyDriven("opacity"),polygonOffset:!1,vertexColors:!0};this._material=new N(b,a+"_colormat");this._context.stage.add(t.ModelContentType.MATERIAL,
this._material)},_prepareOutlineResources:function(){var a=this.symbol.outline;if(this._hasOutline=!!(a&&a.size&&a.color))a={idHint:this._getStageIdHint()+"_outline",color:this._getOutlineColor(),width:E.pt2px(this.symbol.outline.size)},2<a.width?(this._outlineMaterial=q.createRibbonMaterial(a),this._isOutlineNativeLineMaterial=!1):(this._outlineMaterial=q.createNativeMaterial(a),this._isOutlineNativeLineMaterial=!0),this._context.stage.add(t.ModelContentType.MATERIAL,this._outlineMaterial)},destroy:function(){this.isFulfilled()||
this.reject();this._material&&(this._context.stage.remove(t.ModelContentType.MATERIAL,this._material.getId()),this._material=null);this._outlineMaterial&&(this._context.stage.remove(t.ModelContentType.MATERIAL,this._outlineMaterial.getId()),this._outlineMaterial=null)},createGraphics3DGraphic:function(a,b){var k=a.geometry;if("polyline"!==k.type&&"polygon"!==k.type&&"extent"!==k.type)return this._logWarning("unsupported geometry type for fill symbol: "+k.type),null;k="graphic"+a.uid;b=this._getVertexOpacityAndColor(b,
Uint8Array,255);var h=this._getGraphicElevationInfo(a);return h.mode===l.ELEV_MODES.ON_THE_GROUND?this._createAsOverlay(a,b,h,k):this._createAs3DShape(a,b,h,k,a.uid)},layerPropertyChanged:function(a,b,k){if("opacity"===a)return b=this._material.getColor(),b[3]=this._getMaterialOpacity(),this._material.setColor(b),this._material.setTransparent(1>b[3]),this._outlineMaterial&&(this._isOutlineNativeLineMaterial?(b=this._outlineMaterial.getColor(),b[3]=this._getOutlineOpacity(),this._outlineMaterial.setColor(b)):
(b=this._outlineMaterial.getParameterValues(),b.color[3]=this._getOutlineOpacity(),this._outlineMaterial.setParameterValues({color:b.color}))),!0;if("elevationInfo"===a){a=this._elevationInfo.mode;this._updateElevationInfo();var h=this._elevationInfo.mode;if(null==a||null==h)return!1;var d=l.ELEV_MODES;if(a===d.ON_THE_GROUND&&h===d.ON_THE_GROUND)return!0;if(a!==h&&(a===d.ON_THE_GROUND||h===d.ON_THE_GROUND))return!1;a=h===d.RELATIVE_TO_GROUND?w.perVertexElevationAligner:null;var h=this._context.elevationProvider,
d=this._context.renderCoordsHelper,c;for(c in b){var f=b[c],g=f._graphics[k];g&&(f=f.graphic,g.elevationAligner=a,g.elevationInfo.set(this._getGraphicElevationInfo(f)),w.perVertexElevationAligner(g,h,d))}return!0}return!1},setDrawOrder:function(a,b,k){this._material&&(this._material.setRenderPriority(a+b/2),k[this._material.getId()]=!0);this._outlineMaterial&&(this._outlineMaterial.setRenderPriority(a),k[this._outlineMaterial.getId()]=!0)},_createAs3DShape:function(a,b,k,h,d){var c=this._getPolyGeometry(a),
f=c.hasZ;a=!1;var g;null!=c.rings?(a=!0,g=c.rings):g=c.paths;if(0===g.length)return this._logWarning("no paths found for line symbol"),null;g=this._getOutlineGeometry(c,g);c=l.getGeometryVertexData3D(g,f,c.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,k);e.idHint=h;e.color=b;e.isRings=a;e.data=c;var C;this._hasOutline&&(C=new c.vertexData.constructor(c.vertexData));e.outNum=0;e.outGeometries=[];e.outTransforms=[];e.outMaterials=[];this._createAs3DShapeFill(e);
e.data.vertexData=C;this._createAs3DShapeOutline(e);if(0===e.outNum)return null;b=new L({geometries:e.outGeometries,materials:e.outMaterials,transformations:e.outTransforms,castShadow:!1,metadata:{layerId:this._context.layer.id,graphicId:d},idHint:h});h=null;k.mode===l.ELEV_MODES.RELATIVE_TO_GROUND&&(h=w.perVertexElevationAligner);k=new G(this,b,e.outGeometries,null,null,h,k);k.alignedTerrainElevation=c.terrainElevation;return k},_createAs3DShapeFill:function(a){for(var b=a.data.geometryData.polygons,
k=a.data.eleVertexData,h=a.data.vertexData,d=0;d<b.length;++d){var c=b[d],f=c.count,g=c.index;if(this._context.clippingExtent&&(l.computeBoundingBox(k,g,f,m),l.boundingBoxClipped(m,this._context.clippingExtent)))continue;var e=new Float64Array(k.buffer,3*g*k.BYTES_PER_ELEMENT,3*f),q=new Float64Array(h.buffer,3*g*h.BYTES_PER_ELEMENT,3*f),c=c.holeIndices.map(function(a){return a-g}),c=B(e,c,3);0!==c.length&&(l.chooseOrigin(h,g,f,n),l.subtractCoordinates(h,g,f,n),f=this._createFillGeometry(c,0,q,e,a.color,
!1),f=new z(f,a.idHint),f.singleUse=!0,e=p.identity(),p.translate(e,n,e),a.outGeometries.push(f),a.outMaterials.push([this._material]),a.outTransforms.push(e),a.outNum++)}},_createAs3DShapeOutline:function(a){if(this._hasOutline)for(var b=a.data.geometryData.outlines,k=a.data.eleVertexData,h=a.data.vertexData,d=0;d<b.length;++d){var c=b[d],f=c.index,g=c.count;if(this._context.clippingExtent&&(l.computeBoundingBox(k,f,g,m),l.boundingBoxClipped(m,this._context.clippingExtent)))continue;l.chooseOrigin(h,
f,g,n);l.subtractCoordinates(h,f,g,n);c=new Float64Array(k.buffer,3*f*k.BYTES_PER_ELEMENT,3*g);f=new Float64Array(h.buffer,3*f*h.BYTES_PER_ELEMENT,3*g);f=q.createPolylineGeometry(f,c,a.isRings,D,0);f=new z(f,a.idHint+"outline"+d);f.singleUse=!0;c=p.identity();p.translate(c,n,c);a.outGeometries.push(f);a.outMaterials.push([this._outlineMaterial]);a.outTransforms.push(c);a.outNum++}},_createAsOverlay:function(a,b,k,h){var d=this._getPolyGeometry(a);a=!1;var c;null!=d.rings?(a=!0,c=d.rings):c=d.paths;
c=this._getOutlineGeometry(d,c);if(0===c.length)return null;this._material.setRenderPriority(this._symbolLayerOrder+this._symbolLayerOrderDelta/2);this._hasOutline&&this._outlineMaterial.setRenderPriority(this._symbolLayerOrder);d=l.getGeometryVertexDataDraped(c,d.spatialReference,this._context.overlaySR);e.idHint=h;e.color=b;e.isRings=a;e.data=d;var f;this._hasOutline&&(f=new d.vertexData.constructor(d.vertexData));e.outNum=0;e.outGeometries=[];e.outBoundingBox=r.create(r.NEGATIVE_INFINITY);this._createAsOverlayFill(e);
e.data.vertexData=f;this._createAsOverlayOutline(e);return 0<e.outNum?new H(this,e.outGeometries,null,null,e.outBoundingBox,k):null},_createAsOverlayFill:function(a){for(var b=a.data.vertexData,k=a.data.geometryData.polygons,h=0;h<k.length;++h){var d=k[h],c=d.count,f=d.index,g=new Float64Array(b.buffer,3*f*b.BYTES_PER_ELEMENT,3*c),d=d.holeIndices.map(function(a){return a-f}),g=B(g,d,3);if(0!==g.length&&(l.computeBoundingBox(b,f,c,m),!l.boundingBoxClipped(m,this._context.clippingExtent))){r.expand(a.outBoundingBox,
m);l.chooseOrigin(b,f,c,n);l.subtractCoordinates(b,f,c,n);l.setZ(b,f,c,this._getDrapedZ());c=p.identity();p.translate(c,n,c);g=this._createFillGeometry(g,f,b,null,a.color);d=new A(g);d.material=this._material;var e=m;d.center=[.5*(e[0]+e[3]),.5*(e[1]+e[4]),0];d.bsRadius=.5*Math.sqrt((e[3]-e[0])*(e[3]-e[0])+(e[4]-e[1])*(e[4]-e[1]));d.transformation=c;d.name=a.idHint;d.uniqueName=a.idHint+"#"+g.id;a.outGeometries.push(d);a.outNum++}}},_createAsOverlayOutline:function(a){if(this._hasOutline)for(var b=
a.data.vertexData,e=a.data.geometryData.outlines,h=0;h<e.length;++h){var d=e[h],c=d.index,d=d.count;l.computeBoundingBox(b,c,d,m);if(!l.boundingBoxClipped(m,this._context.clippingExtent)){r.expand(a.outBoundingBox,m);l.chooseOrigin(b,c,d,n);l.subtractCoordinates(b,c,d,n);l.setZ(b,c,d,this._getDrapedZ());d=new Float64Array(b.buffer,3*c*b.BYTES_PER_ELEMENT,3*d);c=p.identity();p.translate(c,n,c);var d=q.createPolylineGeometry(d,null,a.isRings,D,0),f=new A(d);f.material=this._outlineMaterial;var g=m;
f.center=[.5*(g[0]+g[3]),.5*(g[1]+g[4]),0];f.bsRadius=.5*Math.sqrt((g[3]-g[0])*(g[3]-g[0])+(g[4]-g[1])*(g[4]-g[1]));f.transformation=c;f.name=a.idHint+"outline";f.uniqueName=a.idHint+"outline#"+d.id;a.outGeometries.push(f);a.outNum++}}},_getOutlineGeometry:function(a,b){return a._outlineSegments?q.createOutlineGeometryFromSegments(b,a._outlineSegments):b},_getOutlineOpacity:function(){return this._getLayerOpacity()*this.symbol.outline.color.a},_getOutlineColor:function(){var a=this.symbol.outline.color,
b=this._getOutlineOpacity();return I.mixinColorAndOpacity(K.toUnitRGB(a),b)},_getPolyGeometry:function(a){a=a.geometry;"extent"===a.type&&(a=J.fromExtent(a));return a},_createFillGeometry:function(a,b,e,h,d){for(var c=a.length,f=new Uint32Array(c),g=new Uint32Array(c),k=0;k<c;k++)f[k]=a[k]+b,g[k]=0;a={};b={};a[u.POSITION]=f;a[u.COLOR]=g;b[u.POSITION]={size:3,data:e};b[u.COLOR]={size:4,data:d};h&&(b.mapPos={size:3,data:h},a.mapPos=f);return new M(b,a)}});var m=r.create(),n=x.create(),D=new Float32Array([255,
255,255,255]),e={idHint:null,color:null,isRings:!1,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};return v});