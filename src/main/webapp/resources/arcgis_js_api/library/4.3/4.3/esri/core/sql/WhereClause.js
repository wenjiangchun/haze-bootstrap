// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ./WhereGrammar dojo/Deferred dojo/promise/all ../../moment ../../geometry/geometryEngineAsync".split(" "),function(C,D,y,l,w,r,t){function k(g){return!0===g?!0:!1}function u(g){return null!==g?!0!==g:null}function x(g,a){if(null==g)return null;for(var b=!1,c=0;c<a.length;c++){var d=a[c];if(null==d)b=null;else if(g===d){b=!0;break}}return b}function v(g,a,b){if(null==g)return null;for(var c="",d=0,e=0;e<a.length;e++){var f=a.charAt(e);switch(d){case 0:f===b?d=1:c=0<="-[]/{}()*+?.\\^$|".indexOf(f)?
c+("\\"+f):"%"===f?c+".*":"_"===f?c+".":c+f;break;case 1:c=0<="-[]/{}()*+?.\\^$|".indexOf(f)?c+("\\"+f):c+f,d=0}}return(new RegExp("^"+c+"$")).test(g)}function h(f){return f instanceof Date?f.valueOf():f}function z(f,a,b){if(null==a||null==b)return null;a=h(a);b=h(b);switch(f){case "\x3c\x3e":return a!==b;case "\x3d":return a===b;case "\x3e":return a>b;case "\x3c":return a<b;case "\x3e\x3d":return a>=b;case "\x3c\x3d":return a<=b}}var f;(function(f){(function(a){a[a.Standardised=0]="Standardised";
a[a.SqlServer=1]="SqlServer";a[a.Oracle=2]="Oracle";a[a.Postgres=3]="Postgres";a[a.PGDB=4]="PGDB";a[a.FILEGDB=5]="FILEGDB";a[a.NotEvaluated=6]="NotEvaluated"})(f.FeatureServiceDatabaseType||(f.FeatureServiceDatabaseType={}));f.errback=function(a){return function(b){a.reject(b)}};f.callback=function(a,b){return function(){for(var c=[],d=0;d<arguments.length;d++)c[d]=arguments[d];try{a.apply(null,c)}catch(e){b.reject(e)}}};f.convertSquareUnitsToCode=function(a){if(void 0===a)return null;if("number"===
typeof a)return a;switch(a.toLowerCase()){case "meters":case "meter":return 109404;case "miles":case "mile":return 109413;case "kilometers":case "kilometer":case "km":return 109414}return null};f.convertLinearUnitsToCode=function(a){if(void 0===a)return null;if("number"===typeof a||"number"===typeof a)return a;switch(a.toLowerCase()){case "meters":case "meter":return 9001;case "miles":case "mile":return 9035;case "kilometers":case "kilometer":case "km":return 9036}return null}})(f||(f={}));var A=
"extract abs ceiling floor log log10 power round truncate char_length concat lower substring upper".split(" ");return function(){function g(){this.child2=this.child1=this.parameters=this.parseTree=null}g.create=function(a){var b=new g;try{b.parseTree=y.parse(a)}catch(c){throw Error("Invalid Expression: "+a);}return b};g.assemble=function(a,b){var c=new g;c.child1=a;c.child2=b;return c};g.prototype.isStandardized=function(){return this.getFunctions().every(function(a){return 0<=A.indexOf(a.toLowerCase())})};
g.prototype.findVariables=function(){var a=[];this.findAllVariables(this.parseTree,a);return this.dedup(a)};g.prototype.setVariablesDictionary=function(a){this.parameters=a};g.prototype.toWhereClause=function(a){return null!==this.child1?"(("+this.child1.toWhereClause(a)+") AND ("+this.child2.toWhereClause(a)+"))":this.evaluateNodeToWhereClause(this.parseTree,a)};g.prototype.reformulateWithoutField=function(a,b){return g.create(this._reformulateInner(a,b))};g.prototype._reformulateInner=function(a,
b){return null!==this.child1?"(("+this.child1._reformulateInner(a,b)+") AND ("+this.child2._reformulateInner(a,b)+"))":this.evaluateNodeToWhereClause(this.parseTree,f.FeatureServiceDatabaseType.Standardised,a,b)};g.prototype.statisticFunction=function(){if(null===this.child1&&"call-function"===this.parseTree.type){if(0===this.parseTree.parameters.length)return{name:this.parseTree.name,expr:null};if(1<this.parseTree.parameters.length)throw Error("Statistic does not have 1 or 0 Parameters");var a=new g;
a.parseTree=this.parseTree.parameters[0];return{name:this.parseTree.name,expr:a}}return null};g.prototype.testFeature=function(a){return null!==this.child1?this.child1.testFeature(a)&&this.child2.testFeature(a):this.evaluateNode(this.parseTree,a)};g.prototype.testFeatureDeferred=function(a){var b=this,c=new l;null!==this.child1?this.child1.testFeatureDeferred(a).then(f.callback(function(d){!1===d?c.resolve(!1):b.child2.testFeatureDeferred(a).then(f.callback(function(a){c.resolve(a)},c),f.errback(c))},
c),f.errback(c)):this.evaluateNodeDeferred(this.parseTree,a).then(f.callback(function(a){c.resolve(a)},c),f.errback(c));return c.promise};g.prototype.calculateValue=function(a){return null!==this.child1?this.child1.calculateValue(a)&&this.child2.calculateValue(a):this.evaluateNode(this.parseTree,a)};g.prototype.calculateValueDeferred=function(a){var b=this,c=new l;null!==this.child1?this.child1.calculateValueDeferred(a).then(f.callback(function(d){!1===d?c.resolve(!1):b.child2.calculateValueDeferred(a).then(f.callback(function(a){c.resolve(a)},
c),f.errback(c))},c),f.errback(c)):this.evaluateNodeDeferred(this.parseTree,a).then(f.callback(function(a){c.resolve(a)},c),f.errback(c));return c.promise};g.prototype.scanForField=function(a){return null!==this.child1?this.child1.scanForField(a)||this.child2.scanForField(a):this.findField(this.parseTree,a)};g.prototype.getFunctions=function(){var a=[],a=null!==this.child1?this.child1.getFunctions().concat(this.child2.getFunctions()):this.findFunctions(this.parseTree);return this.dedup(a)};g.prototype.getFields=
function(){var a=[],a=null!==this.child1?this.child1.getFields().concat(this.child2.getFields()):this.findFields(this.parseTree);return this.dedup(a)};g.prototype.dedup=function(a){for(var b=[],c={},d=0;d<a.length;d++){var e=a[d],f=e.toLowerCase();void 0===c[f]&&(b.push(e),c[f]=1)}return b};g.prototype.featureValue=function(a,b,c){var d=a.attributes[b];if(void 0!==d)return d;for(var e in a.attributes)if(b.toLowerCase()===e.toLowerCase())return c.value=e,a.attributes[e];return null};g.prototype.isSingleField=
function(){return"FieldLiteral"===this.parseTree.type?!0:!1};g.prototype.findField=function(a,b){if(null===a||void 0===a)return!1;switch(a.type){case "when_clause":return this.findField(a.operand,b)||this.findField(a.value,b);case "case_expression":for(var c=0,d=a.clauses;c<d.length;c++){var e=d[c];if(this.findField(e,b))return!0}if("simple"===a.format&&this.findField(a.operand,b)||null!==a.else&&this.findField(a.else,b))return!0;break;case "expr_list":c=0;for(a=a.value;c<a.length;c++)if(e=a[c],this.findField(e,
b))return!0;break;case "unary_expr":return this.findField(a.expr,b);case "binary_expr":return this.findField(a.left,b)||this.findField(a.right,b);case "column_ref":return b.toLowerCase()===a.column.toLowerCase();case "function":return this.findField(a.args,b)}return!1};g.prototype.findFunctions=function(a){if(null===a||void 0===a)return[];switch(a.type){case "when_clause":return this.findFunctions(a.operand).concat(this.findFunctions(a.value));case "case_expression":for(var b=[],c=0,d=a.clauses;c<
d.length;c++)var e=d[c],b=b.concat(this.findFunctions(e));"simple"===a.format&&(b=b.concat(this.findFunctions(a.operand)));null!==a.else&&(b=b.concat(this.findFunctions(a.else)));return b;case "expr_list":b=[];c=0;for(a=a.value;c<a.length;c++)e=a[c],b=b.concat(this.findFunctions(e));return b;case "unary_expr":return this.findFunctions(a.expr);case "binary_expr":return this.findFunctions(a.left).concat(this.findFunctions(a.right));case "function":return this.findFunctions(a.args).concat([a.name.toLowerCase().trim()])}return[]};
g.prototype.findFields=function(a){var b=[];if(null===a||void 0===a)return b;switch(a.type){case "when_clause":return this.findFields(a.operand).concat(this.findFields(a.value));case "case_expression":for(var c=0,d=a.clauses;c<d.length;c++)var e=d[c],b=b.concat(this.findFields(e));"simple"===a.format&&(b=b.concat(this.findFields(a.operand)));null!==a.else&&(b=b.concat(this.findFields(a.else)));return b;case "expr_list":c=0;for(a=a.value;c<a.length;c++)e=a[c],b=b.concat(this.findFields(e));return b;
case "unary_expr":return this.findFields(a.expr);case "binary_expr":return this.findFields(a.left).concat(this.findFields(a.right));case "column_ref":return[a.column];case "function":return this.findFields(a.args)}return[]};g.prototype.findAllVariables=function(a,b){if(null!==a&&void 0!==a)switch(a.type){case "when_clause":this.findAllVariables(a.operand,b);this.findAllVariables(a.value,b);break;case "case_expression":for(var c=0,d=a.clauses;c<d.length;c++){var e=d[c];this.findAllVariables(e,b)}"simple"===
a.format&&this.findAllVariables(a.operand,b);null!==a.else&&this.findAllVariables(a.else,b);break;case "param":b.push(a.value.toLowerCase());case "expr_list":c=0;for(a=a.value;c<a.length;c++)e=a[c],this.findAllVariables(e,b);break;case "unary_expr":this.findAllVariables(a.expr,b);case "binary_expr":this.findAllVariables(a.left,b);this.findAllVariables(a.right,b);break;case "function":this.findAllVariables(a.args,b)}};g.prototype.evaluateNode=function(a,b){var c;switch(a.type){case "case_expression":if("simple"===
a.format)for(var d=h(this.evaluateNode(a.operand,b)),e=0;e<a.clauses.length;e++){if(c=d===h(this.evaluateNode(a.clauses[e].operand,b)))return this.evaluateNode(a.clauses[e].value,b)}else for(e=0;e<a.clauses.length;e++)if(c=k(this.evaluateNode(a.clauses[e].operand,b)))return this.evaluateNode(a.clauses[e].value,b);return null!==a.else?this.evaluateNode(a.else,b):null;case "param":return this.parameters[a.value.toLowerCase()];case "expr_list":c=[];d=0;for(a=a.value;d<a.length;d++)e=a[d],c.push(this.evaluateNode(e,
b));return c;case "unary_expr":return u(this.evaluateNode(a.expr,b));case "binary_expr":switch(a.operator){case "AND":return c=this.evaluateNode(a.left,b),b=this.evaluateNode(a.right,b),null!=c&&null!=b?!0===c&&!0===b:!1===c||!1===b?!1:null;case "OR":return c=this.evaluateNode(a.left,b),b=this.evaluateNode(a.right,b),null!=c&&null!=b?!0===c||!0===b:!0===c||!0===b?!0:null;case "IS":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return null===this.evaluateNode(a.left,b);case "ISNOT":if("null"!==
a.right.type)throw Error("Unsupported RHS for IS");return null!==this.evaluateNode(a.left,b);case "IN":return c=[],"expr_list"===a.right.type?c=this.evaluateNode(a.right,b):(c=this.evaluateNode(a.right,b),c instanceof Array||(c=[c])),x(this.evaluateNode(a.left,b),c);case "NOT IN":return c=[],"expr_list"===a.right.type?c=this.evaluateNode(a.right,b):(c=[this.evaluateNode(a.right,b)],c instanceof Array||(c=[c])),u(x(this.evaluateNode(a.left,b),c));case "BETWEEN":return c=this.evaluateNode(a.left,b),
b=this.evaluateNode(a.right,b),null==c||null==b[0]||null==b[1]?null:c>=b[0]&&c<=b[1];case "NOTBETWEEN":return c=this.evaluateNode(a.left,b),b=this.evaluateNode(a.right,b),null==c||null==b[0]||null==b[1]?null:c<b[0]||c>b[1];case "LIKE":return v(this.evaluateNode(a.left,b),this.evaluateNode(a.right,b),a.escape);case "NOT LIKE":return u(v(this.evaluateNode(a.left,b),this.evaluateNode(a.right,b),a.escape));case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return z(a.operator,
this.evaluateNode(a.left,b),this.evaluateNode(a.right,b));case "*":return this.evaluateNode(a.left,b)*this.evaluateNode(a.right,b);case "-":return this.evaluateNode(a.left,b)-this.evaluateNode(a.right,b);case "+":return this.evaluateNode(a.left,b)+this.evaluateNode(a.right,b);case "/":return this.evaluateNode(a.left,b)/this.evaluateNode(a.right,b)}throw Error("Not Supported Operator "+a.operator);case "null":case "bool":case "string":case "number":return a.value;case "date":return this.parseDate(a.value);
case "timestamp":return this.parseTimestamp(a.value);case "column_ref":return"CURRENT_DATE"===a.column.toUpperCase()?(e=new Date,e.setHours(0,0,0,0),e):"CURRENT_TIMESTAMP"===a.column.toUpperCase()?new Date:this.featureValue(b,a.column,a);case "function":return b=this.evaluateNode(a.args,b),this.executeFunction(a.name,b)}throw Error("Unsupported sql syntax "+a.type);};g.prototype.executeFunction=function(a,b){switch(a.toLowerCase().trim()){case "extract":if(2!==b.length)throw Error("Invalid Parameter for call to Extract");
if(null==b[1])return null;a=b[1];if(a instanceof Date)switch(b[0].toUpperCase()){case "SECOND":return a.getSeconds();case "MINUTE":return a.getMinutes();case "HOUR":return a.getHours();case "DAY":return a.getDate();case "MONTH":return a.getMonth()+1;case "YEAR":return a.getFullYear();default:throw Error("Invalid Parameter for call to Extract");}else throw Error("Invalid Parameter for call to Extract");case "substring":if(2===b.length)return null===b[0]||null===b[1]?null:b[0].toString().substring(b[1]-
1);if(3===b.length)return null===b[0]||null===b[1]||null===b[2]?null:0>=b[2]?"":b[0].toString().substring(b[1]-1,b[1]+b[2]-1);throw Error("Invalid Parameter for call to SUBSTRING");case "abs":if(1!==b.length)throw Error("Invalid Parameter for call to ABS");return null===b[0]?null:Math.abs(b[0]);case "ceiling":case "ceil":if(1!==b.length)throw Error("Invalid Parameter for call to Ceil");return null===b[0]?null:Math.ceil(b[0]);case "floor":if(1!==b.length)throw Error("Invalid Parameter for call to Floor");
return null===b[0]?null:Math.floor(b[0]);case "log":if(1!==b.length)throw Error("Invalid Parameter for call to Log");return null===b[0]?null:Math.log(b[0]);case "log10":if(1!==b.length)throw Error("Invalid Parameter for call to Log10");return null===b[0]?null:Math.log(b[0])/Math.LN10;case "power":if(2!==b.length)throw Error("Invalid Parameter for call to POWER");return null===b[0]?null:Math.pow(b[0],b[1]);case "round":return 2===b.length?(a=b[0],b=-1*b[1],"undefined"===typeof b||0===+b?b=Math.round(a):
(a=+a,b=+b,isNaN(a)||"number"!==typeof b||0!==b%1?b=NaN:(a=a.toString().split("e"),a=Math.round(+(a[0]+"e"+(a[1]?+a[1]-b:-b))),a=a.toString().split("e"),b=+(a[0]+"e"+(a[1]?+a[1]+b:b)))),b):null===b[0]?null:Math.round(b[0]);case "truncate":if(1>b.length||2<b.length)throw Error("Invalid Parameter for TRUNCATE function");return null===b[0]?null:1===b.length?parseInt(b[0].toFixed(0),10):parseFloat(b[0].toFixed(b[1]));case "char_length":case "len":if(1!==b.length)throw Error("Invalid Parameter for CHAR_LENGTH function");
return"string"===typeof b[0]||b[0]instanceof String?b[0].length:0;case "concat":if(1>b.length)throw Error("Invalid Parameter for CONCAT function");a="";for(var c=0;c<b.length;c++)null!==b[c]&&(a+=b[c].toString());return a;case "lower":case "lcase":if(1!==b.length)throw Error("Invalid Parameter for Lower function");return null===b[0]?null:b[0].toString().toLowerCase();case "upper":case "ucase":if(1!==b.length)throw Error("Invalid Parameter for Upper function");return null===b[0]?null:b[0].toString().toUpperCase()}throw Error("Function Not Recognised");
};g.prototype._makeDateString=function(a,b){a=r(a);var c=0===a.minute()&&0===a.hour()&&0===a.second()&&0===a.millisecond();switch(b){case f.FeatureServiceDatabaseType.FILEGDB:case f.FeatureServiceDatabaseType.Standardised:return c?"date '"+a.format("YYYY-MM-DD")+"'":"date '"+a.format("YYYY-MM-DD HH:mm:ss")+"'";case f.FeatureServiceDatabaseType.Oracle:return c?"TO_DATE('"+a.format("YYYY-MM-DD")+"','YYYY-MM-DD')":"TO_DATE('"+a.format("YYYY-MM-DD HH:mm:ss")+"','YYYY-MM-DD HH24:MI:SS')";case f.FeatureServiceDatabaseType.SqlServer:return"'"+
a.format(c?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";case f.FeatureServiceDatabaseType.PGDB:return"#"+a.format(c?"MM-DD-YYYY":"MM-DD-YYYY HH:mm:ss")+"#";case f.FeatureServiceDatabaseType.Postgres:return"TIMESTAMP '"+a.format(c?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";default:return"date '"+a.format("YYYY-MM-DD HH:mm:ss")+"'"}};g.prototype._makeToday=function(a,b){switch(b){case f.FeatureServiceDatabaseType.FILEGDB:case f.FeatureServiceDatabaseType.Standardised:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP";
case f.FeatureServiceDatabaseType.Oracle:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP";case f.FeatureServiceDatabaseType.SqlServer:return a?"CAST(GETDATE() AS DATE)":"GETDATE()";case f.FeatureServiceDatabaseType.PGDB:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP";case f.FeatureServiceDatabaseType.Postgres:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP";default:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP"}};g.prototype.evaluateNodeToWhereClause=function(a,b,c,d){void 0===c&&(c=null);void 0===d&&(d=null);var e;
switch(a.type){case "case_expression":var f=" CASE ";"simple"===a.format&&(f+=this.evaluateNodeToWhereClause(a.operand,b,c,d));for(e=0;e<a.clauses.length;e++)f+=" WHEN "+this.evaluateNodeToWhereClause(a.clauses[e].operand,b,c,d)+" THEN "+this.evaluateNodeToWhereClause(a.clauses[e].value,b,c,d);null!==a.else&&(f+=" ELSE "+this.evaluateNodeToWhereClause(a.else,b,c,d));return f+" END ";case "param":c=this.parameters[a.value.toLowerCase()];if("string"===typeof c)return"'"+this.parameters[a.value.toLowerCase()].toString()+
"'";if(c instanceof Date)return this._makeDateString(c,b);if(c instanceof Array){a=[];for(e=0;e<c.length;e++)"string"===typeof c[e]?a.push("'"+c[e].toString()+"'"):c[e]instanceof Date?a.push(this._makeDateString(c[e],b)):a.push(c[e].toString());return a}return c.toString();case "expr_list":e=[];f=0;for(a=a.value;f<a.length;f++)e.push(this.evaluateNodeToWhereClause(a[f],b,c,d));return e;case "unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(a.expr,b,c,d)+" ) ";case "binary_expr":switch(a.operator){case "AND":return" ("+
this.evaluateNodeToWhereClause(a.left,b,c,d)+" AND "+this.evaluateNodeToWhereClause(a.right,b,c,d)+") ";case "OR":return" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" OR "+this.evaluateNodeToWhereClause(a.right,b,c,d)+") ";case "IS":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" IS NULL )";case "ISNOT":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+
" IS NOT NULL )";case "IN":e=[];if("expr_list"===a.right.type)return e=this.evaluateNodeToWhereClause(a.right,b,c,d)," ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" IN ("+e.join(",")+")) ";e=this.evaluateNodeToWhereClause(a.right,b,c,d);return e instanceof Array?" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" IN ("+e.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" IN ("+e+")) ";case "NOT IN":e=[];if("expr_list"===a.right.type)return e=this.evaluateNodeToWhereClause(a.right,
b,c,d)," ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" NOT IN ("+e.join(",")+")) ";e=this.evaluateNodeToWhereClause(a.right,b,c,d);return e instanceof Array?" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" NOT IN ("+e.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" NOT IN ("+e+")) ";case "BETWEEN":return e=this.evaluateNodeToWhereClause(a.right,b,c,d)," ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" BETWEEN "+e[0]+" AND "+e[1]+" ) ";case "NOTBETWEEN":return e=this.evaluateNodeToWhereClause(a.right,
b,c,d)," ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" NOT BETWEEN "+e[0]+" AND "+e[1]+" ) ";case "LIKE":return""!==a.escape?" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" LIKE "+this.evaluateNodeToWhereClause(a.right,b,c,d)+" ESCAPE '"+a.escape+"') ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" LIKE "+this.evaluateNodeToWhereClause(a.right,b,c,d)+") ";case "NOT LIKE":return""!==a.escape?" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" NOT LIKE "+this.evaluateNodeToWhereClause(a.right,
b,c,d)+" ESCAPE '"+a.escape+"') ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" NOT LIKE "+this.evaluateNodeToWhereClause(a.right,b,c,d)+") ";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":case "*":case "-":case "+":case "/":return" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" "+a.operator+" "+this.evaluateNodeToWhereClause(a.right,b,c,d)+") "}throw Error("Not Supported Operator "+a.operator);case "null":return"null";case "bool":return!0===a.value?"1":
"0";case "string":return"'"+a.value.toString()+"'";case "timestamp":return this._makeDateString(a.value,b);case "date":return this._makeDateString(a.value,b);case "number":return a.value.toString();case "column_ref":return"CURRENT_DATE"===a.column.toUpperCase()?this._makeToday(!0,b):"CURRENT_TIMESTAMP"===a.column.toUpperCase()?this._makeToday(!1,b):c?c.toLowerCase()===a.column.toLowerCase()?"("+d+")":a.column:a.column;case "function":return c=this.evaluateNodeToWhereClause(a.args,b,c,d),this.translateFunction(a.name,
c,b)}throw Error("Unsupported sql syntax "+a.type);};g.prototype.translateFunction=function(a,b,c){switch(a.toLowerCase().trim()){case "abs":if(1!==b.length)throw Error("Invalid Parameter for call to ABS");return"abs("+b[0]+")";case "ceiling":case "ceil":if(1!==b.length)throw Error("Invalid Parameter for call to CEILING");switch(c){case f.FeatureServiceDatabaseType.Standardised:return"CEILING("+b[0]+")";default:return"CEILING("+b[0]+")"}case "floor":if(1!==b.length)throw Error("Invalid Parameter for call to Floor");
return"FLOOR("+b[0]+")";case "log":if(1!==b.length)throw Error("Invalid Parameter for call to LOG");return"LOG("+b[0]+")";case "log10":if(1!==b.length)throw Error("Invalid Parameter for call to LOG10");return"LOG10("+b[0]+")";case "power":if(2!==b.length)throw Error("Invalid Parameter for call to POWER");return"POWER("+b[0]+","+b[1]+")";case "round":if(2===b.length)return"ROUND("+b[0]+","+b[1]+")";if(1===b.length)return"ROUND("+b[0]+")";throw Error("Invalid Parameter for call to ROUND");case "truncate":if(1>
b.length||2<b.length)throw Error("Invalid Parameter for TRUNCATE function");switch(c){case f.FeatureServiceDatabaseType.SqlServer:return"ROUND("+b[0]+(1===b.length?"0":","+b[1])+",1)";default:return"TRUNCATE("+b[0]+(1===b.length?")":","+b[1]+")")}case "char_length":case "len":if(1!==b.length)throw Error("Invalid Parameter for CHAR_LENGTH function");switch(c){case f.FeatureServiceDatabaseType.SqlServer:return"LEN("+b[0]+")";case f.FeatureServiceDatabaseType.Oracle:return"LENGTH("+b[0]+")";default:return"CHAR_LENGTH("+
b[0]+")"}case "concat":if(1>b.length)throw Error("Invalid Parameter for CONCAT function");c="CONCAT(";for(a=0;a<b.length;a++)0!==a&&(c+=","),c+=b[a];return c+")";case "lower":case "lcase":if(1!==b.length)throw Error("Invalid Parameter for Lower function");return"LOWER("+b[0]+")";case "upper":case "ucase":if(1!==b.length)throw Error("Invalid Parameter for Upper function");return"UPPER("+b[0]+")";case "substring":switch(a="",c){case f.FeatureServiceDatabaseType.Oracle:return a="SUBSTR("+b[0]+","+b[1],
3===b.length&&(a+=","+b[2]),a+")";case f.FeatureServiceDatabaseType.SqlServer:return a=3===b.length?"SUBSTRING("+b[0]+","+b[1]+","+b[2]+")":"SUBSTRING("+b[0]+",  "+b[1]+", LEN("+b[0]+") - "+b[1]+")";default:return a="SUBSTRING("+b[0]+" FROM "+b[1],3===b.length&&(a+=" FOR "+b[2]),a+")"}case "extract":return"EXTRACT("+b[0].replace(/\'/g,"")+" FROM "+b[1]+")"}throw Error("Function Not Recognised");};g.prototype.parseTimestamp=function(a){return r(a,["YYYY-M-D H:m:s","YYYY-M-D H:mZ","YYYY-M-D H:m:sZ",
"YYYY-M-D H:m","YYYY-m-d"]).toDate()};g.prototype.parseDate=function(a){return r(a,["YYYY-M-D"]).toDate()};g.prototype.evaluateWhereClausesSimpleDeferred=function(a,b,c,d,e){var f=new l,g=this;try{b>=a.length?null===c?f.resolve(null):this.evaluateNodeDeferred(c,e).then(function(a){f.resolve(a)},function(a){f.reject(a)}):this.evaluateNodeDeferred(a[b],e).then(function(m){d===h(m)?g.evaluateNode(a[b].value,e).then(function(a){f.resolve(a)},function(a){f.reject(a)}):g.evaluateWhereClausesSimpleDeferred(a,
b+1,c,d,e).then(function(a){f.resolve(a)},function(a){f.reject(a)})},function(a){f.reject(a)})}catch(p){f.reject(p)}return f.promise};g.prototype.evaluateWhereClausesDeferred=function(a,b,c,d){var e=new l,f=this;try{b>=a.length?null===c?e.resolve(null):this.evaluateNodeDeferred(c,d).then(function(a){e.resolve(a)},function(a){e.reject(a)}):this.evaluateNodeDeferred(a[b].operand,d).then(function(g){k(g)?f.evaluateNode(a[b].value,d).then(function(a){e.resolve(a)},function(a){e.reject(a)}):f.evaluateWhereClausesDeferred(a,
b+1,c,d).then(function(a){e.resolve(a)},function(a){e.reject(a)})},function(a){e.reject(a)})}catch(n){e.reject(n)}return e.promise};g.prototype.evaluateNodeDeferred=function(a,b){var c=new l,d=this,e;try{var g=void 0,n;switch(a.type){case "case_expression":"simple"===a.format?this.evaluateNodeDeferred(a.operand,b).then(function(e){e=h(e);d.evaluateWhereClausesSimpleDeferred(a.clauses,0,a.else,e,b).then(function(a){c.resolve(a)},function(a){c.reject(a)})},function(a){c.reject(a)}):d.evaluateWhereClausesDeferred(a.clauses,
0,a.else,b).then(function(a){c.resolve(a)},function(a){c.reject(a)});break;case "param":c.resolve(this.parameters[a.value.toLowerCase()]);break;case "expr_list":g=[];e=0;for(var p=a.value;e<p.length;e++){var q=p[e];g.push(this.evaluateNodeDeferred(q,b))}w(g).then(f.callback(function(a){c.resolve(a)},c),f.errback(c));break;case "unary_expr":this.evaluateNodeDeferred(a.expr,b).then(f.callback(function(a){c.resolve(!k(a))},c),f.errback(c));break;case "binary_expr":switch(a.operator){case "IS":"null"!==
a.right.type?c.reject(Error("Unsupported RHS for IS")):this.evaluateNodeDeferred(a.left,b).then(f.callback(function(a){c.resolve(null===a)},c),f.errback(c));break;case "ISNOT":"null"!==a.right.type?c.reject(Error("Unsupported RHS for IS")):this.evaluateNodeDeferred(a.left,b).then(f.callback(function(a){c.resolve(null!==a)},c),f.errback(c));break;case "LIKE":case "NOT LIKE":case "BETWEEN":case "NOTBETWEEN":case "IN":case "NOT IN":case "AND":case "OR":case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":case "*":case "-":case "+":case "/":e=
[d.evaluateNodeDeferred(a.left,b),d.evaluateNodeDeferred(a.right,b)];w(e).then(f.callback(function(b){switch(a.operator){case "LIKE":case "NOT LIKE":b=v(b[0],b[0],a.escape);c.resolve("LIKE"===a.operator?b:!b);break;case "BETWEEN":case "NOTBETWEEN":var d=b[0];n=b[1];b=d>=n[0]&&d<=n[1];c.resolve("BETWEEN"===a.operator?b:!b);break;case "IN":case "NOT IN":"IN"===a.operator?b[1]instanceof Array?c.resolve(-1<b[1].indexOf(b[0])):c.resolve(-1<[b[1]].indexOf(b[0])):"NOT IN"===a.operator&&(b[1]instanceof Array?
c.resolve(!(-1<b[1].indexOf(b[0]))):c.resolve(!(-1<[b[1]].indexOf(b[0]))));break;case "AND":c.resolve(k(b[0])&&k(b[1]));break;case "OR":c.resolve(k(b[0])||k(b[1]));break;case "\x3c\x3e":c.resolve(h(b[0])!==h(b[1]));break;case "\x3c":c.resolve(h(b[0])<h(b[1]));break;case "\x3e":c.resolve(h(b[0])>h(b[1]));break;case "\x3e\x3d":c.resolve(h(b[0])>=h(b[1]));break;case "\x3c\x3d":c.resolve(h(b[0])<=h(b[1]));break;case "\x3d":c.resolve(h(b[0])===h(b[1]));break;case "*":c.resolve(b[0]*b[1]);break;case "-":c.resolve(b[0]-
b[1]);break;case "+":c.resolve(b[0]+b[1]);break;case "/":c.resolve(b[0]/b[1]);break;default:c.reject(Error("Unrecognised operator"))}},c),f.errback(c));break;default:c.reject(Error("Not Supported Operator "+a.operator))}break;case "null":case "bool":case "string":case "number":c.resolve(a.value);break;case "date":c.resolve(d.parseDate(a.value));break;case "timestamp":c.resolve(d.parseTimestamp(a.value));break;case "column_ref":"CURRENT_DATE"===a.column.toUpperCase()?(q=new Date,q.setHours(0,0,0,0),
c.resolve(q)):"CURRENT_TIMESTAMP"===a.column.toUpperCase()?c.resolve(new Date):c.resolve(this.featureValue(b,a.column,a));break;case "function":this.evaluateNodeDeferred(a.args,b).then(f.callback(function(e){d.executeFunctionDeferred(a.name,b,e).then(f.callback(function(a){c.resolve(a)},c),f.errback(c))},c),f.errback(c));break;default:c.reject(Error("Malformed Where Clause"))}}catch(B){c.reject(B)}return c.promise};g.prototype.executeFunctionDeferred=function(a,b,c){var d=new l,e=0;try{switch(a.toLowerCase().trim()){case "extract":case "substring":case "abs":case "ceiling":case "ceil":case "floor":case "log":case "log10":case "power":case "round":case "truncate":case "char_length":case "len":case "concat":case "lower":case "lcase":case "upper":case "ucase":try{d.resolve(this.executeFunction(a,
c))}catch(m){d.reject(m)}break;case "area":e=f.convertSquareUnitsToCode(c[0]);a=!1;void 0===c[1]||null===c[1]||"1"!==c[1].toString()&&"true"!==c[1].toString().toLowerCase()&&"geodesic"!==c[1].toString().toLowerCase()||(a=!0);null===b.geometry?d.resolve(0):a?t.geodesicArea(b.geometry,e).then(f.callback(function(a){d.resolve(a)},d),f.errback(d)):t.planarArea(b.geometry,e).then(f.callback(function(a){d.resolve(a)},d),f.errback(d));break;case "length":e=f.convertLinearUnitsToCode(c[0]);void 0===c[1]||
null===c[1]||"1"!==c[1].toString()&&"true"!==c[1].toString().toLowerCase()&&"geodesic"!==c[1].toString().toLowerCase()||(a=!0);null===b.geometry?d.resolve(0):t.planarLength(b.geometry,e).then(f.callback(function(a){d.resolve(a)},d),f.errback(d));break;default:d.reject(Error("Function Not Recognised"))}}catch(m){d.reject(m)}return d.promise};return g}()});