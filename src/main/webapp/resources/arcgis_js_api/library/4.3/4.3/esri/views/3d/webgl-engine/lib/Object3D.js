// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ./IdGen ./Util ./gl-matrix ./ComponentUtils ./ModelContentType ./GeometryRecord".split(" "),function(q,z,w,t,u,l,x,p){var k=t.assert,d=u.mat4d,m=u.vec3d,r=t.VertexAttrConstants;q=function(){function b(a){void 0===a&&(a={});this._bvObjectSpace=new v;this._bvWorldSpace=new v;this._bvDirty=!0;this._hasVolatileTransformation=!1;this.id=b._idGen.gen(a.idHint);this.name=a.name;this.castShadow=null!=a.castShadow?a.castShadow:!0;this.metadata=a.metadata;this.objectTransformation=d.identity();
this._initializeGeometryRecords(a.geometries,a.materials,a.transformations)}b.prototype._initializeGeometryRecords=function(a,h,c){if(Array.isArray(a)){k(h.length===a.length,"Object3D: materials don't match geometries");k(c.length===a.length,"Object3D: transformations don't match geometries");this.geometryRecords=Array(a.length);this.geometries=a.slice();for(var b=0;b<a.length;b++)k(Array.isArray(h[b]),"Object3D: materials parameter must be array of array"),this.geometryRecords[b]=new p(a[b],h[b].slice(),
d.create(c[b]),{});this._hasVolatileTransformation=!1}else this.geometryRecords=[],this.geometries=[]};b.prototype.getId=function(){return this.id};Object.defineProperty(b.prototype,"parentLayer",{get:function(){return this._parentLayer},set:function(a){k(null==this._parentLayer||null==a,"Object3D can only be added to a single Layer");this._parentLayer=a},enumerable:!0,configurable:!0});b.prototype.getParentLayer=function(){return this.parentLayer};b.prototype.addParentLayer=function(a){this.parentLayer=
a};b.prototype.removeParentLayer=function(a){this.parentLayer=null};b.prototype.getNumGeometryRecords=function(){return this.geometryRecords.length};b.prototype.getFirstGeometryIndex=function(a){a=this.geometries.indexOf(a);k(-1<a,"Object3D.getFirstGeometryIndex: geometry not found");return a};b.prototype.findGeometryRecords=function(a){for(var h=[],c=0;c<this.geometries.length;c++)this.geometries[c]===a&&h.push(this.geometryRecords[c]);return h};b.prototype.getGeometryRecord=function(a){k(0<=a&&
a<this.geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range");return this.geometryRecords[a]};b.prototype.getGeometryRecords=function(){return this.geometryRecords};b.prototype.addGeometry=function(a,h,c,b,y,g){k(Array.isArray(h),"Object3D.addGeometry: materials must be array");this.geometries.push(a);a=new p(a,h.slice(),d.create(c),b||{},y,g);this.geometryRecords.push(a);this._hasVolatileTransformation=this.geometryRecords.some(function(a){return!!a.customTransformation});
this._notifyDirty("objGeometryAdded",a);this._invalidateBoundingVolume();return a};b.prototype.hasGeometry=function(a){return-1<this.geometries.indexOf(a)};b.prototype.removeGeometry=function(a){var h=this.geometryRecords.splice(a,1)[0];this._hasVolatileTransformation=this.geometryRecords.some(function(a){return!!a.customTransformation});this.geometries.splice(a,1);this._notifyDirty("objGeometryRemoved",h);this._invalidateBoundingVolume();return h};b.prototype.geometryVertexAttrsUpdated=function(a){this._notifyDirty("vertexAttrsUpdated",
this.geometryRecords[a]);this._invalidateBoundingVolume()};b.prototype.geometryColorAttrsUpdated=function(a){this._notifyDirty("colorAttrsUpdated",this.geometryRecords[a])};b.prototype.isAllHidden=function(){for(var a=0,h=this.geometryRecords;a<h.length;a++){var c=h[a],b=c.instanceParameters.componentVisibilities,c=c.geometry.getData().componentOffsets;if(!l.isAllHidden(b,c))return!1}return!0};b.prototype.isAllVisible=function(){for(var a=0,h=this.geometryRecords;a<h.length;a++){var c=h[a],b=c.instanceParameters.componentVisibilities,
c=c.geometry.getData().componentOffsets;if(!l.isAllVisible(b,c))return!1}return!0};b.prototype.setFacerangeColors=function(a,h){var c=this.geometryRecords;if(1!==c.length)console.warn("face range colors currently support only one geometry record");else{var c=c[0].geometry,b=c.data.vertexAttributes;if(null!=c.originalColors||!a.every(function(a){return null==a.color}))if(null==c.originalColors&&(c.originalColors=b[r.COLOR].data,b[r.COLOR].data=new c.originalColors.constructor(c.originalColors)),b=
b[r.COLOR].data,null!=b){for(var d=0;d<a.length;d++){var g=a[d],e=null==g.faceRanges?0:12*g.faceRanges[0],m=null==g.faceRanges?b.length:12*(g.faceRanges[1]+1);if(null!=g.color)if("blend"===h)for(var f=g.color[0],k=g.color[1],l=g.color[2],g=g.color[3];e<m;e+=4)b[e+0]=c.originalColors[e+0]*f,b[e+1]=c.originalColors[e+1]*k,b[e+2]=c.originalColors[e+2]*l,b[e+3]=c.originalColors[e+3]*g;else for(f=255*g.color[0],k=255*g.color[1],l=255*g.color[2],g=255*g.color[3];e<m;e+=4)b[e+0]=f,b[e+1]=k,b[e+2]=l,b[e+
3]=g;else for(;e<m;e++)b[e]=c.originalColors[e]}this.geometryColorAttrsUpdated(0)}}};b.prototype.hasComponents=function(){for(var a=!1,b=0;b<this.geometries.length&&!(a=this.geometries[b].getData(),a=l.hasComponents(a.componentOffsets));b++);return a};b.prototype.setComponentVisibility=function(a,b,c){var h=a.instanceParameters.componentVisibilities,d=a.geometry.getData().componentOffsets;b=l.updateVisibility(h,d,b,c);a.instanceParameters.componentVisibilities=b;this._notifyDirty("componentVisibilityChanged",
a)};b.prototype.getComponentVisibility=function(a,b){return l.getVisibility(a.instanceParameters.componentVisibilities,b)};b.prototype.hideAllComponents=function(){for(var a=0,b=this.geometryRecords;a<b.length;a++){var c=b[a],d=l.hideAllComponents(c.instanceParameters.componentVisibilities);c.instanceParameters.componentVisibilities=d}this._notifyDirty("componentVisibilityChanged")};b.prototype.unhideAllComponents=function(){for(var a=0,b=this.geometryRecords;a<b.length;a++){var c=b[a],d=l.unhideAllComponents(c.instanceParameters.componentVisibilities);
c.instanceParameters.componentVisibilities=d}this._notifyDirty("componentVisibilityChanged")};b.prototype.getFaceRangeIndexFromTriangleNr=function(a){var b=this.metadata.faceRanges;if(null!=b)for(var c=0;c<b.length;c++)if(b[c][0]<=a&&b[c][1]>=a)return c};b.prototype.getFaceRangeFromTriangleNr=function(a){a=this.getFaceRangeIndexFromTriangleNr(a);var b=this.metadata.faceRanges;return a?[b[a]]:null};b.prototype.setGeometryTransformation=function(a,b){k(0<=a&&a<this.geometryRecords.length,"Object3d.setGeometryTransformation: index out of range");
var c=this.geometryRecords[a];b=new p(c.geometry,c.materials,d.create(b),c.instanceParameters);this.geometryRecords[a]=b;this._notifyDirty("objGeometryReplaced",[c,b]);this._invalidateBoundingVolume()};b.prototype.getObjectTransformation=function(){return d.create(this.objectTransformation)};b.prototype.setObjectTransformation=function(a){d.set(a,this.objectTransformation);this._invalidateBoundingVolume();this._notifyDirty("objTransformation")};b.prototype.getCombinedStaticTransformation=function(a,
b){b=b||d.create();d.multiply(this.objectTransformation,a.getStaticTransformation(),b);return b};b.prototype.getCombinedShaderTransformation=function(a,b){b=b||d.create();d.multiply(this.objectTransformation,a.getShaderTransformation(),b);return b};b.prototype.hasVolativeTransformation=function(){return this._hasVolatileTransformation};b.prototype.getCastShadow=function(){return this.castShadow};b.prototype.setCastShadow=function(a){this.castShadow=a};b.prototype.getMetadata=function(){return this.metadata};
b.prototype.getName=function(){return this.name};b.prototype.getBBMin=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.bbMin:this._bvWorldSpace.bbMin};b.prototype.getBBMax=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.bbMax:this._bvWorldSpace.bbMax};b.prototype.getCenter=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.center:this._bvWorldSpace.center};b.prototype.getBSRadius=function(a){this._validateBoundingVolume();return a?
this._bvObjectSpace.bsRadius:this._bvWorldSpace.bsRadius};b.prototype._validateBoundingVolume=function(){if(this._bvDirty||this._hasVolatileTransformation){this._bvObjectSpace.init();this._bvWorldSpace.init();for(var a=m.create(),b=m.create(),c=0;c<this.geometryRecords.length;++c)for(var k=this.geometries[c],l=this.geometryRecords[c].getShaderTransformation(),g=k.getNumGroups(),e=0;e<g;++e){var n=k.getBoundingInfo(e);d.multiplyVec3(l,n.getBBMin(),a);d.multiplyVec3(l,n.getBBMax(),b);for(var f=0;3>
f;++f)this._bvObjectSpace.bbMin[f]=Math.min(this._bvObjectSpace.bbMin[f],a[f],b[f]),this._bvObjectSpace.bbMax[f]=Math.max(this._bvObjectSpace.bbMax[f],a[f],b[f]);d.multiplyVec3(this.objectTransformation,a);d.multiplyVec3(this.objectTransformation,b);for(f=0;3>f;++f)this._bvWorldSpace.bbMin[f]=Math.min(this._bvWorldSpace.bbMin[f],a[f],b[f]),this._bvWorldSpace.bbMax[f]=Math.max(this._bvWorldSpace.bbMax[f],a[f],b[f])}m.lerp(this._bvObjectSpace.bbMin,this._bvObjectSpace.bbMax,.5,this._bvObjectSpace.center);
m.lerp(this._bvWorldSpace.bbMin,this._bvWorldSpace.bbMax,.5,this._bvWorldSpace.center);f=this._getScaleFactor(this.objectTransformation);for(c=0;c<this.geometryRecords.length;++c)for(var k=this.geometries[c],l=this.geometryRecords[c].getShaderTransformation(),q=this._getScaleFactor(l),g=k.getNumGroups(),e=0;e<g;++e){n=k.getBoundingInfo(e);d.multiplyVec3(l,n.getCenter(),a);var p=m.dist(a,this._bvObjectSpace.center),n=n.getBSRadius()*q;this._bvObjectSpace.bsRadius=Math.max(this._bvObjectSpace.bsRadius,
p+n);d.multiplyVec3(this.objectTransformation,a,b);p=m.dist(b,this._bvWorldSpace.center);this._bvWorldSpace.bsRadius=Math.max(this._bvWorldSpace.bsRadius,p+n*f)}this._bvDirty=!1}};b.prototype._getScaleFactor=function(a){return Math.max(Math.max(Math.sqrt(a[0]*a[0]+a[4]*a[4]+a[8]*a[8]),Math.sqrt(a[1]*a[1]+a[5]*a[5]+a[9]*a[9])),Math.sqrt(a[2]*a[2]+a[6]*a[6]+a[10]*a[10]))};b.prototype._invalidateBoundingVolume=function(){this._bvDirty=!0;this._parentLayer&&this._parentLayer.notifyObjectBBChanged(this,
this._bvWorldSpace)};b.prototype._notifyDirty=function(a,b,c,d){this._parentLayer&&(c=c||x.OBJECT,this._parentLayer.notifyDirty(a,b,c,d||this))};return b}();q._idGen=new w;var v=function(){function b(){this.bbMin=m.create();this.bbMax=m.create();this.center=m.create();this.bsRadius=0}b.prototype.init=function(){m.set3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.bbMin);m.set3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.bbMax);m.set3(0,0,0,this.center);this.bsRadius=0};b.prototype.getCenter=
function(){return this.center};b.prototype.getBSRadius=function(){return this.bsRadius};return b}();return q});