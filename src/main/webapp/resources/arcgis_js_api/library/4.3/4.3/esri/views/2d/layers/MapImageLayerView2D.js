// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/HandleRegistry ../../../layers/support/ExportImageParameters ./LayerView2D ./support/ExportStrategy ../engine/BitmapSource ../engine/Canvas2DContainer".split(" "),function(c,q,f,g,e,h,k,l,m,n,p){c=function(c){function a(){var b=null!==c&&c.apply(this,arguments)||this;b._handles=new h;b.container=new p;return b}f(a,c);a.prototype.hitTest=function(b,
a){return null};a.prototype.update=function(b){this.strategy.update(b);this.notifyChange("updating")};a.prototype.attach=function(){var b=this,a=this.layer;this.strategy=new m(this.container,function(a){return b._fetchImage(a)},function(){return b.requestUpdate()},0,10.3<=a.version,a.imageMaxWidth,a.imageMaxHeight);this._exportImageParameters=new k({layer:this.layer});this._handles.add(this._exportImageParameters.watch("version",function(a){b._exportImageVersion!==a&&(b._exportImageVersion=a,b.requestUpdate())}))};
a.prototype.detach=function(){this.container.removeAllChildren();this.strategy.destroy();this._handles.removeAll();this._exportImageParameters.layer=null;this._exportImageParameters.destroy();this._exportImageParameters=null};a.prototype.moveStart=function(){};a.prototype.viewChange=function(){};a.prototype.moveEnd=function(){this.requestUpdate()};a.prototype.isUpdating=function(){return this.attached&&(this.strategy.updating||this.updateRequested)};a.prototype.getPopupData=function(a){var b=this,
d=this.view.scale;return this.layer.allSublayers.filter(function(a){var b=0===a.minScale||d<=a.minScale,c=0===a.maxScale||d>=a.maxScale;return a.popupTemplate&&a.visible&&b&&c}).map(function(c){var d=c.createQuery();d.geometry=a;d.outFields=b.getTemplateOutFields(c.popupTemplate);return c.queryFeatures(d).then(function(a){return a.features})})};a.prototype.getTemplateOutFields=function(a){if(!a||!a.fieldInfos)return["*"];var b=[];a.fieldInfos.forEach(function(a){var c=a.fieldName&&a.fieldName.toLowerCase();
c&&"shape"!==c&&0!==c.indexOf("relationships/")&&b.push(a.fieldName)});return b};a.prototype._fetchImage=function(a){var b=this;this._exportImageParameters.scale!==this.view.scale&&(this._exportImageParameters.scale=this.view.scale,this._exportImageVersion=this._exportImageParameters.version);return this.layer.fetchImage(a).then(function(a){b.notifyChange("updating");return new n(a.img)})};return a}(e.declared(l));return c=g([e.subclass("esri.views.2d.layers.MapImageLayerView2D")],c)});