// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/extendsHelper ../../core/tsSupport/decorateHelper ./Bucket ./Geometry ./style/StyleLayer ./Placement ./GeometryUtils ./TextShaping dojox/string/BidiEngine".split(" "),function(D,N,G,O,H,C,E,F,u,I,J){function K(u,g){if(u.iconMosaicItem&&g.iconMosaicItem){if(u.iconMosaicItem.page!==g.iconMosaicItem.page)return u.iconMosaicItem.page<g.iconMosaicItem.page?-1:1}else{if(u.iconMosaicItem&&!g.iconMosaicItem)return 1;if(!u.iconMosaicItem&&g.iconMosaicItem)return-1}return 0}
var L=function(){return function(){}}(),M=function(){return function(u,g,a,e){this.line=g;this.shaping=u;this.iconMosaicItem=a;this.anchor=e}}();(function(){return function(){}})();D=function(D){function g(a,e,c,d,f,b,m,x){a=D.call(this,a,e)||this;a._markerRatio=1;a._markerMap=new Map;a._markerVertexBuffer=c;a._markerIndexBuffer=d;a._textVertexBuffer=f;a._textIndexBuffer=b;a._placementEngine=m;a._workerTileHandler=x;return a}G(g,D);Object.defineProperty(g.prototype,"markerPageMap",{get:function(){return this._markerMap},
enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"textIndexStart",{get:function(){return this._textTriangleElementsStart},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"textIndexCount",{get:function(){return this._textTriangleElementsNum},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"sdfMarker",{get:function(){return!1},enumerable:!0,configurable:!0});g.prototype.copy=function(a,e,c,d,f){f=new g(this.layer,this.zoom,a,e,c,d,f,this._workerTileHandler);
f.layerIndex=this.layerIndex;f.layerExtent=this.layerExtent;f._markerVertexStart=a.index;f._markerTriangleElementsStart=e.index;f._textVertexStart=c.index;f._textTriangleElementsStart=d.index;f._markerTriangleElementsNum=0;f._textTriangleElementsNum=0;f._symbolInstances=this._symbolInstances;f._glyphItems=this._glyphItems;f._textLayout=this._textLayout;f._markerLayout=this._markerLayout;f._isLinePlacement=this._isLinePlacement;f._avoidEdges=this._avoidEdges;return f};g.prototype.getResources=function(a,
e,c){var d=this.layer,f=this.zoom;a&&a.setExtent(this.layerExtent);for(var b=d.getLayoutValue("icon-image",f),m=d.getLayoutValue("text-field",f),x=d.getLayoutValue("text-font",f),d=d.getLayoutValue("text-transform",f),f=[],r=0,v=this._features;r<v.length;r++){var n=v[r],q=n.getGeometry(a);if(q&&0!==q.length){var h=void 0;b&&(h=this._replaceKeys(b,n.values))&&e.add(h);var k=void 0,t=!1;if(m){k=this._replaceKeys(m,n.values);switch(d){case 2:k=k.toLowerCase();break;case 1:k=k.toUpperCase()}g._bidiEngine.hasBidiChar(k)&&
(t=void 0,t="rtl"===g._bidiEngine.checkContextual(k)?"IDNNN":"ICNNN",k=g._bidiEngine.bidiTransform(k,t,"VLYSN"),t=!0);n=k.length;if(0<n){var l=c[x];l||(l=c[x]=new Set);for(var p=0;p<n;p++){var y=k.charCodeAt(p);l.add(y)}}}if(h||k)n=new L,n.sprite=h,n.label=k,n.rtl=t,n.geometry=q,f.push(n)}}this._symbolFeatures=f};g.prototype.processFeatures=function(a,e){a&&a.setExtent(this.layerExtent);var c=this.layer,d=this.zoom;e=this._isLinePlacement=1===c.getLayoutValue("symbol-placement",d);a=this._avoidEdges=
c.getLayoutValue("symbol-avoid-edges",d)&&!e;var f=8*c.getLayoutValue("symbol-spacing",d),b=c.getLayoutValue("icon-image",d),m=c.getLayoutValue("text-field",d),x=this._workerTileHandler,r;b&&(this._markerLayout=new E.IconLayout(c,d,e),r=x.getSpriteItems());var v,n;if(m){var q=this._textLayout=new E.TextLayout(c,d,e);v=void 0;q.font&&q.font.length&&(v=q.font[0]);n=.5;switch(q.anchor){case 5:case 1:case 7:n=0;break;case 6:case 2:case 8:n=1}c=.5;switch(q.anchor){case 5:case 3:case 6:c=0;break;case 7:case 4:case 8:c=
1}d=.5;switch(q.justify){case 0:d=0;break;case 2:d=1}var b=24*q.letterSpacing,m=e?0:24*q.maxWidth,h=24*q.lineHeight,q=[24*q.offset[0],24*q.offset[1]];v=x.getGlyphItems(v);n=new I(v,m,h,b,q,n,c,d)}this._markerVertexStart=this._markerVertexBuffer.index;this._markerTriangleElementsStart=this._markerIndexBuffer.index;this._textVertexStart=this._textVertexBuffer.index;this._textTriangleElementsStart=this._textIndexBuffer.index;this._textTriangleElementsNum=this._markerTriangleElementsNum=0;this._markerMap.clear();
this._symbolInstances=x=[];this._glyphItems=v;c=this._textLayout;d=1;c&&c.size&&(d=c.size/24);b=c?c.maxAngle*u.C_DEG_TO_RAD:0;m=c?8*c.size:0;h=0;for(q=this._symbolFeatures;h<q.length;h++){var k=q[h],t=void 0;k.sprite&&(t=r[k.sprite]);var l=void 0,p=k.label,y=0;if(p&&(l=n.getShaping(p,k.rtl))&&0<l.length){for(var y=1E30,p=-1E30,z=0,w=l;z<w.length;z++)var B=w[z],y=Math.min(y,B.x),p=Math.max(p,B.x);y=(p-y+48)*d*8}p=0;for(k=k.geometry;p<k.length;p++)for(z=k[p],B=void 0,e?(l&&0<l.length&&c&&c.size&&g._smoothVertices(z,
8*c.size*(2+Math.min(2,4*Math.abs(c.offset[1])))),B=g._findAnchors(z,f,y)):B=[new F.Anchor(z[0].x,z[0].y)],w=0;w<B.length;w++){var A=B[w];0>A.x||4096<A.x||0>A.y||4096<A.y||e&&0<y&&0===c.rotationAlignment&&!g._honorsTextMaxAngle(z,A,y,b,m)||x.push(new M(l,z,t,A))}}x.sort(K);for(r=0;r<x.length;r++)this._processFeature(x[r],v,a)};g.prototype.updateSymbols=function(){this._markerVertexStart=this._markerVertexBuffer.index;this._markerTriangleElementsStart=this._markerIndexBuffer.index;this._textVertexStart=
this._textVertexBuffer.index;this._textTriangleElementsStart=this._textIndexBuffer.index;this._textTriangleElementsNum=this._markerTriangleElementsNum=0;this._markerMap.clear();for(var a=this._glyphItems,e=this._avoidEdges,c=0,d=this._symbolInstances;c<d.length;c++)this._processFeature(d[c],a,e)};g.prototype._replaceKeys=function(a,e){return a.replace(/{([^{}]+)}/g,function(a,d){return d in e?e[d]:""})};g.prototype._processFeature=function(a,e,c){var d=a.line,f=a.iconMosaicItem,b=a.shaping,m=a.anchor,
x=(a=this._markerLayout)&&!!f,r=!0,g=1;x&&(g=a.size/(1/this._markerRatio)*8,r=a.optional||!f);var n=this._textLayout,q=n&&b&&0<b.length,h;h=1;var k=!0;q&&(h=n.size/24,h*=8,k=n.optional||!b||0===b.length);var t=new C.Point(0,-17),l;if(x){l=this._placementEngine.getIconPlacement(m,f,g,d,a,c);if(l.footprint.minzoom===u.C_INFINITY&&!r)return;m.minzoom>l.footprint.minzoom&&(l.footprint.minzoom=m.minzoom)}var p;if(q&&(p=this._placementEngine.getTextPlacement(m,t,b,e,h,d,n,c))){if(p.footprint.minzoom===
u.C_INFINITY&&!k)return;m.minzoom>p.footprint.minzoom&&(p.footprint.minzoom=m.minzoom)}if(!k&&!r||!r&&p&&p.footprint.minzoom!==u.C_INFINITY||!k&&l&&l.footprint.minzoom!==u.C_INFINITY)e=Math.max(l.footprint.minzoom,p.footprint.minzoom),l.footprint.minzoom=e,p.footprint.minzoom=e;p&&p.footprint.minzoom!==u.C_INFINITY&&(n.ignorePlacement||this._placementEngine.add(p),this._addPlacedSymbols(p.shapes,p.footprint.minzoom,this.zoom,!1));l&&l.footprint.minzoom!==u.C_INFINITY&&(a.ignorePlacement||this._placementEngine.add(l),
this._addPlacedSymbols(l.shapes,l.footprint.minzoom,this.zoom,!0,f.page))};g.prototype._addPlacedSymbols=function(a,e,c,d,f){void 0===f&&(f=-1);e=Math.max(c+u.log2(e),0);for(var b=0;b<a.length;b++){var m=a[b],x=Math.max(c+u.log2(m.minzoom),e),r=Math.min(c+u.log2(m.maxzoom),25);if(!(r<=x)){var g=m.tl,n=m.tr,q=m.bl,h=m.br,k=m.mosaicRect,t=-m.labelAngle,m=m.anchor,l=d?this._markerVertexBuffer:this._textVertexBuffer,p=d?this._markerIndexBuffer:this._textIndexBuffer,y=l.index,z=k.x,w=k.y,B=z+k.width,k=
w+k.height;l.add(m.x,m.y,g.x,g.y,z,w,t,x,r,e);l.add(m.x,m.y,n.x,n.y,B,w,t,x,r,e);l.add(m.x,m.y,q.x,q.y,z,k,t,x,r,e);l.add(m.x,m.y,h.x,h.y,B,k,t,x,r,e);p.add(y+0,y+1,y+2);p.add(y+1,y+2,y+3);d?(this._markerMap.has(f)?this._markerMap.get(f)[1]+=6:this._markerMap.set(f,[this._markerTriangleElementsStart+this._markerTriangleElementsNum/3,6]),this._markerTriangleElementsNum+=6):this._textTriangleElementsNum+=6}}};g._findAnchors=function(a,e,c){e+=c;for(var d=0,f=a.length-1,b=0;b<f;b++)d+=C.Point.distance(a[b],
a[b+1]);b=.5*(c||e);if(d<=b)return[];c=b/d;e=d/Math.max(Math.round(d/e),1);for(var d=0,f=-e/2,m=[],g=a.length-1,b=0;b<g;b++){for(var r=a[b],v=a[b+1],n=v.x-r.x,q=v.y-r.y,h=Math.sqrt(n*n+q*q),k=void 0;f+e<d+h;){var f=f+e,t=(f-d)/h,l=u.interpolate(r.x,v.x,t),t=u.interpolate(r.y,v.y,t);void 0===k&&(k=Math.atan2(q,n));m.push(new F.Anchor(l,t,k,b,c))}d+=h}return m};g.deviation=function(a,e,c){return Math.atan2((e.x-a.x)*(c.y-e.y)-(e.y-a.y)*(c.x-e.x),(e.x-a.x)*(c.x-e.x)+(e.y-a.y)*(c.y-e.y))};g._honorsTextMaxAngle=
function(a,e,c,d,f){var b=0;c/=2;for(var m=new C.Point(e.x,e.y),g=e.segment+1;b>-c;){--g;if(0>g)return!1;b-=C.Point.distance(a[g],m);m=a[g]}b+=C.Point.distance(a[g],a[g+1]);e=[];for(var m=0,r=a.length;b<c;){var v=a[g],n=void 0;do{++g;if(g===r)return!1;n=a[g]}while(n.isEqual(v));var q=g,h=void 0;do{++q;if(q===r)return!1;h=a[q]}while(h.isEqual(n));v=this.deviation(v,n,h);e.push({deviation:v,distToAnchor:b});for(m+=v;b-e[0].distToAnchor>f;)m-=e.shift().deviation;if(Math.abs(m)>d)return!1;b+=C.Point.distance(n,
h)}return!0};g._smoothVertices=function(a,e){if(!(0>=e)){var c=a.length;if(!(3>c)){var d=[],f=0;d.push(0);for(var b=1;b<c;b++)f+=C.Point.distance(a[b],a[b-1]),d.push(f);e=Math.min(e,.2*f);f=[];f.push(a[0].x);f.push(a[0].y);var g=a[c-1].x,x=a[c-1].y,b=C.Point.sub(a[0],a[1]);b.normalize();a[0].x+=e*b.x;a[0].y+=e*b.y;b.assignSub(a[c-1],a[c-2]);b.normalize();a[c-1].x+=e*b.x;a[c-1].y+=e*b.y;for(b=1;b<c;b++)d[b]+=e;d[c-1]+=e;for(var r=.5*e,b=1;b<c-1;b++){for(var v=0,n=0,q=0,h=b-1;0<=h&&!(d[h+1]<d[b]-r);h--){var k=
r+d[h+1]-d[b],t=d[h+1]-d[h],l=d[b]-d[h]<r?1:k/t;if(1E-6>Math.abs(l))break;var p=l*l,y=l*k-.5*p*t,z=l*t/e,w=a[h+1],u=a[h].x-w.x,A=a[h].y-w.y,v=v+z/y*(w.x*l*k+.5*p*(k*u-t*w.x)-p*l*t*u/3),n=n+z/y*(w.y*l*k+.5*p*(k*A-t*w.y)-p*l*t*A/3),q=q+z}for(h=b+1;h<c&&!(d[h-1]>d[b]+r);h++){k=r-d[h-1]+d[b];t=d[h]-d[h-1];l=d[h]-d[b]<r?1:k/t;if(1E-6>Math.abs(l))break;p=l*l;y=l*k-.5*p*t;z=l*t/e;w=a[h-1];u=a[h].x-w.x;A=a[h].y-w.y;v+=z/y*(w.x*l*k+.5*p*(k*u-t*w.x)-p*l*t*u/3);n+=z/y*(w.y*l*k+.5*p*(k*A-t*w.y)-p*l*t*A/3);q+=
z}f.push(v/q);f.push(n/q)}f.push(g);f.push(x);for(h=b=0;b<c;b++)a[b].x=f[h++],a[b].y=f[h++]}}};return g}(H);D._bidiEngine=new J;return D});