// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("../../../../core/declare ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./Graphics3DDrapedGraphicLayer ./ElevationAligners ./Graphics3DSymbolCommonCode ./lineUtils ../../../../core/screenUtils ../../../../geometry/Polygon ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/RenderGeometry".split(" "),function(F,G,H,I,A,l,u,B,J,C,D,K,L,M){var E=C.vec3d,w=C.mat4d;return F([G],{_prepareResources:function(){var a=
this.symbol,b=this._isPropertyDriven("size")||this._isPropertyDriven("color")||this._isPropertyDriven("opacity"),c={idHint:this._getStageIdHint(),width:this._getWidth(a),color:this._getMaterialOpacityAndColor()};if(b||1.5<=c.width)this._isPropertyDriven("size")&&(c.width=0),c.miterLimit=a.miterLimit,c.join=a.join,this._isNativeLineMaterial=!1,this._material=u.createRibbonMaterial(c);else if(0<c.width)this._isNativeLineMaterial=!0,this._material=u.createNativeMaterial(c);else{this.reject();return}this._context.stage.add(D.ModelContentType.MATERIAL,
this._material);this.resolve()},_getWidth:function(a){return null!=a.size?B.pt2px(a.size):1},destroy:function(){this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(D.ModelContentType.MATERIAL,this._material.getId()),this._material=null)},createGraphics3DGraphic:function(a,b){var c=a.geometry;if("polyline"!==c.type&&"polygon"!==c.type&&"extent"!==c.type)return this._logWarning("unsupported geometry type for line symbol: "+c.type),null;var c="polygon"===c.type||"extent"===
c.type?"rings":"paths",m="graphic"+a.uid,f=this._getVertexOpacityAndColor(b,Float32Array,255),n=0;b.size&&this._isPropertyDriven("size")&&(n=l.getSingleSizeDriver(b.size),n=B.pt2px(n));b=this._getGraphicElevationInfo(a);return b.mode===l.ELEV_MODES.ON_THE_GROUND?this._createAsOverlay(a,c,f,n,b,m):this._createAs3DShape(a,c,f,n,b,m,a.uid)},layerPropertyChanged:function(a,b,c){if("opacity"===a)return this._isNativeLineMaterial?(b=this._material.getColor(),b[3]=this._getMaterialOpacity(),this._material.setColor(b)):
(b=this._material.getParameterValues(),b.color[3]=this._getMaterialOpacity(),this._material.setParameterValues({color:b.color})),!0;if("elevationInfo"===a){a=this._elevationInfo.mode;this._updateElevationInfo();var m=this._elevationInfo.mode;if(null==a||null==m)return!1;var f=l.ELEV_MODES;if(a===f.ON_THE_GROUND&&m===f.ON_THE_GROUND)return!0;if(a!==m&&(a===f.ON_THE_GROUND||m===f.ON_THE_GROUND))return!1;a=m===f.RELATIVE_TO_GROUND?A.perVertexElevationAligner:null;var m=this._context.elevationProvider,
f=this._context.renderCoordsHelper,n;for(n in b){var g=b[n],d=g._graphics[c];d&&(g=g.graphic,d.elevationAligner=a,d.elevationInfo.set(this._getGraphicElevationInfo(g)),A.perVertexElevationAligner(d,m,f))}return!0}return!1},_getOutlineGeometry:function(a,b){return a._outlineSegments?u.createOutlineGeometryFromSegments(b,a._outlineSegments):b},_getGeometry:function(a){a=a.geometry;"extent"===a.type&&(a=J.fromExtent(a));return a},_createAs3DShape:function(a,b,c,m,f,n,g){var d=this._getGeometry(a),e=
d.hasZ,q=this._getOutlineGeometry(d,d[b]);if(0<q.length){a=[];for(var t=[],h=[],p=E.create(),r=Array(6),d=l.getGeometryVertexData3D(q,e,d.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,f),e=d.geometryData.outlines,q=d.eleVertexData,x=d.vertexData,y=0;y<e.length;++y){var z=e[y],k=z.index,v=z.count;if(this._context.clippingExtent&&(l.computeBoundingBox(q,k,v,r),l.boundingBoxClipped(r,this._context.clippingExtent)))continue;l.chooseOrigin(x,k,v,p);l.subtractCoordinates(x,
k,v,p);z=new Float64Array(q.buffer,3*k*q.BYTES_PER_ELEMENT,3*v);k=new Float64Array(x.buffer,3*k*x.BYTES_PER_ELEMENT,3*v);k=u.createPolylineGeometry(k,z,"rings"===b,c,m);k=new L(k,n+"path"+y);k.singleUse=!0;a.push(k);t.push([this._material]);k=w.identity();w.translate(k,p,k);h.push(k)}if(0<a.length)return b=new K({geometries:a,materials:t,transformations:h,castShadow:!1,metadata:{layerId:this._context.layer.id,graphicId:g},idHint:n}),c=null,f.mode===l.ELEV_MODES.RELATIVE_TO_GROUND&&(c=A.perVertexElevationAligner),
f=new H(this,b,a,null,null,c,f),f.alignedTerrainElevation=d.terrainElevation,f}return null},_createAsOverlay:function(a,b,c,m,f,n){var g=this._getGeometry(a);this._material.setRenderPriority(this._symbolLayerOrder);var d=this._getOutlineGeometry(g,g[b]);if(0<d.length){a=[];for(var e=Array(6),q=E.create(),d=l.getGeometryVertexDataDraped(d,g.spatialReference,this._context.overlaySR),g=d.vertexData,d=d.geometryData.outlines,t=0;t<d.length;++t){var h=d[t],p=h.index,h=h.count;l.computeBoundingBox(g,p,
h,e);if(!l.boundingBoxClipped(e,this._context.clippingExtent)){l.chooseOrigin(g,p,h,q);l.subtractCoordinates(g,p,h,q);l.setZ(g,p,h,this._getDrapedZ());h=new Float64Array(g.buffer,3*p*g.BYTES_PER_ELEMENT,3*h);p=w.identity();w.translate(p,q,p);var h=u.createPolylineGeometry(h,null,"rings"===b,c,m),r=new M(h);r.material=this._material;r.center=[.5*(e[0]+e[3]),.5*(e[1]+e[4]),0];r.bsRadius=.5*Math.sqrt((e[3]-e[0])*(e[3]-e[0])+(e[4]-e[1])*(e[4]-e[1]));r.transformation=p;r.name=n;r.uniqueName=n+"#"+h.id;
a.push(r)}}return new I(this,a,null,null,e,f)}return null}})});