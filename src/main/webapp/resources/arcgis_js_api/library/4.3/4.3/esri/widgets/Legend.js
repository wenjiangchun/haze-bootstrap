// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("./Widgette ./Legend/LegendViewModel ../core/watchUtils ../core/HandleRegistry ../core/lang dojox/gfx dojo/_base/lang dojo/dom-construct dojo/dom-style dojo/dom-class dojo/i18n!./Legend/nls/Legend".split(" "),function(p,q,m,r,t,u,v,e,w,l,n){return p.createSubclass({declaredClass:"esri.widgets.Legend",baseClass:"esri-legend",constructor:function(){this._handles=new r;this._DOMByLayerId={}},postCreate:function(){this.inherited(arguments);this._createLegend()},destroy:function(){this._handles.destroy();
this._handles=null},properties:{activeLayerInfos:{aliasOf:"viewModel.activeLayerInfos"},layerInfos:{aliasOf:"viewModel.layerInfos"},basemapLegendVisible:{aliasOf:"viewModel.basemapLegendVisible"},groundLegendVisible:{aliasOf:"viewModel.groundLegendVisible"},view:{aliasOf:"viewModel.view"},viewModel:{type:q}},_createLegend:function(){var a=this._buildLegendDOM(),b=this.activeLayerInfos;b.length&&b.forEach(function(b){this._createLegendForLayer(b,a)},this);b=b.on("change",function(b){var c,k=b.added;
b.removed.forEach(function(a){(c=this._DOMByLayerId[a.layer.uid])&&this._setVisible(c,!1)},this);k.forEach(function(b){(c=this._DOMByLayerId[b.layer.uid])?this._setVisible(c,!0):this._createLegendForLayer(b,a)},this);this._sortDOMNodes(a)}.bind(this));this._handles.add(b,"activeLayerInfos-change")},_hasVisibleDOMNodes:function(){var a=this._DOMByLayerId,b=!1,c;for(c in a)if(!l.contains(a[c],"esri-hidden")){b=!0;break}return b},_isActiveLayerInfosReady:function(a){return!a.length||1===a.length&&a.getItemAt(0).updating&&
!this._hasVisibleDOMNodes()?!1:a.some(function(a){return a.ready||a.updating})},_sortDOMNodes:function(a){var b=this.activeLayerInfos,c=this.domNode,f=c.childNodes,k=[],d={},e=this.id+"_",g=this._isActiveLayerInfosReady(b);this._setVisible(a.message,!g);for(a=0;a<f.length;++a)g=f[a],g.id&&-1<g.id.indexOf(e)&&!l.contains(g,"esri-hidden")&&k.push(g);b.forEach(function(a,b){d[a.layer.uid]=b});b=k.sort(function(a,b){a=d[a.id.split(e)[1]]||0;b=d[b.id.split(e)[1]]||0;return a-b});for(a=0;a<b.length;++a)c.appendChild(b[a])},
_buildLegendDOM:function(){var a=this.domNode,b=e.create("div",{id:this.id+"_msg",className:"esri-legend__message",textContent:n.noLegend},a);return{widget:a,message:b}},_createLegendForLayer:function(a,b){var c=m.init(a,"version",function(){var c=a.layer.uid,d=this._DOMByLayerId[c];d&&!a.updating&&(delete this._DOMByLayerId[c],e.destroy(d));a.ready&&(d=this._buildLegendDOMForLayer(a,b),this._DOMByLayerId[c]=d.root,c=this._createLegendElements(a,d.layer).length&&-1!==this.activeLayerInfos.indexOf(a),
this._setVisible(d.root,c));this._sortDOMNodes(b)}.bind(this)),f=m.init(a,"tearingDown",function(b){var c=a.layer.uid;b&&(b=this._DOMByLayerId[c])&&(this._handles.remove(c),delete this._DOMByLayerId[c],e.destroy(b))}.bind(this));this._handles.add([c,f],a.layer.uid)},_buildLegendDOMForLayer:function(a,b){var c=e.create("div",{id:b.widget.id+"_"+a.layer.uid,className:"esri-legend__service esri-hidden"},b.widget);a=e.create("p",{textContent:a.title,className:"esri-legend__service-label"},c);var f=e.create("div",
{className:"esri-legend__layer"},c);return v.mixin(b,{root:c,title:a,layer:f})},_createLegendElements:function(a,b){var c=a.legendElements,f=a.layer;c.forEach(function(a){this._createLegendElement(a,b,f)},this);return c},_createLegendElement:function(a,b,c,f){var e="color-ramp"===a.type,d="opacity-ramp"===a.type,h="size-ramp"===a.type,g=this._buildDOMForElement(b,a.title,e||d,f);"symbol-table"===a.type||h?a.infos.forEach(function(b){b.type?this._createLegendElement(b,g.body,c,!0):this._buildDOMForElementInfo(b,
g,c,h,a.legendType)},this):(e||d)&&this._buildRampDOM(a.infos,g.body,a.overlayColor,d)},_buildDOMForElement:function(a,b,c,f){"string"!==typeof b&&b&&(c=this._getTitle(b,c),b=b.title?b.title+" ("+c+")":c);f=e.create("div",{className:f?"esri-legend__layer-child-table":"esri-legend__layer-table"},a);b=b?e.create("div",{className:"esri-legend__layer-caption",textContent:b},f):null;c=e.create("div",{className:"esri-legend__layer-body"},f);return{layer:a,table:f,caption:b,body:c}},_isImageryStretchedLegend:function(a,
b){return b&&"Stretched"===b&&10.3<=a.version&&"esri.layers.ImageryLayer"===a.declaredClass},_buildDOMForElementInfo:function(a,b,c,f,k){var d,h;this._isImageryStretchedLegend(c,k)?(d="esri-legend__imagery-layer-info--stretched esri-legend__layer-cell esri-legend__layer-cell--info",h="esri-legend__imagery-layer-cell--stretched"):(d="esri-legend__layer-cell esri-legend__layer-cell--info",h=f?"esri-legend__layer-cell esri-legend__layer-cell--symbols esri-legend__size-ramp":"esri-legend__layer-cell esri-legend__layer-cell--symbols");
f=e.create("div",{className:"esri-legend__layer-row"},b.body);h=e.create("div",{className:h},f);var g=!1;a.symbol&&a.preview?(h.appendChild(a.preview),g=!0):a.src&&(g=this._drawImage(h,a,c,k));g?(l.toggle(h.firstChild,"esri-legend__symbol",!this._isImageryStretchedLegend(c,k)),e.create("div",{className:d},f).textContent=a.label||""):e.destroy(b.table)},_drawImage:function(a,b,c,f){var k=b.src,d=b.opacity,h=b.width;b=b.height;if(!k)return!1;a=e.create("img",{src:k,border:0},a);null!=h&&null!=b&&(a.width=
h,a.height=b);a.style.opacity=null!=d?d:c.opacity;l.toggle(a,"esri-legend__imagery-layer-image--stretched",this._isImageryStretchedLegend(c,f));return!0},_buildRampDOM:function(a,b,c,f){var k=a.length-1,d,h,g;b=e.create("div",{className:"esri-legend__layer-row"},b);d=e.create("div",{className:"esri-legend__layer-cell esri-legend__layer-cell--symbols",style:"width:24px"},b);d=e.create("div",{className:"esri-legend__ramps"},d);d=e.create("div",{className:"esri-legend__color-ramp "+(f?"esri-legend__opacity-ramp":
"")},d);f=e.create("div",{className:"esri-legend__layer-cell esri-legend__layer-cell--info"},b);b=2<k?25*k:50;w.set(d,"height",b+"px");d=u.createSurface(d,"100%",b);try{a.forEach(function(a,b){a.offset=b/k}),g=d.createRect({x:0,y:0,width:"100%",height:b}),g.setFill({type:"linear",x1:0,y1:0,x2:0,y2:b,colors:a}).setStroke(null),c&&0<c.a&&d.createRect({width:"100%",height:b}).setFill(c).setStroke(null)}catch(x){d.clear(),d.destroy()}h=e.create("div",{className:"esri-legend__ramp-labels",style:{height:b+
"px"}},f);a.forEach(function(a){a.label&&e.create("div",{className:"esri-legend__ramp-label",innerHTML:a.label},h)})},_getTitle:function(a,b){return(b=b?a.ratioPercentTotal&&"showRatioPercentTotal"||a.ratioPercent&&"showRatioPercent"||a.ratio&&"showRatio"||a.normField&&"showNormField"||a.field&&"showField"||null:a.normField&&"showNormField"||(a.normByPct?"showNormPct":null)||a.field&&"showField"||null)?t.substitute({field:a.field,normField:a.normField},n[b]):null},_setVisible:function(a,b){var c=
l.contains(a,"esri-hidden");b&&c?l.remove(a,"esri-hidden"):b||c||l.add(a,"esri-hidden")}})});