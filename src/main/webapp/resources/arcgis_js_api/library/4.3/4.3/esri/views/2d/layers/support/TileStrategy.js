// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../core/LRUCache","./TileKey"],function(A,B,t,z){function l(g,a){g["delete"](a)}var p=[],m=[null,null],q=[],x=new t(30),g=new z(0,0,0,0);return function(){function e(a){this._tilesToRender=new Map;this._requests=new Map;this._updates=new Map;this._prevResolution=Number.POSITIVE_INFINITY;this._isStationary=!1;this.cachePolicy="keep";this.tiles=new Map;this.container=a.container;this.tileInfoView=a.tileInfoView;this.requestUpdate=a.requestUpdate;this.fetchTile=
a.fetchTile;a.cachePolicy&&(this.cachePolicy=a.cachePolicy)}e.prototype.destroy=function(){this._requests&&(this._requests.forEach(function(a){a.isFulfilled()||a.cancel()}),this._tilesToRender=this._requests=null)};Object.defineProperty(e.prototype,"updating",{get:function(){return 0!==this._requests.size||0!==this._updates.size},enumerable:!0,configurable:!0});e.prototype.update=function(a){var c=this,b=this.tiles,h=this._tilesToRender,d=this._requests,k=this._updates,e=this.tileInfoView.getTileCoverage(a.state);
if(e){var m=e.lodInfo.level,y=a.state.resolution>this._prevResolution;this._createCoverageList(p,e);h.clear();for(var u=0,v=0;v<p.length;v++){var f=p[v];if(b.has(f)){var n=b.get(f);h.set(f,n);u++;if(n.attached)continue}else x.has(f)?u++:d.has(f)||this._getTile(f,a);y||this._addParentTile(f,h)}var t=u===p.length;!this._isStationary&&a.stationary&&this.requestUpdate();this._isStationary=a.stationary;var r=[],w=[];b.forEach(function(a,b){g.set(b);h.has(b)||(!y&&t||!c.tileInfoView.intersects(e,g)?"purge"===
c.cachePolicy?r.push(b):(g.level>m||!c.tileInfoView.intersects(e,g))&&r.push(b):w.push(b))});for(n=0;n<w.length;n++)f=w[n],h.set(f,b.get(f));for(a=0;a<r.length;a++)f=r[a],k.has(f)&&(k.get(f).cancel(),l(k,f)),n=b.get(f),n.dispose(),l(b,f);this.container.removeAllTiles();h.forEach(function(a){return c.container.addTile(a)});d.forEach(function(a,b){g.set(b);if(g.level>m||!c.tileInfoView.intersects(e,g))a.cancel(),q.push(b)});for(b=0;b<q.length;b++)f=q[b],l(d,f);q.length=0}};e.prototype.updateTiles=function(a,
c){var b=this;this._tilesToRender.forEach(function(h,d){h.attached&&(h=a(h,c))&&(b._updates.has(d)&&(b._updates.get(d).cancel(),l(b._updates,d)),h.then(function(a){l(b._updates,d);b._tilesToRender.has(d)&&b._tilesToRender.set(d,a);b.requestUpdate()}).otherwise(function(a){l(b._updates,d);b.requestUpdate();if(a&&"cancel"!==a.dojoType)throw a;}),b._updates.set(d,h))})};e.prototype._addParentTile=function(a,c){this._getAvailableParentTile(m,a);m[0]&&!c.has(m[0])&&c.set(m[0],m[1])};e.prototype._getTile=
function(a,c){var b=this;c=this.fetchTile(a,c).then(function(c){g.set(a);b.tileInfoView.getTileCoords(c.coords,g);c.resolution=b.tileInfoView.getTileResolution(g);d=b.tileInfoView.tileInfo.size;c.width=d[0];c.height=d[1];b.tiles.set(a,c);l(b._requests,a);b.requestUpdate();var d}).otherwise(function(c){c&&"no data"===c.message&&x.insert(a,a);l(b._requests,a)});this._requests.set(a,c)};e.prototype._getAvailableParentTile=function(a,c){a[0]=null;for(a[1]=null;c=this.tileInfoView.getTileParentId(c);)if(this.tiles.has(c)){a[0]=
c;a[1]=this.tiles.get(c);break}return a};e.prototype._createCoverageList=function(a,c){a.length=0;var b=c.spans;c=c.lodInfo;var e=c.level;if(0!==b.length)for(var d=0;d<b.length;d++)for(var k=b[d],l=k.row,m=k.colTo,k=k.colFrom;k<=m;k++)g.set(e,l,c.normalizeCol(k),c.getWorldForColumn(k)),a.push(g.id)};return e}()});