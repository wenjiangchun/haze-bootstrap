// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("../../../core/HandleRegistry ../../../core/promiseUtils ../../layers/LayerView ../../../geometry/Extent ../lib/glMatrix ../webgl-engine/Stage ../webgl-engine/lib/Texture ../webgl-engine/lib/RenderGeometry ../webgl-engine/lib/GeometryData ../webgl-engine/lib/GeometryUtil ../webgl-engine/materials/Material ../webgl-engine/lib/Util".split(" "),function(y,z,A,B,C,f,D,E,F,G,H,g){var q=g.assert,I=C.mat4d,m=g.VertexAttrConstants,L=function(){var b=new Float32Array([0,0,1]);return function(a,d,e){var c=
[a[1]-d[1],a[3]-a[1],d[3]-a[3],123456],u=[a[0]-d[0],a[2]-a[0],d[2]-a[2],123456],J=d[2]-d[0],K=d[3]-d[1],h=0<u[0]&&0<u[2]?3:2;a=0<c[0]&&0<c[2]?3:2;var n=(a+1)*(h+1),k=new Float32Array(3*n),n=new Float32Array(2*n);a=new Uint32Array(6*(a*h-1));for(var f=0,g=0,q=0,l=0,p=0,r=0;4>r;r++){var w=c[r];if(!(0>=w)){for(var v=0,t=0;4>t;t++){var x=u[t];0>=x||(k[g++]=d[0]+v,k[g++]=d[1]+f,k[g++]=e,n[q++]=v/J,n[q++]=f/K,3>t&&3>r&&(1!==t||1!==r)&&(a[p++]=l,a[p++]=l+1,a[p++]=l+h+1,a[p++]=l+1,a[p++]=l+h+2,a[p++]=l+h+
1),l++,v+=x)}f+=w}}d={};d[m.POSITION]={size:3,data:k};d[m.NORMAL]={size:3,data:b};d[m.UV0]={size:2,data:n};e={};c=new Uint32Array(a.length);for(k=0;k<c.length;k++)c[k]=0;e[m.POSITION]=a;e[m.NORMAL]=c;e[m.UV0]=a;return new F(d,e)}}();return A.createSubclass({declaredClass:"esri.views.3d.layers.ImageLayerView3D",properties:{suspended:{dependsOn:["view.scale","layer.minScale","layer.maxScale"]}},constructor:function(){this._extents=[];this._images=[];this._handles=new y},initialize:function(){this.drawingOrder=
this.view.getDrawingOrder(this.layer.uid);this._handles.add(this.watch("suspended",function(b){if(b)this.clear(),this.emit("draped-data-change");else{b=this._extents.length;for(var a=0;a<b;a++)this._fetch(a)}}.bind(this)));this._handles.add([this.watch("fullOpacity",this._opacityChangeHandler.bind(this)),this.layer.watch("exportImageParameters.version",this._layerExportParametersChangeHandler.bind(this)),this.layer.on("redraw",this._layerRedrawHandler.bind(this))],"layer")},destroy:function(){this.clear();
this._handles.destroy()},_handles:null,_images:null,supportsDraping:!0,hasDraped:!0,drawingOrder:0,_drawingOrderSetter:function(b){if(b!==this._get("drawingOrder")){this._set("drawingOrder",b);var a={};this._images.forEach(function(d){d&&d.material&&(d.material.setRenderPriority(b),a[d.material.getId()]=!0)});g.objectEmpty(a)||(this.view._stage.getTextureGraphicsRenderer().updateRenderOrder(a),this.emit("draped-data-change"))}},canResume:function(){if(!this.inherited(arguments))return!1;var b=this.layer.minScale,
a=this.layer.maxScale;if(0<b||0<a){var d=this.view.scale;if(d<a||0<b&&d>b)return!1}return!0},setDrapingExtent:function(b,a,d,e){var c=(a[2]-a[0])/(a[3]-a[1]);this._extents[b]={extent:a,spatialReference:d,imageSize:1.0001<c?[e,e/c]:.9999>c?[e*c,e]:[e,e]};this.suspended||this._fetch(b)},getGraphicsFromStageObject:function(b,a){return z.reject()},clear:function(){for(var b in this._images)this._clearImage(b)},_fetch:function(b){var a=this._extents[b],d=a.extent,e=new B(d[0],d[1],d[2],d[3],a.spatialReference),
c=this._images[b];c||(c=this._images[b]={texture:null,material:null,rendergeometry:null,canvas:null,pixelData:null,worldExtent:d,loading:!0});c.promise&&c.promise.cancel();c.loading=!0;c.promise=this.layer.fetchImage({extent:e,width:a.imageSize[0],height:a.imageSize[1]}).then(function(a){c.canvas=document.createElement("canvas");c.pixelData=a.pixelData;c.worldExtent=d;a=c.canvas;var e=a.getContext("2d"),f=this.layer.applyFilter(c.pixelData).pixelBlock;a.width=f.width;a.height=f.height;var h=e.createImageData(f.width,
f.height),f=f.getAsRGBA();h.data.set(f);e.putImageData(h,0,0);this._createStageObjects(b,a);0===b&&this._images[1]&&this._images[1].rendergeometry&&this._createStageObjects(1,null);this._evaluateUpdatingState();this.emit("draped-data-change")}.bind(this)).always(function(){c.loading=!1;c.promise=null})},_updateImage:function(b){var a=this._images[b];if(a&&a.pixelData){var d=a.canvas,e=d.getContext("2d"),c=this.layer.applyFilter(a.pixelData).pixelBlock,f=e.createImageData(c.width,c.height),g=c.getAsRGBA();
d.width=c.width;d.height=c.height;f.data.set(g);e.putImageData(f,0,0);this._createStageObjects(b,a.canvas)}this.emit("draped-data-change")},_clearImage:function(b){b=this._images[b];var a=this.view._stage;b&&(b.rendergeometry&&a.getTextureGraphicsRenderer().removeRenderGeometries([b.rendergeometry]),b.texture&&a.remove(f.ModelContentType.TEXTURE,b.texture.getId()),b.material&&a.remove(f.ModelContentType.MATERIAL,b.material.getId()),b.rendergeometry=b.texture=b.material=b.pixelData=b.canvas=b.loading=
!1)},_layerRedrawHandler:function(){for(var b=0;b<this._images.length;b++)this._updateImage(b)},_layerExportParametersChangeHandler:function(){for(var b=0;b<this._extents.length;b++)this._extents[b]&&this._fetch(b)},_opacityChangeHandler:function(b){this._images.forEach(function(a){a&&a.material&&a.material.setParameterValues({opacity:b})}.bind(this));this.emit("draped-data-change")},_evaluateUpdatingState:function(){this.notifyChange("updating")},isUpdating:function(){var b=!1,a;for(a in this._images)if(this._images[a].loading){b=
!0;break}return b},_createStageObjects:function(b,a){var d=this.view._stage,e=d.getTextureGraphicsRenderer(),c=this._images[b];a?(c.texture&&d.remove(f.ModelContentType.TEXTURE,c.texture.getId()),c.texture=new D(a,"imageLayer",{width:a.width,height:a.height}),d.add(f.ModelContentType.TEXTURE,c.texture)):q(c.texture);c.material?a&&c.material.setParameterValues({textureId:c.texture.getId()}):(c.material=new H({ambient:[1,1,1],diffuse:[0,0,0],transparent:!0,opacity:this.fullOpacity,textureId:c.texture.getId()},
"imageLayer"),c.material.setRenderPriority(this.drawingOrder),d.add(f.ModelContentType.MATERIAL,c.material));if(0===b)b=c.worldExtent,b=G.createSquareGeometry([[b[0],b[1],-1],[b[2],b[1],-1],[b[2],b[3],-1],[b[0],b[3],-1]]);else{q(1===b);b=this._images[0].worldExtent;if(!b)return;b=L(b,c.worldExtent,-1)}a=new E(b);a.material=c.material;a.origin={vec3:[0,0,0],id:"0_0"};a.transformation=I.identity();a.name="imageLayer";a.uniqueName="imageLayer#"+b.id;e.addRenderGeometries([a]);c.rendergeometry&&e.removeRenderGeometries([c.rendergeometry]);
c.rendergeometry=a}})});