// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("../../core/Accessor ../../core/Error ../../core/HandleRegistry ../../core/lang ../../core/urlUtils ../../core/promiseUtils ../../core/watchUtils ../../request ../../tasks/support/StatisticDefinition ../../tasks/support/Query ../../tasks/QueryTask dojo/_base/lang dojo/promise/all dojo/i18n!dojo/cldr/nls/number".split(" "),function(C,v,D,k,E,r,x,y,F,z,G,q,w,A){var H=/\'/g,I=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/ig,J=/(\{([^\{\r\n]+)\})/g,m={attachments:"attachments",fields:"fields",media:"media",
text:"text"},t={"short-date":"(datePattern: 'M/d/y', selector: 'date')","short-date-le":"(datePattern: 'd/M/y', selector: 'date')","long-month-day-year":"(datePattern: 'MMMM d, y', selector: 'date')","day-short-month-year":"(datePattern: 'd MMM y', selector: 'date')","long-date":"(datePattern: 'EEEE, MMMM d, y', selector: 'date')","short-date-short-time":"(datePattern: 'M/d/y', timePattern: 'h:mm a', selector: 'date and time')","short-date-le-short-time":"(datePattern: 'd/M/y', timePattern: 'h:mm a', selector: 'date and time')",
"short-date-short-time-24":"(datePattern: 'M/d/y', timePattern: 'H:mm', selector: 'date and time')","short-date-le-short-time-24":"(datePattern: 'd/M/y', timePattern: 'H:mm', selector: 'date and time')","short-date-long-time":"(datePattern: 'M/d/y', timePattern: 'h:mm:ss a', selector: 'date and time')","short-date-le-long-time":"(datePattern: 'd/M/y', timePattern: 'h:mm:ss a', selector: 'date and time')","short-date-long-time-24":"(datePattern: 'M/d/y', timePattern: 'H:mm:ss', selector: 'date and time')",
"short-date-le-long-time-24":"(datePattern: 'd/M/y', timePattern: 'H:mm:ss', selector: 'date and time')","long-month-year":"(datePattern: 'MMMM y', selector: 'date')","short-month-year":"(datePattern: 'MMM y', selector: 'date')",year:"(datePattern: 'y', selector: 'date')"};return C.createSubclass({declaredClass:"esri.widgets.Popup.PopupRendererViewModel",properties:{content:{readOnly:!0},contentEnabled:!0,contentTypes:{readOnly:!0},formattedAttributes:{readOnly:!0},graphic:{},title:{readOnly:!0},
waitingForContent:{readOnly:!0}},constructor:function(){this._handles=new D},initialize:function(){this._handles.add([x.init(this,"graphic",function(a){this._updateGraphic(a,this.contentEnabled)}.bind(this)),x.init(this,"contentEnabled",function(a){this._updateGraphic(this.graphic,a)}.bind(this))])},destroy:function(){this._handles.destroy();this._handles=null;this._clearRelatedInfo();this._cancelPromises();this.graphic=null;this._set("title",null);this._set("content",null);this._set("waitingForContent",
null)},content:null,contentEnabled:!0,contentTypes:m,formattedAttributes:null,graphic:null,title:"",waitingForContent:!1,_handles:null,_contentPromise:null,_contentPromises:null,_relatedRecordsPromise:null,_relatedRecordsQueryPromises:[],_relatedRecordsLayerPromises:[],_relatedLayersInfo:null,_relatedInfo:null,_dateFormats:t,_addValuesToHref:function(a,b,c,d){b=this._trimString(b);return k.substitute(b&&0===b.indexOf("${")?c:d,a)},_cancelPromises:function(){this._contentPromises&&(this._contentPromises.forEach(function(a){a.cancel()},
this),this._contentPromises=null);this._contentPromise&&(this._contentPromise.cancel(),this._contentPromise=null);this._relatedRecordsQueryPromises.forEach(function(a){a.cancel()});this._relatedRecordsQueryPromises.length=0;this._relatedRecordsLayerPromises.length&&(this._relatedRecordsLayerPromises.forEach(function(a){a.cancel()}),this._relatedRecordsLayerPromises.length=0);this._relatedRecordsPromise&&(this._relatedRecordsPromise.cancel(),this._relatedRecordsPromise=null)},_clearRelatedInfo:function(){this._relatedInfo=
this._relatedLayersInfo=null},_compileContent:function(a,b){var c=a.content;if("function"===typeof c&&(c=c.call(null,{graphic:a.graphic}))&&c.nodeName)return c;if("string"===typeof c)return this._compileText(a,{type:m.text,text:c}).text;if(Array.isArray(c))return c.map(function(c,e){e=(e=b&&b[e])&&e.value;switch(c.type){case m.attachments:return this._proxyAttachments(c,e);case m.fields:return c;case m.media:return this._compileMedia(a,c);case m.text:return this._compileText(a,c)}},this);if(c)try{throw new v(this.declaredClass+
"::invalid content type.");}catch(d){console.warn(d.stack)}},_compileMedia:function(a,b){b=q.clone(b);var c=b.mediaInfos,d=a.attributes,e=a.layer,f=this.formattedAttributes.global,h=a.substOptions,g,n;c&&(g=[],c.forEach(function(b){n=0;var c=b.value;switch(b.type){case "image":var l=c.sourceURL,l=l&&this._trimString(k.substitute(d,this._fixTokens(l,e)));n=!!l;break;case "pie-chart":case "line-chart":case "column-chart":case "bar-chart":var m,l=c.normalizeField;c.fields=c.fields.map(function(a){return(m=
this._getLayerFieldInfo(e,a))?m.name:a},this);l&&(m=this._getLayerFieldInfo(e,l),c.normalizeField=m?m.name:l);n=c.fields.some(function(a){return k.isDefined(d[a])||-1!==a.indexOf("relationships/")&&this._relatedInfo},this);break;default:return}if(n){b=q.clone(b);var c=b.value,l=b.title?this._processFieldsInLinks(this._fixTokens(b.title,e),d):"",B=b.caption?this._processFieldsInLinks(this._fixTokens(b.caption,e),d):"";b.title=l?this._trimString(k.substitute(f,l,h)):"";b.caption=B?this._trimString(k.substitute(f,
B,h)):"";if("image"===b.type)c.sourceURL=k.substitute(d,this._fixTokens(c.sourceURL,e)),c.linkURL&&(c.linkURL=this._trimString(k.substitute(d,this._fixTokens(c.linkURL,e))));else{var p,u=(l=a.template)&&l.fieldInfos;c.fields.forEach(function(a,b){if(-1!==a.indexOf("relationships/"))a=this._getRelatedChartInfos(e,u,a,c,d,h),Array.isArray(a)?c.fields=a:c.fields[b]=a;else{var f=d[a],f=void 0===f?null:f;p=d[c.normalizeField]||0;f&&p&&(f/=p);var l=u&&this._getFieldInfo(u,a);c.fields[b]={y:f,tooltip:(l&&
l.label||a)+":"+this._formatValue(f,{fieldInfos:u,fieldName:a,layer:e,substOptions:h,preventPlacesFormatting:!!p})}}},this)}g.push(b)}},this));b.mediaInfos=g;return b},_compileText:function(a,b){if((b=q.clone(b))&&b.text){var c=a.attributes,d=this.formattedAttributes.global,e=a.substOptions;a=this._processFieldsInLinks(this._fixTokens(b.text,a.layer),c);b.text=this._trimString(k.substitute(d,a,e))}return b},_compileTitle:function(a){var b="",c=a.title,d=a.layer,e=a.attributes,f=a.substOptions,h=this.formattedAttributes.global;
c&&("function"===typeof c&&(c=c.call(null,{graphic:a.graphic})),"string"===typeof c&&-1===c.indexOf("{relationships/")&&(a=this._processFieldsInLinks(this._fixTokens(c,d),e),b=this._trimString(k.substitute(h,a,f))));return b},_createGraphicInfo:function(a,b){var c=a.getEffectivePopupTemplate(),d=c&&c.title,e=c&&c.content,f=a.layer,h=f&&f._getDateOpts&&f._getDateOpts().properties,g=q.clone(a.attributes)||{};return{graphic:a,template:c,title:d,content:e,contentEnabled:b,layer:f,attributes:g,properties:h,
substOptions:{dateFormat:{properties:h,formatter:"DateFormat"+t["short-date-short-time"]}}}},_fixTokens:function(a,b){return a.replace(J,function(a,d,e){return(a=this._getLayerFieldInfo(b,e))?"{"+a.name+"}":d}.bind(this))},_encodeAttributes:function(a){var b=q.clone(a)||{};Object.keys(b).forEach(function(a){var c=b[a];"string"===typeof c&&(c=encodeURIComponent(c).replace(H,"\x26apos;"),b[a]=c)});return b},_formatAttributesToFieldInfos:function(a,b,c,d,e){a.forEach(function(f){var h=f.fieldName,g=
this._getLayerFieldInfo(b,h);g&&(h=f.fieldName=g.name);e[h]=this._formatValue(e[h],{fieldInfos:a,fieldName:h,layer:b,substOptions:c});d&&f.format&&f.format.dateFormat&&(f=d.indexOf(h),-1<f&&d.splice(f,1))},this)},_formatAttributes:function(a,b,c,d,e,f){var h=q.clone(e);this._relatedInfo&&Object.keys(this._relatedInfo).forEach(function(a){var b=this._relatedInfo[a];a=this._relatedLayersInfo[a];b&&(b.relatedFeatures.forEach(this._relatedFeaturesAttributes.bind(this,a,e,h)),b.relatedStatsFeatures.forEach(this._relatedStatsAttributes.bind(this,
a,e,h)))},this);a&&this._formatAttributesToFieldInfos(a,b,c,d,h);if(b){var g=b.typeIdField;Object.keys(e).forEach(function(a){if(-1===a.indexOf("relationships/")){var c=e[a];if(k.isDefined(c)){var d=this._getDomainName(b,f,a,c);k.isDefined(d)?h[a]=d:a===g&&(c=this._getTypeName(b,f,c),k.isDefined(c)&&(h[a]=c))}}},this)}return h},_formatValue:function(a,b){var c=b.fieldInfos,d=b.fieldName,e=b.substOptions,c=c&&this._getFieldInfo(c,d),f=q.clone(c),c=b.preventPlacesFormatting;(b=this._getLayerFieldInfo(b.layer,
d))&&"date"===b.type&&(b=f.format||{},b.dateFormat=b.dateFormat||"short-date-short-time",f.format=b);b=f&&f.format;d="number"===typeof a&&e.dateFormat.properties&&-1===e.dateFormat.properties.indexOf(d)&&(!b||!b.dateFormat);if(!k.isDefined(a)||!f||!k.isDefined(b))return d?this._forceLTR(a):a;var h="",g=[],f=b.hasOwnProperty("places")||b.hasOwnProperty("digitSeparator"),n=b.hasOwnProperty("digitSeparator")?b.digitSeparator:!0;if(f)h="NumberFormat",k.isDefined(b.places)&&(!c||0<b.places)&&(g.push("places: "+
Number(b.places)),h+="("+g.join(",")+")");else if(b.dateFormat)h="DateFormat"+t[b.dateFormat]||t["short-date-short-time"];else return d?this._forceLTR(a):a;a=k.substitute({myKey:a},"{myKey:"+h+"}",e)||"";f&&!n&&A.group&&(a=a.replace(new RegExp("\\"+A.group,"g"),""));return d?this._forceLTR(a):a},_forceLTR:function(a){return"\x26lrm;"+a},_getDomainName:function(a,b,c,d){return(a=a.getDomain&&a.getDomain(c,{feature:b}))&&a.codedValues?a.getName(d):null},_getFieldInfo:function(a,b){b=b.toLowerCase();
for(var c,d=0;d<a.length;d++){var e=a[d];if(e.fieldName&&e.fieldName.toLowerCase()===b){c=e;break}}return c},_getLayerFieldInfo:function(a,b){return a&&a.getField?a.getField(b):null},_getTypeName:function(a,b){return(a=a.getType&&a.getType(b))&&a.name},_processFieldsInLinks:function(a,b){var c=this._encodeAttributes(b);a&&(a=a.replace(I,function(a,e){return this._addValuesToHref(a,e,b,c)}.bind(this)));return a},_proxyAttachments:function(a,b){a=q.clone(a);b&&!(b instanceof v)&&b.attachmentInfos&&
b.attachmentInfos.length&&(b=b.attachmentInfos.map(function(a){a.url=E.addProxy(a.url);return a},this),a.attachmentInfos=b);return a},_queryAttachments:function(a){var b=a.layer,c=a.attributes;a=b&&b.objectIdField;c=c&&a&&c[a];if(a&&b.hasAttachments&&c)return this._queryAttachmentInfos(b,c)},_queryAttachmentInfos:function(a,b){var c=a.url+"/"+a.layerId+"/"+b+"/attachments",d=a.token||"";return y(c,{query:{f:"json",token:d},callbackParamName:"callback"}).then(function(a){a=a.data;a.attachmentInfos.forEach(function(a){a.url=
c+"/"+a.id;d&&(a.url+="?token\x3d"+d);a.objectId=b});return a})},_queryContent:function(a){var b=a.template,b=b&&b.content;if(!b||"string"===typeof b||"function"===typeof b)return r.resolve();if(!Array.isArray(b))return r.reject(new v(this.declaredClass+"::Invalid content type."));var c=[],d={};b.forEach(function(b,f){b.type===m.attachments&&(b=this._queryAttachments(a))&&(d[f]=b,c.push(b))},this);this._contentPromises=c;return 0===c.length?r.resolve():r.eachAlways(d).always(function(a){this._contentPromises=
null;return a}.bind(this))},_trimString:function(a){return(a||"").trim()},_updateContent:function(a){if(a.contentEnabled){var b=this._queryContent(a).then(function(b){this._set("content",this._compileContent(a,b))}.bind(this),function(a){console.log(this.declaredClass+"::error loading template",a)}.bind(this)).always(function(){this._contentPromise=null}.bind(this));return this._contentPromise=b}return r.resolve()},_createFormattedAttributes:function(a){var b=a.graphic,c=a.attributes,d=a.layer,e=
a.template,f=a.substOptions,h=a.properties,g={global:this._formatAttributes(e&&e.fieldInfos,d,f,h,c,b),content:[]};a=e&&e.content;Array.isArray(a)&&a.forEach(function(a,e){a.type===m.fields&&a.fieldInfos&&(g.content[e]=this._formatAttributes(a.fieldInfos,d,f,h,c,b))},this);return g},_updateGraphic:function(a,b){if(this._handles&&(this._clearRelatedInfo(),this._cancelPromises(),this._set("title",""),this._set("content",null),this._set("formattedAttributes",null),this._set("waitingForContent",!1),a)){this._set("waitingForContent",
!0);var c=this._createGraphicInfo(a,b);this._relatedRecordsPromise=this._checkForRelatedRecords(c).then(function(){this._set("formattedAttributes",this._createFormattedAttributes(c));this._set("title",this._compileTitle(c));return this._updateContent(c)}.bind(this)).always(function(){this._relatedRecordsPromise=null;this._relatedRecordsLayerPromises.length=0;this._relatedRecordsQueryPromises.length=0;this._set("waitingForContent",!1)}.bind(this))}},_getAllFieldInfos:function(a){var b=[],c=a.template,
d=c&&c.fieldInfos;a=a.contentEnabled;d&&(b=b.concat(d));a&&(c=c&&c.content,Array.isArray(c)&&c.forEach(function(a){b=b.concat(a&&a.fieldInfos)},this));return b},_checkForRelatedRecords:function(a){var b=this._getAllFieldInfos(a).filter(function(a){return a&&a.fieldName&&-1!==a.fieldName.indexOf("relationships/")},this);return a.layer&&b&&0<b.length?this._getRelatedRecords({graphic:a.graphic,fieldsInfo:b}):r.resolve()},_relatedFeaturesAttributes:function(a,b,c,d){Object.keys(d.attributes).forEach(function(e){if("esriRelCardinalityOneToOne"===
a.relation.cardinality){var f=this._toRelatedFieldName([a.relation.id,e]);b[f]=c[f]=d.attributes[e]}},this)},_relatedStatsAttributes:function(a,b,c,d){Object.keys(d.attributes).forEach(function(e){var f=this._toRelatedFieldName([a.relation.id,e]);b[f]=c[f]=d.attributes[e]},this)},_getRelatedChartInfos:function(a,b,c,d,e,f){var h,g,n,l,k,m;h=[];m=this._fromRelatedFieldName(c);k=m[0];g=this._relatedInfo[k];k=this._relatedLayersInfo[k];g&&g.relatedFeatures.forEach(function(g){var k=g.attributes,p;Object.keys(k).forEach(function(g){if(g===
m[1]){p={};l=k[g];d.normalizeField&&(n=-1!==d.normalizeField.indexOf("relationships/")?k[this._fromRelatedFieldName(d.normalizeField)[1]]:e[d.normalizeField]);l&&n&&(l/=n);if(d.tooltipField)if(-1!==d.tooltipField.indexOf("relationships/"))g=this._fromRelatedFieldName(d.tooltipField)[1],g=k[g],p.tooltip=g+": "+this._formatValue(l,{fieldInfos:b,fieldName:g,layer:a,substOptions:f,preventPlacesFormatting:!!n});else{if(g=this._getLayerFieldInfo(a,c))c=g.name;p.tooltip=c+": "+this._formatValue(l,{fieldInfos:b,
fieldName:d.tooltipField,layer:a,substOptions:f,preventPlacesFormatting:!!n})}else p.tooltip=l;p.y=l;h.push(p)}},this)},this);return"esriRelCardinalityOneToMany"===k.relation.cardinality||"esriRelCardinalityManyToMany"===k.relation.cardinality?h:h[0]},_getRelatedRecords:function(a){var b=a.graphic;return this._relatedLayersInfo?this._queryRelatedLayers(b).then(function(a){this._setRelatedRecords(a);return a}.bind(this)):this._getRelatedLayersInfo(a).then(function(a){Object.keys(a).forEach(function(b){a[b]&&
(this._relatedLayersInfo[b].relatedLayerInfo=a[b].data)},this);return this._queryRelatedLayers(b).then(function(a){this._setRelatedRecords(a);return a}.bind(this))}.bind(this))},_getRelatedLayersInfo:function(a){var b=a.fieldsInfo,c,d={};c=a.graphic.layer;this._relatedLayersInfo||(this._relatedLayersInfo={});b.forEach(function(a){var b,d,e;b=this._fromRelatedFieldName(a.fieldName);d=b[0];b=b[1];if(d){if(!this._relatedLayersInfo[d]){var k=c&&c.relationships;k&&k.some(function(a){if(a.id==d)return e=
a,!0});e&&(this._relatedLayersInfo[d]={relation:e,relatedFields:[],outStatistics:[]})}this._relatedLayersInfo[d]&&(this._relatedLayersInfo[d].relatedFields.push(b),a.statisticType&&(a=new F({statisticType:a.statisticType,onStatisticField:b,outStatisticFieldName:b}),this._relatedLayersInfo[d].outStatistics.push(a)))}},this);Object.keys(this._relatedLayersInfo).forEach(function(a){var b;this._relatedLayersInfo[a]&&(b=this._relatedLayersInfo[a].relation,b=c.url+"/"+b.relatedTableId,this._relatedLayersInfo[a].relatedLayerUrl=
b,d[a]=y(b,{query:{f:"json"},callbackParamName:"callback"}))},this);Object.keys(d).forEach(function(a){this._relatedRecordsLayerPromises.push(d[a])},this);return w(d)},_queryRelatedLayers:function(a){var b={};Object.keys(this._relatedLayersInfo).forEach(function(c){b[c]=this._queryRelatedLayer({graphic:a,relatedInfo:this._relatedLayersInfo[c]})},this);return w(b)},_queryRelatedLayer:function(a){var b,c,d,e,f,h,g,k,l;b=a.graphic;c=b.layer.layerId;g=a.relatedInfo;a=g.relatedLayerInfo;k=g.relatedLayerUrl;
l=g.relation;a&&a.relationships&&a.relationships.some(function(a){if(a.relatedTableId===parseInt(c,10))return d=a,!0});d&&(a.fields.some(function(a){if(a.name===d.keyField)return e=-1!==["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"].indexOf(a.type)?"number":"string",!0}),f="string"===e?d.keyField+"\x3d'"+b.attributes[l.keyField]+"'":d.keyField+"\x3d"+b.attributes[l.keyField],f=new z({where:f,outFields:g.relatedFields}),g.outStatistics&&0<g.outStatistics.length&&
a.supportsStatistics&&(h=new z({where:f.where,outFields:f.outFields,outStatistics:g.outStatistics})),a=new G({url:k}),f=[a.execute(f)],h&&f.push(a.execute(h)));this._relatedRecordsQueryPromises=this._relatedRecordsQueryPromises.concat(f);return w(f)},_setRelatedRecords:function(a){this._relatedInfo=[];Object.keys(a).forEach(function(b){if(a[b]){var c=a[b];this._relatedInfo[b]={relatedFeatures:c[0].features};k.isDefined(c[1])&&(this._relatedInfo[b].relatedStatsFeatures=c[1].features)}},this)},_fromRelatedFieldName:function(a){return-1!==
a.indexOf("relationships/")?a.split("/").slice(1):[]},_toRelatedFieldName:function(a){return a&&0<a.length?"relationships/"+a[0]+"/"+a[1]:""}})});