// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define(["require","exports"],function(p,q){function h(b){var a=!1;b.labelingInfo&&(a=a||b.labelingInfo.some(function(a){return a&&n(a.minScale,a.maxScale)}));return a=a||n(b.minScale,b.maxScale)}function n(b,a){return null!==b&&0<b&&8E7>b||1E3<a}return function(){function b(){this._scaleRangeActive=!1;this.layerScaleRangeVisibilityDirty=this.layerScaleRangeVisibility=!0;this.layerScaleRangeVisibilityQuery=!1;this.basemapTerrain=this.graphicsCore=this.extent=this.spatialIndex=this.layer=this.layerView=
this.scaleChangeEventHandle=null}b.prototype.initialize=function(a,c,b,e,g){this.layerView=a;this.layer=c;this.spatialIndex=b;this.graphicsCore=e;this._scaleRangeActive=h(c);this.basemapTerrain=g;this.layerMinMaxScaleChangeHandler(!1)};b.prototype.destroy=function(){this.scaleChangeEventHandle&&(this.scaleChangeEventHandle.remove(),this.scaleChangeEventHandle=null);this.graphicsCore=this.spatialIndex=this.extent=this.layerView=null};b.prototype.needsIdleUpdate=function(){return this.layerView.view.basemapTerrain&&
this.layerScaleRangeVisibilityDirty};b.prototype.canResume=function(){return this.layerScaleRangeVisibility};b.prototype.setExtent=function(a){this.extent=a;this.layerScaleRangeVisibilityDirty=!0};b.prototype.idleUpdate=function(a){this.layerView.view.basemapTerrain&&!a.done()&&this.layerScaleRangeVisibilityDirty&&(this.updateSuspendScaleVisible(),this.layerScaleRangeVisibilityDirty=!1)};b.prototype.scaleRangeActive=function(){return this._scaleRangeActive};b.prototype.updateSuspendScaleVisibleFinish=
function(a){this.layerScaleRangeVisibilityQuery=!1;this.layerScaleRangeVisibility!==a&&(this.layerScaleRangeVisibility=a,this.layerView._notifySuspendedChange())};b.prototype.updateSuspendScaleVisible=function(){var a=this,c=this.layerView.view.basemapTerrain;this.extent&&c&&this._scaleRangeActive?this.layerScaleRangeVisibilityQuery||(this.layerScaleRangeVisibilityQuery=!0,c.queryVisibleScaleRange(this.extent,this.layer.minScale,this.layer.maxScale,function(c){return a.updateSuspendScaleVisibleFinish(c)})):
this.updateSuspendScaleVisibleFinish(!0)};b.prototype.visibleAtScale=function(a,c,b){return null==a?!0:a>b&&(!c||a<c)};b.prototype.visibleAtLayerScale=function(a){return this.visibleAtScale(a,this.layer.minScale,this.layer.maxScale)};b.prototype.visibleAtLabelScale=function(a,c){return this.visibleAtScale(a,c.minScale,c.maxScale)};b.prototype.graphicScale=function(a,c){var b;c.centroid?b=c.centroid:"point"===a.geometry.type&&(b=a.geometry);return b?this.layerView.view.basemapTerrain?this.layerView.view.basemapTerrain.getScale(b):
1:null};b.prototype.graphicVisible=function(a,c){a=this.graphicScale(a,c);return this.visibleAtLayerScale(a)};b.prototype.updateGraphicScaleVisibility=function(a,c){return this._scaleRangeActive&&c.addedToSpatialIndex?(a=this.graphicVisible(a,c),c.setVisibilityFlag("VISIBILITY_SCALERANGE",a)):!1};b.prototype.updateGraphicLabelScaleVisibility=function(a,c){if(!this._scaleRangeActive||!c.addedToSpatialIndex||!c._labelGraphics||0===c._labelGraphics.length)return!1;a=this.graphicScale(a,c);(c=this.updateLabelScaleVisibility(c,
a))&&this.layerView.view.labelManager.setDirty();return c};b.prototype.updateLabelScaleVisibility=function(a,c){if(!a._labelGraphics||0===a._labelGraphics.length)return!1;var b=!1,e=0;for(a=a._labelGraphics;e<a.length;e++){var g=a[e],f=g._labelClass;f&&null!=f.minScale&&null!=f.maxScale&&(f=this.visibleAtLabelScale(c,f),g.setVisibilityFlag("VISIBILITY_SCALERANGE_LABEL",f)&&(b=!0))}return b};b.prototype.scaleUpdateHandler=function(a){var b=this;if(!this.layerView.suspended&&this.spatialIndex.hasGraphics()){var k=
a.extent,e=a.scale;this.spatialIndex.intersects(k,a.spatialReference,function(a,c){for(var f=b.visibleAtLayerScale(e),g=!1,h=!1,m=0;m<c;m++){var l=b.graphicsCore.getGraphics3DGraphicById(a[m]);if(l){var d=l.centroid;d&&(k[0]>d.x||k[1]>d.y||k[2]<d.x||k[3]<d.y)||(d=!1,l.setVisibilityFlag("VISIBILITY_SCALERANGE",f)&&(d=!0),b.updateLabelScaleVisibility(l,e)&&(d=!0),d&&(h=!0,l.isDraped()&&(g=!0)))}}h&&b.layerView.view.labelManager.setDirty();g&&b.layerView._notifyDrapedDataChange()})}this.layerScaleRangeVisibilityDirty=
!0};b.prototype.layerMinMaxScaleChangeHandler=function(a){var b=this;void 0===a&&(a=!0);(this._scaleRangeActive=h(this.layer))&&!this.scaleChangeEventHandle?(this.scaleChangeEventHandle=this.basemapTerrain.on("scale-change",function(a){return b.scaleUpdateHandler(a)}),this.layerView.suspended||this.spatialIndex.addGraphicsToSpatialIndex(this._scaleRangeActive)):!this._scaleRangeActive&&this.scaleChangeEventHandle&&(this.scaleChangeEventHandle.remove(),this.scaleChangeEventHandle=null);!this.layerView.suspended&&
a&&this.graphicsCore.updateAllGraphicsVisibility();this.layerScaleRangeVisibilityDirty=!0};return b}()});