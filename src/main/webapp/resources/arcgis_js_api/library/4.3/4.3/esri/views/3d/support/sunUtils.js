// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define(["./mathUtils","../lib/glMatrix","../lib/SunCalc"],function(B,q,t){var m=q.vec3d,k=q.mat4d,F=B.lerp,J=k.identity(),f={azimuth:0,altitude:0};q={local:{altitude:2E3,ambientAtNight:.2,ambientAtNoon:.75,ambientAtTwilight:.5,diffuseAtNoon:.25,diffuseAtTwilight:.5},global:{altitude:2E4,ambient:.5,diffuse:.5},planarDirection:{localAltitude:1E5,globalAltitude:1E6,globalAngles:{azimuth:Math.PI/2,altitude:Math.PI/2}}};var l={ambient:{color:m.create(),intensity:0},diffuse:{color:m.create(),intensity:0,
direction:m.create()}},u={settings:q,computeDirection:function(h,b,d,e){e||(e=m.create());var g=k.identity(J);if("global"===d)t.getPosition(h,0,0,f),m.set3(0,0,-1,e),k.rotateX(g,-f.azimuth),k.rotateY(g,-f.altitude);else{var a=u.settings.planarDirection;d=a.globalAngles;a=(b.z-a.localAltitude)/(a.globalAltitude-a.localAltitude);a=B.clamp(a,0,1);1>a?(t.getPosition(h,b.y,b.x,f),f.azimuth=(1-a)*f.azimuth+a*d.azimuth,f.altitude=(1-a)*f.altitude+a*d.altitude):(f.azimuth=d.azimuth,f.altitude=d.altitude);
m.set3(0,-1,0,e);k.rotateZ(g,-f.azimuth);k.rotateX(g,-f.altitude)}k.multiplyVec3(g,e);return e},computeShadowsEnabled:function(e,b){return"global"===b?!0:e.z<u.settings.planarDirection.localAltitude},computeColorAndIntensity:function(h,b){var d,f=b.z;d=u.settings;m.set3(1,1,1,l.ambient.color);l.ambient.intensity=d.global.ambient;m.set3(1,1,1,l.diffuse.color);l.diffuse.intensity=d.global.diffuse;f=(f-d.local.altitude)/(d.global.altitude-d.local.altitude);f=B.clamp(f,0,1);if(1>f){d=t.getTimes(h,b.y,
b.x);b=h.valueOf();var g,a;d.polarException===t.POLAR_EXCEPTION.MIDNIGHT_SUN?(g=b-36E5*(h.getHours()+48)-6E4*h.getMinutes(),a=g+432E6):d.polarException===t.POLAR_EXCEPTION.POLAR_NIGHT?(g=b-2,a=b-1):(g=d.sunrise.valueOf(),a=d.sunset.valueOf());var n=a-g;h=g+n/2;var p=n/4;d=h-p;var p=h+p,c=.06*n,n=g-c/2;g+=c/2;var k=a-c/2,q=a+c/2;a=u.settings.local;var C=[.01,a.ambientAtNight],D=[.8,.8,1],E=[.01,.01,.01],v=[a.diffuseAtTwilight,a.ambientAtTwilight],w=[1,.75,.75],x=[.8,.8,1],y=[.9*a.diffuseAtNoon,a.ambientAtNoon],
z=[1,.98,.98],A=[.98,.98,1],G=[a.diffuseAtNoon,a.ambientAtNoon],H=[1,1,1],I=[1,1,1];a=[0,0];var r=[0,0],c=[0,0];b<n||b>q?(a=C,r=E,c=D):b<g?(c=g-n,a=e(b-n,c,C,v),r=e(b-n,c,E,w),c=e(b-n,c,D,x)):b<d?(c=d-g,a=e(b-g,c,v,y),r=e(b-g,c,w,z),c=e(b-g,c,x,A)):b<h?(c=h-d,a=e(b-d,c,y,G),r=e(b-d,c,z,H),c=e(b-d,c,A,I)):b<p?(c=p-h,a=e(b-h,c,G,y),r=e(b-h,c,H,z),c=e(b-h,c,I,A)):b<k?(c=k-p,a=e(b-p,c,y,v),r=e(b-p,c,z,w),c=e(b-p,c,A,x)):b<q&&(c=q-k,a=e(b-k,c,v,C),r=e(b-k,c,w,E),c=e(b-k,c,x,D));b=a[0];h=r;d=a[1];m.lerp(c,
l.ambient.color,f,l.ambient.color);l.ambient.intensity=F(d,l.ambient.intensity,f);m.lerp(h,l.diffuse.color,f,l.diffuse.color);l.diffuse.intensity=F(b,l.diffuse.intensity,f)}return l}},e=function(e,b,d,f){for(var g=[],a=0;a<d.length;a++)g[a]=(f[a]-d[a])*e/b+d[a];return g};return u});