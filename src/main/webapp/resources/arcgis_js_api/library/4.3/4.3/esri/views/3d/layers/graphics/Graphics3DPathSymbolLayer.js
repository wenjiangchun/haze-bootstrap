// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("../../../../core/declare ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./Graphics3DSymbolCommonCode ./ElevationInfo ../../support/projectionUtils ../../../../views/3d/lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/materials/Material ../../webgl-engine/lib/Util".split(" "),function(z,I,J,n,K,L,A,B,M,N,E,O,F){var C=A.vec3d,G=A.mat4d,P=F.assert,h=C.create(),r={},H={verticalDistanceToGround:0,
terrainElevation:0};z=z([I],{_prepareResources:function(){var a="c3dsymbol"+this.symbol.id,b=this._getMaterialOpacityAndColor(),c=C.create(b),b=b[3],c={diffuse:c,ambient:c,opacity:b,transparent:1>b||this._isPropertyDriven("opacity"),vertexColors:this._isPropertyDriven("color")||this._isPropertyDriven("opacity")};this._material=new O(c,a+"_3dlinemat");this._context.stage.add(B.ModelContentType.MATERIAL,this._material);this.resolve()},destroy:function(){this.isFulfilled()||this.reject();this._material&&
(this._context.stage.remove(B.ModelContentType.MATERIAL,this._material.getId()),this._material=null)},createGraphics3DGraphic:function(a,b){var c=a.geometry;if("polyline"!==c.type)return this._logWarning("unsupported geometry type for path symbol: "+c.type),null;var c="polygon"===c.type?"rings":"paths",g="graphic"+a.uid,k=this._getGraphicElevationInfo(a);return this._createAs3DShape(a,c,b,k,g,a.uid)},layerPropertyChanged:function(a,b,c){if("opacity"===a)return b=this._getMaterialOpacity(),c=1>b||
this._isPropertyDriven("opacity"),this._material.setParameterValues({opacity:b,transparent:c}),!0;if("elevationInfo"===a){this._updateElevationInfo();a=this._context.elevationProvider;var g=this._context.renderCoordsHelper,k=n.ELEV_MODES.ABSOLUTE_HEIGHT,p;for(p in b){var e=b[p],l=e._graphics[c];l&&(e=this._getGraphicElevationInfo(e.graphic),l.elevationAligner=e.mode!==k?D:null,l.elevationInfo.set(e),D(l,a,g))}return!0}return!1},_getPathSize:function(a,b){a=a.size&&this._isPropertyDriven("size")?n.getSingleSizeDriver(a.size):
this.symbol.size||this.symbol.width||1;return a/=this._context.renderCoordsHelper.unitInMeters},_createAs3DShape:function(a,b,c,g,k,p){var e=a.geometry,l=e.hasZ,t=e[b];if(0<t.length){b=[];a=[];for(var q=[],h=C.create(),w=this._context.renderSpatialReference===L.SphericalRenderSpatialReference,m=Array(6),u=this._getPathSize(c,this.symbol),e=n.getGeometryVertexData3D(t,l,e.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,g),l=e.geometryData.outlines,t=e.eleVertexData,
r=e.vertexData,v=0;v<l.length;++v){var d=l[v],f=d.index,x=d.count;if(this._context.clippingExtent&&(n.computeBoundingBox(t,f,x,m),n.boundingBoxClipped(m,this._context.clippingExtent)))continue;n.chooseOrigin(r,f,x,h);n.subtractCoordinates(r,f,x,h);d=new Float64Array(t.buffer,3*f*t.BYTES_PER_ELEMENT,3*x);f=n.flatArrayToArrayOfArrays(r,f,x);f=E.createTubeGeometry(f,.5*u,10,w,h);f.getVertexAttr().mapPos={size:3,data:d};this._material.getParams().vertexColors&&(d=this._getVertexOpacityAndColor(c),f=E.addVertexColors(f,
d,!0));d=new N(f,k+"path"+v);d.singleUse=!0;b.push(d);a.push([this._material]);d=G.identity();G.translate(d,h,d);q.push(d)}if(0<b.length)return c=new M({geometries:b,materials:a,transformations:q,castShadow:!0,metadata:{layerId:this._context.layer.id,graphicId:p},idHint:k}),k=null,g.mode!==n.ELEV_MODES.ABSOLUTE_HEIGHT&&(k=D),g=new J(this,c,b,null,null,k,g),g.alignedTerrainElevation=e.terrainElevation,g}return null}});var Q=F.VertexAttrConstants,D=function(a,b,c){for(var g=a.stageObject,k=a.elevationInfo,
p=g.getGeometryRecords(),e=p.length,l=k.mode!==K.MODES.ABSOLUTE_HEIGHT,t=0,q=0;q<e;q++){var z=p[q].geometry,w=[p[q].transformation[12],p[q].transformation[13],p[q].transformation[14]],m=z.getData().getVertexAttr(),u=m[Q.POSITION].data,C=m.zOffset.data,m=m.mapPos.data,v=m.length/3;P(u.length/3===10*v+2,"unexpected tube geometry");var d=0,f=0;r.spatialReference=b.spatialReference;for(var x=0,y=0;y<v;y++){r.x=m[3*y];r.y=m[3*y+1];r.z=m[3*y+2];var D=n.computeElevation(b,r,k,l?H:null);l&&(x+=H.terrainElevation);
var A=10;0!==y&&y!==v-1||A++;for(var B=0;B<A;B++)h[0]=u[d]+w[0],h[1]=u[d+1]+w[1],h[2]=u[d+2]+w[2],c.setAltitude(D+C[f],h,0),u[d]=h[0]-w[0],u[d+1]=h[1]-w[1],u[d+2]=h[2]-w[2],d+=3,f+=1;z.invalidateBoundingInfo()}g.geometryVertexAttrsUpdated(q);t+=x/v}a.alignedTerrainElevation=t/e};return z});