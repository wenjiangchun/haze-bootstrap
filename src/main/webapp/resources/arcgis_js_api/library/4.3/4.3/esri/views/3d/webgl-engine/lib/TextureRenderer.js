// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ./Renderer ./Camera ./Util ./gl-matrix ../materials/internal/TexOnlyGLMaterial ../../../webgl/Texture ../../../webgl/FramebufferObject ../../../webgl/VertexArrayObject ../../../webgl/BufferObject ../../../webgl/Util ../../../webgl/enums ./DefaultVertexBufferLayouts ./DefaultVertexAttributeLocations".split(" "),function(q,I,t,u,v,p,w,x,y,z,A,B,J,C,D){var E=p.vec3d,F=p.vec4d,l=p.mat4d;q=function(){function g(a,c,f,b,e,d){this._acquiredTextures={};this._clearColor=F.createFrom(0,
0,0,0);this._id2origin={};this._rctx=a;this._canvas=c;this._programRep=f;this._materialRep=b;this._textureRep=e;this._modelDirtySet=d;this._renderer=new t(f,b,e,this._rctx,!0);this._renderer.setLightingData({ambient:[1,1,1,1],diffuse:[0,0,0,0],specular:[0,0,0,0],direction:[0,-1,0]})}g.prototype.dispose=function(){for(var a in this._acquiredTextures)this._acquiredTextures[a].fbo.dispose(),this._textureRep.release(a);this._acquiredTextures=null;this._renderer.dispose();this._renderer=null};g.prototype.addRenderGeometries=
function(a){var c=this;a.forEach(function(a){null==a.origin&&(a.origin=c.getOrigin(a.center,a.bsRadius))});this._renderer.modify(a,[])};g.prototype.removeRenderGeometries=function(a){this._renderer.modify([],a)};g.prototype.updateRenderGeometries=function(a,c){a=a.map(function(a){return{renderGeometry:a,updateType:c}});this._renderer.modify([],[],a,{})};g.prototype.updateRenderOrder=function(a){0<Object.keys(a).length&&this._renderer.modifyRenderOrder(a)};g.prototype.setBackgroundColor=function(a){this._clearColor=
a};g.prototype.isEmpty=function(){return this._renderer.isEmpty()};g.prototype.processDirtyMaterials=function(){var a=this._modelDirtySet.getDirtyMaterials();a&&this._renderer.modify([],[],[],a);this._modelDirtySet.clearDirtyMaterials()};g.prototype.draw=function(a,c){this.processDirtyMaterials();var f=a.id.toString(),b,e=this._rctx,d=e.gl;if(this._acquiredTextures[f])b=this._acquiredTextures[f].fbo;else{b=this._textureRep.aquire(f).getGLTexture();b=y.createWithAttachments(this._rctx,b,{colorTarget:0,
depthStencilTarget:0});var h=Object.keys(this._acquiredTextures).length;this._acquiredTextures[f]={texture:a,fbo:b,idx:h}}a=c.width;h=c.height;if(b.width!==a||b.height!==h)b.resize(a,h),b.colorTexture.setSamplingMode(9729);k.near=1;k.far=1E4;e.bindFramebuffer(b);e.setDepthTestEnabled(!1);e.setBlendFunctionSeparate(770,771,1,771);e.setClearColor.apply(e,this._clearColor);e.clear(d.COLOR_BUFFER_BIT);this._renderer.setPixelRatio(c.pixelRatio||1);for(d=0;d<c.views.length;d++)b=c.views[d],k.viewport=b.viewport,
l.ortho(0,b.extent[2]-b.extent[0],0,b.extent[3]-b.extent[1],k.near,k.far,k.projectionMatrix),l.identity(k.viewMatrix),l.translate(k.viewMatrix,[-b.extent[0],-b.extent[1],0]),k.setGLViewport(this._rctx),G&&this._drawTestTexture(a,h,r[this._acquiredTextures[f].idx%r.length]),this._renderer.render(k,H);e.setDepthTestEnabled(!0);e.setBlendFunctionSeparate(770,771,1,771);e.bindFramebuffer(null);e.setViewport(0,0,this._canvas.width,this._canvas.height)};g.prototype._drawTestTexture=function(a,c,f){var b=
this._rctx,e=b.gl;if(!this._testPatternMat){for(var d=new Uint8Array(a*c*4),h=0,g=0;g<c;g++)for(var k=0;k<a;k++){var m=Math.floor(k/10),n=Math.floor(g/10);2>m||2>n||10*m>a-20||10*n>c-20?(d[h++]=255,d[h++]=255,d[h++]=255,d[h++]=255):(d[h++]=255,d[h++]=255,d[h++]=255,m&1&&n&1?d[h++]=k&1^g&1?0:255:d[h++]=m&1^n&1?0:128)}a=new x(b,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:a,height:c},d);this._testPatternMat=new w(this._programRep,a,[1,1,1,1],!0,e.ALWAYS);this._testPatternBindParams=
{proj:l.identity(),view:l.identity(),nearFar:[-1,1],origin:[0,0,0]};e=new Float32Array([-1,-1,0,0,0,1,-1,0,1,0,-1,1,0,0,1,1,1,0,1,1]);this._quadVAO=new z(b,D.Default3D,{geometry:C.Pos3Tex},{geometry:A.createVertex(b,35044,e)})}this._testPatternMat.setColor([f[0],f[1],f[2],1]);this._testPatternMat.bind(b,this._testPatternBindParams);this._testPatternMat.bindView(b,this._testPatternBindParams);b.bindVAO(this._quadVAO);b.drawArrays(5,0,B.vertexCount(this._quadVAO,"geometry"));this._testPatternMat.release(b)};
g.prototype.getOrigin=function(a,c){var f=0;c=10*c/1E4;1<c&&(f=Math.ceil(v.logWithBase(c,2)));c=1E4*Math.pow(2,f);var b=Math.round(a[0]/c),e=Math.round(a[1]/c);a=Math.round(a[2]/c);var f=f+"_"+b+"_"+e+"_"+a,d=this._id2origin[f];null==d&&(d={vec3:E.createFrom(b*c,e*c,a*c),id:f},this._id2origin[f]=d);return d};return g}();var G=!1,r=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],H={get:function(){return!0}},k=new u;return q});