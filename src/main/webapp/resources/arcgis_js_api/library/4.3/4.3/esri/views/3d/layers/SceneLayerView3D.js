// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../layers/IntegratedMeshLayer ../../../core/arrayUtils ../../../core/watchUtils ../../../core/promiseUtils ../../../core/Logger ../../../core/lang dojo/_base/lang dojox/color/_base dojo/has ../../layers/LayerView ../../../Graphic ../../../symbols/Symbol3D ../../../geometry/Extent ./i3s/I3SUtil ./i3s/I3SBinaryReader ./i3s/I3SProjectionUtil ./i3s/I3SQueryEngine ./graphics/graphicUtils ./support/LayerViewUpdatingPercentage ../support/intersectionUtils ../support/projectionUtils ../support/aaBoundingBox ../webgl-engine/Stage ../webgl-engine/lib/Layer ../webgl-engine/lib/Geometry ../webgl-engine/lib/GeometryData ../webgl-engine/lib/Object3D ../webgl-engine/lib/Texture ../webgl-engine/materials/Material ../webgl-engine/lib/Util ../webgl-engine/lib/base64Binary ../lib/glMatrix".split(" "),
function(q,ya,ea,z,A,Q,fa,B,I,ga,ha,ia,ja,ka,la,V,ma,na,D,R,M,oa,W,pa,qa,N,E,S,ra,sa,T,ta,L,ua,t,za,J){function X(n,e,a,b){var c=!1,d;e.encoding===D.DDS_ENCODING_STRING?d=L.DDS_ENCODING:c=!(Y(n.width)&&Y(n.height));n=e.usedByEngineMats.some(function(a){return a.getParams().atlasRegions})||e.atlas;a=(a||!n)&&!c;return{mipmap:a,wrapClamp:n||!e.wrap,disableAnisotropy:n&&a&&b,encoding:d,noUnpackFlip:!0}}function Z(n,e){e=e.toLowerCase();for(var a=0,b=Object.keys(n);a<b.length;a++){var c=b[a];if(c.toLowerCase()===
e)return n[c]}return null}var x=ga.getLogger("esri.layers.SceneService"),y=t.assert,va=t.clamp,Y=t.isPowerOfTwo,O=t.fallbackIfUndefined,P=t.objectEmpty,C=t.VertexAttrConstants,aa=[1,1,1,1],n=S.ModelContentType,wa=[.8,.8,.8],xa=[.5,.5,.5];q=function(q){function e(){var a=null!==q&&q.apply(this,arguments)||this;a._queryEngine=null;a._controllerCreated=!1;a._definitionExpressionErrors=0;a._maxDefinitionExpressionErrors=20;a._featuresChangedEventScheduled=!1;a._featuresChangedEvent=null;return a}ea(e,
q);e.prototype.initialize=function(){var a=this;D.checkSceneLayerValid(this.layer);D.checkSceneLayerCompatibleWithView(this.layer,this.view);var b=this.layer.version,b=!ka("trident")||1<b.major||1===b.major&&3<b.minor;this.useCompressedTextures=this.view.has("s3tc")&&b;this._disableAtlasAnisotropy=(this._enableAtlasMipMaps=this.view.has("standardDerivatives"))&&!this.view.has("shaderTextureLOD");this._initGraphicsController();this.dbg=!1;this.maxGpuMemory=1E3;this.geoMemoryEstimate=this.texMemoryEstimate=
this.gpuMemoryEstimate=0;this._stage=this.view._stage;this._matId2Meta={};this._texId2Meta={};this._requestedTexImageIds={};this._nodeId2Meta={};this._colorOverride=null;for(var b=new Uint8Array(256),c=0;c<b.length;c++)b[c]=255;this._whiteTexture=new L(b,"white",{width:8,height:8});this._stage.add(S.ModelContentType.TEXTURE,this._whiteTexture);this._layerEventHandles=[B.init(this.layer,"renderer",function(b){return a._rendererChange(b)}),B.watch(this,"fullOpacity",function(b){return a._opacityChange(b)}),
B.init(this.layer,"objectIdFilter",function(){return a._filterChange()}),B.init(this,"_controller.parsedDefinitionExpression",function(){return a._filterChange()}),B.init(this.view,"clippingArea",function(){return a._clippingAreaChanged()})];this._addThisLayerToStage();this.setVisibility(!this.suspended);this.debugLODVis=this.debugNodeVis=!1};e.prototype.destroy=function(){this._stage.remove(S.ModelContentType.TEXTURE,this._whiteTexture.getId());this._removeThisLayerFromStage();this._layerEventHandles.forEach(function(a){a.remove()});
this._stage=null;null!=this._controller&&(this._controller.destroy(),this._controller=null);this._nodeId2Meta=this._texId2Meta=this._matId2Meta=null};e.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)};e.prototype.isUpdating=function(){return this._controllerCreated?!(!this._controller||!this._controller.updating):!1};e.prototype.memEstimateTextureAdded=function(a){a=a.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=
a};e.prototype.memEstimateTextureRemoved=function(a){a=a.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate-=a;this.texMemoryEstimate-=a};e.prototype.memEstimateGeometryAdded=function(a){a=a.estimateGpuMemoryUsage()/1E6;this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=a};e.prototype.memEstimateGeometryRemoved=function(a){a=a.estimateGpuMemoryUsage()/1E6;this.gpuMemoryEstimate-=a;this.geoMemoryEstimate-=a};e.prototype.isBundleAlreadyAddedToStage=function(a,b){return this._nodeId2Meta[a.id]&&this._nodeId2Meta[a.id].engineObjectsPerBundle&&
null!=this._nodeId2Meta[a.id].engineObjectsPerBundle[b]};e.prototype._initGraphicsController=function(){var a=this,b={addBundle:this._addBundle.bind(this),isBundleAlreadyAddedToStage:function(b,d){return a.isBundleAlreadyAddedToStage(b,d)},isOverMemory:function(){return a.isOverMemory()},removeNodeData:function(b){return a._removeNodeDataFromStage(b)},removeFeatures:function(b,d){return a._removeFeatures(b,d)},getAddedFeatures:function(b){return a._getAddedFeatures(b)},getAddedNodeIDs:function(){return a._getAddedNodeIDs()},
areAllBundlesLoaded:function(b){return a._areAllBundlesLoaded(b)},wholeNodeSwitchEnabled:!0};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:b,layerViewOptionalFunctions:{additionalStartNodeLoadingHandler:function(){return a._startNodeLoading()},additionalCancelNodeLoadingHandler:function(){return a.cancelNodeLoading()},getTexturePrefetchFunctions:function(){return{_calcDesiredTextureLOD:function(b,d){return a._calcDesiredTextureLOD(b,d)},_imageIsPartOfTextureBundle:function(b){return a._imageIsPartOfTextureBundle(b)},
_matId2Meta:a._matId2Meta,_texId2Meta:a._texId2Meta,useCompressedTextures:function(){return a.useCompressedTextures}}},_nodeDebugVisualizer:this._nodeDebugVisualizer,setPolygonOffset:function(b,d){return a._setPolygonOffset(b,d?1:0)},traversalOptions:{initDepthFirst:!0,neighborhood:!0,perLevelTraversal:!1,allowPartialOverlaps:!1},getLoadedAttributes:function(b){return a.getLoadedAttributes(b)},setAttributeData:function(b,d,f){return a.setAttributeData(b,d,f)}}}).then(function(b){b.watch("rootNodeVisible",
function(){a.notifyChange("suspended")})}).always(function(){a._controllerCreated=!0;a.notifyChange("updating")})};e.prototype.setMaxGpuMemory=function(a){this.maxGpuMemory=a};e.prototype.setVisibility=function(a){if(this._stage&&this._engineLayer){var b=this._engineLayer.getId(),c=0<=this._stage.getViewContent().indexOf(b);!!a!==c&&(b=[b],null!=this._nodeDebugVisualizer&&b.push(this._nodeDebugVisualizer.engineLayer.getId()),a?this._stage.addToViewContent(b):this._stage.removeFromViewContent(b))}};
e.prototype.getEngineLayer=function(){return this._engineLayer};e.prototype.getStats=function(){var a={nodesInIndex:0,knownFeatures:0,activeMaterials:0};if(!this._controller)return a;for(var b=0,c=Object.keys(this._controller.nodeIndex);b<c.length;b++){var d=c[b];a.nodesInIndex++;d=this._controller.nodeIndex[d];null!=d.features&&(a.knownFeatures+=d.features.length)}a.activeMaterials=Object.keys(this._matId2Meta).length;return a};e.prototype._addThisLayerToStage=function(){var a=this._stage;this._initTexture=
new L(null,"i3sInitTexture");a.add(n.TEXTURE,this._initTexture);var b=this.layer.id;this._engineLayer=b=new ra(b,{},b);a.add(n.LAYER,b);null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose()};e.prototype._removeThisLayerFromStage=function(){this.cancelNodeLoading();if(null!=this._engineLayer){var a=this._stage;a.remove(n.TEXTURE,this._initTexture.getId());if(null!=this._controller)for(var b in this._controller.nodeIndex)this._controller.nodeIndex.hasOwnProperty(b)&&(this._removeNodeDataFromStage(this._controller.nodeIndex[b]),
delete this._controller.nodeIndex[b]);y(P(this._nodeId2Meta));y(P(this._matId2Meta));y(P(this._texId2Meta));a.remove(n.LAYER,this._engineLayer.getId());null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose();this._nodeDebugVisualizer=void 0;this._matId2Meta={};this._texId2Meta={};this._requestedTexImageIds={};this._nodeId2Meta={};this._engineLayer=void 0;this.gpuMemoryEstimate=0}};e.prototype._startNodeLoading=function(){this._updateAllTextureLOD()};e.prototype.cancelNodeLoading=function(){null!=
this._nodeDebugVisualizer&&this._nodeDebugVisualizer.clear();this._requestedTexImageIds={}};e.prototype._isAllHidden=function(a){a=this._nodeId2Meta[a.id].engineObjects;for(var b=0;b<a.length;b++)if(!a[b].isAllHidden())return!1;return!0};e.prototype.getLoadedAttributes=function(a){if((a=this._nodeId2Meta[a.id])&&1===a.engineObjects.length)return a.engineObjects[0].getMetadata().loadedAttributes};e.prototype.setAttributeData=function(a,b,c){var d=this._nodeId2Meta[a.id];if(d&&1===d.engineObjects.length){var d=
d.engineObjects[0],f=d.getMetadata();f.loadedAttributes=b;f.attributeData=c;this._setObjectSymbology(d);this._applyFilters(a)}};e.prototype._createUnitTestData=function(a){var b=this.view.navigation.targetCamera,b={viewParams:{eye:b.eye,center:b.center,up:b.up,viewMatrix:b.viewMatrix,projectionMatrix:b.projectionMatrix,fovX:b.fovX,viewport:b.viewport,perPixelRatio:b.perPixelRatio},visibleObjects:[]};a=a.getAll("objects");for(var c in a){var d=a[c];if(d.getParentLayer()===this._engineLayer){var f=
d.getMetadata(),d=f.i3sNode,f=f.features.map(function(a){return a.id});f.sort();b.visibleObjects.push({featureIDs:f,nodeId:d})}}console.debug(""+b.visibleObjects.length);return JSON.stringify(b)};e.prototype.isOverMemory=function(){return this.gpuMemoryEstimate>this.maxGpuMemory?(x.warn("over memory: "+this.gpuMemoryEstimate+" tex "+this.texMemoryEstimate+" geom "+this.geoMemoryEstimate),!0):!1};e.prototype._getAddedFeatures=function(a){if(null==this._nodeId2Meta[a])return null;var b=[];a=this._nodeId2Meta[a].engineObjects;
for(var c=0;c<a.length;c++)b=b.concat(a[c].getMetadata().features);return b};e.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodeId2Meta)};e.prototype._calcEngineMaterialTransparencyParams=function(a,b,c){var d=this.fullOpacity,f=1-va(O(b.transparency,0),0,1),d=d*f;a=1>d||a&&ha.endsWith(a.channels,"a")||!0===b.useVertexColorAlpha||c;return{opacity:d,transparent:a}};e.prototype._calcEngineMaterialDoubleSidedParams=function(a){return null!=a.doubleSided?a.doubleSided:!0};e.prototype._calcEngineMaterialCullFaceParams=
function(a){return a.cullFace?a.cullFace:null!=a.doubleSided?a.doubleSided?"none":"back":"none"};e.prototype._createEngineMaterial=function(a,b,c,d,f,p){var e,g;null!=a&&(e=(g=this._texId2Meta[b])&&g.engineTex?g.engineTex.getId():this._initTexture.getId());var l=c.params,k=O(l.diffuse,wa),m,r;null!=a&&(r=D.getAppropriateTextureEncoding(a.encoding,this.useCompressedTextures),m=-1<r?a.encoding[r]:a.encoding);"standard"!==c.type&&x.warn("Unknown material type '"+c.type+"', must be 'standard'");void 0===
l.reflectivity&&x.warn("Material parameter 'reflectivity' is missing.");c=this.layer instanceof Q;e={ambient:this._colorOverride||k,diffuse:this._colorOverride||k,specular:O(l.specular,xa),shininess:O(l.shininess,64),atlasRegions:l.vertexRegions,textureId:e&&this._colorOverride?this._whiteTexture.getId():e,vertexColors:!0,flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(l),cullFace:this._calcEngineMaterialCullFaceParams(l),writeStencil:c,receiveSSAO:!c};c||(k=this._calcEngineMaterialTransparencyParams(a,
l),ia.mixin(e,k));e=new ua(e,d);e.metadata={i3sMatId:d,i3sTexId:b,i3sTex:a,i3sMatParams:l};if(null!=a){g?g.usedByEngineMats.push(e):(g={id:b,featureMBS:[],usedByEngineMats:[e],images:a.images,encoding:m,encodingIdx:r,atlas:!0===a.atlas,wrap:"none"!==a.wrap[0]||"none"!==a.wrap[1]},this._texId2Meta[b]=g);for(a=0;a<f.length;a++)g.featureMBS.push(f[a].engineMBS);if(void 0!==p[b]){null==g.engineTex&&(f=p[b].data,a=X(f,g,this._enableAtlasMipMaps,this._disableAtlasAnisotropy),g.engineTex=new L(f,g.id,a),
this._stage.add(n.TEXTURE,g.engineTex),g.desiredLOD=p[b].desiredLOD,g.curLOD=g.desiredLOD,this.memEstimateTextureAdded(g.engineTex));f=g.engineTex.getId();for(a=0;a<g.usedByEngineMats.length;a++)l=g.usedByEngineMats[a],null==this._colorOverride&&l.setParameterValues({textureId:f}),l.metadata.originalTextureId=f;p[b].createdTextureForDomImage();delete p[b]}else this._updateTextureLOD(g)}this._matId2Meta[d]||(this._matId2Meta[d]={});this._matId2Meta[d][b]={engineMat:e,refCount:1};return e};e.prototype._createVertexArrays=
function(a,b){var c;a=a.params.vertexAttributes;var d={},f;for(f in a)if(a.hasOwnProperty(f)&&"classification"!==f){var e=a[f];c=R.valueType2TypedArrayClassMap[e.valueType];y(null!=c,"unsupported vertex attribute value type: "+e.valueType);d[f]={data:new c(b,e.byteOffset,e.count*e.valuesPerElement),size:e.valuesPerElement}}if(null==d[C.COLOR])for(c=R.valueType2TypedArrayClassMap.UInt8,d[C.COLOR]={data:new c(4*a.position.count),size:4},b=0;b<d[C.COLOR].data.length;b++)d[C.COLOR].data[b]=0===b%3?255:
0;null==d[C.NORMAL]&&(c=R.valueType2TypedArrayClassMap.Float32,d[C.NORMAL]={data:new c(3*a.position.count),size:3});return d};e.prototype._createEngineMats=function(a,b,c,d,f){for(var e=a.params.components.length,h=Array(e),g=0;g<e;g++){var l=a.params.components[g],k=l.materialID,m=c.materialDefinitions[k];null!=m.href&&(m=d[m.hrefConcat].materialDefinitions[k]);y(void 0!==m,"geometry wants unknown material "+k);var r=l.textureID||"none",n=void 0;"none"!==r&&(null!=c.textureDefinitions&&null!=c.textureDefinitions[r]||
x.warn("textureDefinitions missing in shared resource"),n=c.textureDefinitions[r]);l=void 0;this._matId2Meta[k]&&this._matId2Meta[k][r]?(k=this._matId2Meta[k][r],l=k.engineMat,k.refCount++):l=this._createEngineMaterial(n,r,m,k,b,f);h[g]=l}return h};e.prototype._areAllBundlesLoaded=function(a){if(null==this._nodeId2Meta[a.id]||null==this._nodeId2Meta[a.id].engineObjectsPerBundle)return!1;for(var b=0;b<a.featureData.length;b++)if(null==this._nodeId2Meta[a.id].engineObjectsPerBundle[b])return!1;return!0};
e.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"};e.prototype._findGraphicNodeAndIndex=function(a){a=Z(a.attributes,this._getObjectIdField());for(var b=0,c=Object.keys(this._nodeId2Meta);b<c.length;b++)for(var d=c[b],f=this._nodeId2Meta[d].engineObjects,e=0;e<f.length;e++){var h=f[e].getMetadata().featureIds.indexOf(a);if(-1!==h)return{node:this._controller.nodeIndex[d],nodeId:d,bundleNr:e,index:h}}return null};e.prototype._getGraphicIndices=function(a,b,c){a=this._nodeId2Meta[a.id].engineObjects;
if(!a||!a[b])return[];b=a[b].getMetadata();a=[];for(var d=this._getObjectIdField(),f=0;f<c.length;f++){var e=Z(c[f].attributes,d),e=b.featureIds.indexOf(e);-1!==e&&a.push(e)}return a};e.prototype.whenGraphicBounds=function(a){var b=this._findGraphicNodeAndIndex(a);if(null!=b){a=this._nodeId2Meta[b.nodeId].engineObjects[b.bundleNr];var c=a.getMetadata().faceRanges[b.index],b=new Float64Array(24);this._boundingBoxCornerPoints(c,a,b);if(N.bufferToBuffer(b,this.view.renderSpatialReference,0,b,this.view.spatialReference,
0,8))return a=E.create(E.NEGATIVE_INFINITY),E.expandBuffer(a,b,0,8),I.resolve(a)}return I.reject()};e.prototype.whenGraphicAttributes=function(a,b){var c=this;return D.whenGraphicAttributes(this.layer,[a],this._getObjectIdField(),b,function(){var b=c._findGraphicNodeAndIndex(a);return{node:b.node,indices:[b.index]}}).then(function(a){return a[0]})};e.prototype.getGraphicsFromStageObject=function(a,b){if(this.layer instanceof Q)return I.reject();var c=a.getMetadata();a=a.getFaceRangeIndexFromTriangleNr(b);
return null!=a&&null!=c.featureIds&&a<c.featureIds.length?(c=this._createGraphic(a,c),I.resolve(c)):I.reject()};e.prototype._addBundle=function(a,b,c,d,f,e,h){if(!0===this.debugNodeVis&&null!=this._nodeDebugVisualizer){var g="grey";switch(a.level){case 1:g="red";break;case 2:g="green";break;case 3:g="blue";break;case 4:g="yellow";break;case 5:g="magenta";break;case 6:g="brown"}this._nodeDebugVisualizer.show(a,this._controller.crsIndex,g)}var g=this._stage,p={};p[n.OBJECT]={};p[n.GEOMETRY]={};p[n.MATERIAL]=
{};p[n.TEXTURE]={};var k=this._engineLayer,m=k.getId(),r=d[a.sharedResource.hrefConcat];if(null!=this._nodeId2Meta[a.id]&&null!=this._nodeId2Meta[a.id].engineObjectsPerBundle&&this._nodeId2Meta[a.id].engineObjectsPerBundle[h])this._applyFilters(a),null!=f&&f.done();else if(!this.isOverMemory())if(null==this._nodeId2Meta[a.id]&&(this._nodeId2Meta[a.id]={engineObjects:[],engineObjectsPerBundle:[]}),this._nodeId2Meta[a.id].engineObjectsPerBundle[h]=[],null==b)null!=f&&f.done();else{for(var ba=0,q=0;q<
b.length;q++){var v=b[q],u=v.faceRanges,x=v.componentOffsets,ca=v.geometries,F=v.featureIds,U=v.features,G=d[a.geometryData[h].hrefConcat];y(G instanceof ArrayBuffer,"I3S: geometry data is not an ArrayBuffer");null==G._isReprojected&&(G._isReprojected={});for(var A=a.id+"|"+U[0].id.toString(),da=[],z=[],E=[],K=void 0,v=function(b){var c=ca[b],f=w._createVertexArrays(c,G),g=new T(f,T.DefaultIndices,x||T.DefaultOffsets),h=w._createEngineMats(c,U,r,d,e),k=w._controller.crsIndex,l=w.view.renderSpatialReference;
K=M.reprojectPoints(w._controller.isMeshPyramid?M.ReprojectionTypes.PER_VERTEX:M.ReprojectionTypes.BOUNDINGBOX,f.position.data,a.mbs,G._isReprojected[c.id],k,w._controller.crsVertex,l);G._isReprojected[c.id]=!0;w._controller.isMeshPyramid&&D.processNormals({normals:g.vertexAttributes.normal.data,positions:g.vertexAttributes.position.data,normalInd:g.indices.normal,positionInd:g.indices.position},w.layer.normalReferenceFrame||"none",function(b,c){M.reprojectNormalsPerVertex(b,a.mbs,k,c,l)});f=K.localTrafo;
null!=c.transformation&&(f=J.mat4d.create(c.transformation),J.mat4d.multiply(K.localTrafo,f,f));for(c=0;c<h.length;c++){var m=h[c];p[n.MATERIAL][m.getId()]=m}g=new sa(g,A+"_"+b);w.memEstimateGeometryAdded(g.getData());p[n.GEOMETRY][g.getId()]=g;da[b]=g;z[b]=f;E[b]=h},w=this,t=0;t<ca.length;++t)v(t);u={i3sNode:a.id,ceLayer:m,features:U,faceRanges:u,featureIds:F,attributeData:c?c.attributeData:null,loadedAttributes:c?c.loadedAttributes:null,layerId:this.layer.id};ba+=null!=u.featureIds?u.featureIds.length:
1;u=new ta({idHint:a.id,name:A,geometries:da,materials:E,transformations:z,castShadow:!0,metadata:u});F=J.mat4d.create();J.mat4d.identity(F);J.mat4d.multiply(F,K.globalTrafo,F);u.setObjectTransformation(F);this._nodeId2Meta[a.id].engineObjectsPerBundle[h].push(u);this._nodeId2Meta[a.id].engineObjects.push(u);p[n.OBJECT][u.getId()]=u;this._setObjectSymbology(u);this._applyFilters(a)}g.beginMod();b=p[n.OBJECT];for(var H in b)b.hasOwnProperty(H)&&k.addObject(b[H]);for(var C in p)if(p.hasOwnProperty(C)){H=
p[C];for(var B in H)H.hasOwnProperty(B)&&null==g.get(C,B)&&g.add(C,H[B])}g.endMod();null!=f&&f.done();this._notifyFeaturesChanged(ba,0)}};e.prototype._clippingAreaChanged=function(){var a=this,b=[];N.extentToBoundingBox(this.view.clippingArea,b,this.view.renderSpatialReference)?this._clippingArea=b:this._clippingArea=null;this._updateFilters();if(this._controller){var c=this._controller.nodeIndex;c&&Object.keys(this._nodeId2Meta).forEach(function(b){return a._applyFilters(c[b])});this._controller.updateClippingArea(this.view.clippingArea)}};
e.prototype._filterChange=function(){this._updateFilters();if(this._controller){var a=this._controller.nodeIndex;if(a)for(var b=0,c=Object.keys(this._nodeId2Meta);b<c.length;b++)this._applyFilters(a[c[b]])}};e.prototype._updateFilters=function(){var a=this,b=[];if(this.layer.objectIdFilter){var c=new Float64Array(this.layer.objectIdFilter.ids),d="include"===this.layer.objectIdFilter.method;c.sort();b.push(function(b,f){return a._objectIdFilter(c,d,f)})}if(this._controller&&this._controller.parsedDefinitionExpression&&
this._controller.definitionExpressionFields){this._definitionExpressionErrors=0;var f=this._controller.parsedDefinitionExpression,e=this._controller.definitionExpressionFields;b.push(function(b,c){return a._sqlFilter(b,f,e,c)})}this._clippingArea&&b.push(function(b,c){return a._boundingboxFilter(b,a._clippingArea,c)});this._filters=b};e.prototype._sqlFilter=function(a,b,c,d){var f={},e=new V(null,null,f);e.layer=this.layer;var h=0,g=0,l=function(a){var p=a.getMetadata();a=p.featureIds;for(var l=p.attributeData,
p=c.every(function(a){return null!=l[a]}),m=0;m<a.length&&h<d.length;m++)if(d[h]===a[m]){var n=!0;if(p){for(var n=0,r=c;n<r.length;n++){var q=r[n];f[q]=D.getCachedAttributeValue(l[q],m)}n=k._evaluateClause(b,e)}n&&(d[g]=d[h],g++);h++}},k=this,m=0;for(a=this._nodeId2Meta[a.id].engineObjects;m<a.length;m++)l(a[m]);d.length=g};e.prototype._evaluateClause=function(a,b){try{return!!a.calculateValue(b)}catch(c){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&x.error("Error while evaluating definitionExpression: "+
c),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&x.error("Further errors are ignored"),!1}};e.prototype._objectIdFilter=function(a,b,c){for(var d=0,f=0;d<c.length;)0<=fa.binaryIndexOf(a,c[d])===b&&(c[f]=c[d],f++),d++;c.length=f};e.prototype._boundingboxFilter=function(a,b,c){var d=[0,0,0,0];N.mbsToMbs(a.mbs,this._controller.crsIndex,d,this.view.renderSpatialReference);d=null!=b?D.intersectBoundingBoxWithMbs(b,d):2;if(2!==d){var f=0,e=0;
for(a=this._nodeId2Meta[a.id].engineObjects;e<a.length;e++){var h=a[e],g=h.getMetadata().featureIds;if(0===d){for(var l=0,h=0;h<g.length&&f+l<c.length;h+=1)c[f+l]===g[h]&&l++;c.splice(f,l)}else{var k=h.getObjectTransformation(),l=h.getGeometryRecords()[0].getShaderTransformation();J.mat4d.multiply(k,l);if(0===k[1]&&0===k[2]&&0===k[3]&&0===k[4]&&0===k[6]&&0===k[7]&&0===k[8]&&0===k[9]&&0===k[11]&&1===k[15])for(var l=(b[0]-k[12])/k[0],m=(b[1]-k[13])/k[5],n=(b[2]-k[14])/k[10],q=(b[3]-k[12])/k[0],C=(b[4]-
k[13])/k[5],k=(b[5]-k[14])/k[10],v=h.getGeometryRecords()[0].geometry.getData(),u=v.getFaces()[0].indices.position,v=v.getVertexAttr().position.data,A=h.getMetadata().faceRanges,t=void 0,F=void 0,x=void 0,G=void 0,y=void 0,z=void 0,h=0;h<A.length&&f<c.length;h+=1)if(c[f]===g[h]){for(var t=A[h],B=t[0],E=t[1],t=F=x=Number.MAX_VALUE,G=y=z=-Number.MAX_VALUE;B<=E;B+=1)for(var K=0;3>K;K+=1)var w=3*u[3*B+K],I=v[w],H=v[w+1],w=v[w+2],t=Math.min(I,t),F=Math.min(H,F),x=Math.min(w,x),G=Math.max(I,G),y=Math.max(H,
y),z=Math.max(w,z);t>q||G<l||F>C||y<m||x>k||z<n?c.splice(f,1):f++}}}}};e.prototype._applyFilters=function(a){if(this._nodeId2Meta[a.id]&&null!=this._nodeId2Meta[a.id].engineObjects){for(var b=this._nodeId2Meta[a.id].engineObjects,c=0;c<b.length;c++){var d=b[c];d.unhideAllComponents()}if(0!==this._filters.length){for(var c=[],f=0;f<b.length;f++)d=b[f],c=c.concat(d.getMetadata().featureIds);d=c.length;for(f=0;f<this._filters.length;f++)this._filters[f](a,c);if(c.length!==d)for(f=a=0;f<b.length;f++)for(var d=
b[f],e=d.getGeometryRecords()[0],h=d.getMetadata().featureIds,g=0;g<h.length;g+=1){var l=h[g];a>=c.length||c[a]!==l?d.setComponentVisibility(e,g,!1):a++}}}};e.prototype._hideFeatures=function(a,b){var c=0;for(a=this._nodeId2Meta[a.id].engineObjects;c<a.length;c++)for(var d=a[c],f=d.getGeometryRecords()[0],e=d.getMetadata().features,h=d.hasComponents(),g=0,l=b;g<l.length;g++)for(var k=l[g],m=0;m<e.length;m++)k===e[m].id&&(h?d.setComponentVisibility(f,m,!1):d.hideAllComponents())};e.prototype._removeFeatures=
function(a,b){null!=this._nodeId2Meta[a.id]&&(this._hideFeatures(a,b),!0===this._isAllHidden(a)&&this._removeNodeDataFromStage(a))};e.prototype._removeNodeDataFromStage=function(a){if(null!=this._nodeId2Meta[a.id]&&null!=this._nodeId2Meta[a.id].engineObjects){for(var b=this._stage,c=this._engineLayer,d=0,f=this._nodeId2Meta[a.id].engineObjects,e=0;e<f.length;++e){var h=f[e],g=h.getMetadata(),d=d+(null!=g.featureIds?g.featureIds.length:1);c.removeObject(h);for(var g=h.getGeometryRecords(),l=0;l<g.length;l++){var k=
g[l];this.memEstimateGeometryRemoved(k.geometry.getData());b.remove(n.GEOMETRY,k.geometry.getId());for(var m=0;m<k.materials.length;m++){var r=k.materials[m],q=r.getId(),t=r.metadata.i3sMatId,v=r.metadata.i3sTexId||"none",u=this._matId2Meta[t][v];y(0<u.refCount);u.refCount--;0===u.refCount&&this._removeMaterial(q,v,t,r,b)}}b.remove(n.OBJECT,h.getId())}delete this._nodeId2Meta[a.id];this._notifyFeaturesChanged(0,d)}};e.prototype._emitFeaturesChangedEvent=function(){this.emit("features-changed",this._featuresChangedEvent);
this._featuresChangedEvent=null;this._featuresChangedEventScheduled=!1};e.prototype._cancelFeaturesChangedEvent=function(){this._featuresChangedEventScheduled=!1};e.prototype._notifyFeaturesChanged=function(a,b){var c=this;null==this._featuresChangedEvent&&(this._featuresChangedEvent={addedCount:0,removedCount:0});this._featuresChangedEvent.addedCount+=a;this._featuresChangedEvent.removedCount+=b;this._featuresChangedEventScheduled||null==this._controller||(this._featuresChangedEventScheduled=!0,
this._controller.queueAnimationFrameFunctionCall(function(){return c._emitFeaturesChangedEvent()},null,null,function(){return c._cancelFeaturesChangedEvent()},null))};e.prototype._removeMaterial=function(a,b,c,d,f){f.remove(n.MATERIAL,a);if("none"!==b){a=this._texId2Meta[b];var e=a.usedByEngineMats;d=e.indexOf(d);y(-1<d);e[d]=e[e.length-1];e.pop();1>e.length&&((d=a.engineTex)&&d!==this._initTexture&&(this.memEstimateTextureRemoved(d),f.remove(n.TEXTURE,a.engineTex.getId())),a.engineTex=void 0,a.desiredLOD=
-1,a.curLOD=-1,delete this._texId2Meta[b])}delete this._matId2Meta[c][b];P(this._matId2Meta[c])&&delete this._matId2Meta[c]};e.prototype._updateAllTextureLOD=function(){for(var a in this._texId2Meta)this._texId2Meta.hasOwnProperty(a)&&this._updateTextureLOD(this._texId2Meta[a])};e.prototype._calcDesiredTextureLOD=function(a,b){for(var c=0,d=0;d<a.length;d++){var f=a[d],e=J.vec3.dist(f,this._controller.camPos),f=2*f[3]/e*this._controller.screenSizeFactor;f>c&&(c=f)}c/=9;for(a=b.length-1;0<a&&b[a].size<
c;)a--;return a};e.prototype._updateTextureLOD=function(a){var b=this;a.desiredLOD=this._calcDesiredTextureLOD(a.featureMBS,a.images);if(a.curLOD!==a.desiredLOD&&(0>a.curLOD||!a.curLOD||0===a.desiredLOD||a.desiredLOD>a.curLOD||a.desiredLOD<a.curLOD-1)){if(0===a.images.length)return;var c=a.images[a.desiredLOD],d=-1<a.encodingIdx?c.hrefConcat[a.encodingIdx]:c.hrefConcat;if(!this._requestedTexImageIds[c.id]){var f={metadata:{texMeta:a,image:c}};this._requestedTexImageIds[c.id]=!0;this._imageIsPartOfTextureBundle(c)?
this._controller.streamDataSupplier.request(d,"binary",f).then(this._extractTextureImageFromBlob.bind(this)):this._controller.streamDataSupplier.request(d,"image",f).then(function(a,c,d,f){b._textureImageLoaded(a,c,f.image,f.texMeta)})}}a.engineTex||(a.engineTex=this._initTexture,a.curLOD=-1);if(this.debugLODVis)for(c=ja.fromHsv(a.desiredLOD/a.images.length*270,100,100).toRgb().map(function(a){return a/255}),d=0;d<a.usedByEngineMats.length;d++)a.usedByEngineMats[d].setParameterValues({ambient:c,diffuse:c})};
e.prototype._extractTextureImageFromBlob=function(a,b,c,d){var f=d.texMeta;if(0>f.desiredLOD||d.image.size>f.images[f.desiredLOD].size)delete this._requestedTexImageIds[d.image.id];else{var e=this;y("binary"===c);var h="";try{var g=c=0;-1<f.encodingIdx?(c=d.image.byteOffset[f.encodingIdx],g=d.image.length[f.encodingIdx]):(c=d.image.byteOffset,g=d.image.length);var l=new Uint8Array(b,c,g),k=new Blob([l],{type:f.encoding}),h=window.URL.createObjectURL(k)}catch(r){h="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4T2P8zyD6n4ECwDhqAMNoGDCMhgEwDw2DdAAAdzkhQdS8dl8AAAAASUVORK5CYII\x3d",
x.error("error loading texture "+a+" "+r)}var m=new Image;m.onerror=function(){window.URL.revokeObjectURL(h);m.src="";m.onerror=void 0;m.onload=void 0};m.onload=function(){e._controller.queueAnimationFrameFunctionCall(e._textureImageLoaded,e,[a,m,d.image,d.texMeta,h],void 0,1);window.URL.revokeObjectURL(h);m.src="";m.onerror=void 0;m.onload=void 0};m.src=h}};e.prototype._textureImageLoaded=function(a,b,c,d){delete this._requestedTexImageIds[c.id];if(!(0>d.desiredLOD)){a=d.images[d.desiredLOD];var f=
d.images[d.curLOD];if(!this.isOverMemory()||!(null==f||c.size>f.size))if(!f||c.size>f.size&&c.size<=a.size||c.size<f.size&&c.size>=a.size){(f=d.engineTex)&&f!==this._initTexture&&(this.memEstimateTextureRemoved(f),this._stage.remove(n.TEXTURE,d.engineTex.getId()));f=X(b,d,this._enableAtlasMipMaps,this._disableAtlasAnisotropy);d.engineTex=new L(b,d.id,f);this._stage.add(n.TEXTURE,d.engineTex);d.curLOD=d.desiredLOD;this.memEstimateTextureAdded(d.engineTex);b=d.engineTex.getId();for(f=0;f<d.usedByEngineMats.length;f++){var e=
d.usedByEngineMats[f];null==this._colorOverride&&e.setParameterValues({textureId:b});e.metadata.originalTextureId=b}c!==a&&(d.curLOD=d.images.indexOf(c),y(-1<d.curLOD),this._requestedTexImageIds[a.id]||(c={metadata:{texMeta:d,image:a}},this._requestedTexImageIds[a.id]=!0,this._controller.streamDataSupplier.request(a.hrefConcat,"binary",c).then(this._extractTextureImageFromBlob.bind(this))))}}};e.prototype._imageIsPartOfTextureBundle=function(a){return!this._controller.isMeshPyramid};e.prototype._setPolygonOffset=
function(a,b){if(null!=this._nodeId2Meta[a.id]&&null!=this._nodeId2Meta[a.id].engineObjectsPerBundle){b={polygonOffset:b};for(var c=0;c<this._nodeId2Meta[a.id].engineObjectsPerBundle.length;c++)for(var d=this._nodeId2Meta[a.id].engineObjectsPerBundle[c],f=0;f<d.length;f++)for(var e=d[f].getGeometryRecords(),h=0;h<e.length;h++)for(var g=e[h].materials,l=0;l<g.length;l++)g[l].setParameterValues(b)}};e.prototype._rendererChange=function(a){(this._currentRenderer=a)&&(a.colorInfo||a.sizeInfo)&&x.warn("renderer.colorInfo and renderer.sizeInfo are not supported for Scene Services. Use visualVariables instead.")};
e.prototype._getRenderingInfo=function(a){var b=this._currentRenderer,c=b&&b.getSymbol(a);if(!(c&&c instanceof ma))return null;var c={symbol:c},d,e;if(b&&b.visualVariables)for(a=b.getVisualVariableValues(a),b=0;b<a.length;b++){var p=a[b],h=p.variable.type;"color"===h?d=p.value:"opacity"===h&&(e=p.value)}d&&(c.color=[d.r/255,d.g/255,d.b/255]);null!=e?c.opacity=e:d&&null!=d.a&&(c.opacity=d.a);return c};e.prototype._getSymbolFillColor=function(a){a=a.symbolLayers;for(var b=0;b<a.length;b++){var c=a.getItemAt(b);
if("Fill"===c.type&&c.material&&c.material.color)return a=c.material.color,[a.r/255,a.g/255,a.b/255,a.a]}};e.prototype._setObjectSymbology=function(a){if(!(this.layer instanceof Q)){for(var b=a.getMetadata(),c=[],d=!1,e=b.faceRanges?b.faceRanges.length:1,p={attributes:{}},h=this.layer.objectIdField,g=this._currentRenderer&&this._currentRenderer.requiredFields,l=0;l<e;l++){null!=h&&null!=b.featureIds&&(p.attributes[h]=b.featureIds[l]);if(null!=g&&null!=b.attributeData)for(var k=0,m=g;k<m.length;k++){var n=
m[k];b.attributeData[n]&&(p.attributes[n]=D.getCachedAttributeValue(b.attributeData[n],l))}var q=this._getRenderingInfo(p),k=null!=b.faceRanges?b.faceRanges[l]:null;q?(m=q.color,n=q.opacity,null==m||null==n?(q=this._getSymbolFillColor(q.symbol),m=W.overrideColor(m,n,q,q&&q[3],aa)):m=W.overrideColor(m,n,null,null,aa),1>m[3]&&(d=!0),c.push({faceRanges:k,color:m})):c.push({faceRanges:k,color:void 0})}this.layer.cachedDrawingInfo.color?a.setFacerangeColors(c,"replace"):a.setFacerangeColors(c,"blend");
a=a.getGeometryRecords();for(b=0;b<a.length;b++)for(c=a[b],e=0;e<c.materials.length;e++)p=c.materials[e],h=p.getParams().transparent,g=p.getParams().opacity,p.metadata.symbolIsTransparent=d,l=this._calcEngineMaterialTransparencyParams(p.metadata.i3sTex,p.metadata.i3sMatParams,p.metadata.symbolIsTransparent),h===l.transparent&&g===l.opacity||p.setParameterValues({transparent:l.transparent,opacity:l.opacity})}};e.prototype._opacityChange=function(a){for(var b in this._matId2Meta)for(var c in this._matId2Meta[b]){a=
this._matId2Meta[b][c].engineMat;var d=a.getParams().transparent,e=a.getParams().opacity,p=this._calcEngineMaterialTransparencyParams(a.metadata.i3sTex,a.metadata.i3sMatParams,a.metadata.symbolIsTransparent);d===p.transparent&&e===p.opacity||a.setParameterValues({transparent:p.transparent,opacity:p.opacity})}};e.prototype.queryExtent=function(a){return this._ensureQueryEngine().queryExtent(a)};e.prototype.queryFeatureCount=function(a){return this._ensureQueryEngine().queryFeatureCount(a)};e.prototype.queryFeatures=
function(a){return this._ensureQueryEngine().queryFeatures(a)};e.prototype.queryObjectIds=function(a){return this._ensureQueryEngine().queryObjectIds(a)};e.prototype._ensureQueryEngine=function(){this._queryEngine||(this._queryEngine=this._createQueryEngine());return this._queryEngine};e.prototype._createQueryEngine=function(){var a=this,b={id:0,index:0,object:null,bbCorners:new Float64Array(24)};return new oa({forAll:function(c,d){a._forAllFeatures(function(d,e,h){b.id=d;b.index=e;b.object=h;d=b.object.getMetadata().faceRanges[b.index];
a._boundingBoxCornerPoints(d,b.object,b.bbCorners);c(b)},d)},createGraphic:function(b){return a._createGraphic(b.index,b.object.getMetadata())},requestFields:function(b,d,e){return D.whenGraphicAttributes(a.layer,d,a._getObjectIdField(),e,function(){var c=a._getGraphicIndices(b.node,b.bundleNr,d);return{node:b.node,indices:c}})},createExtentBuilder:function(){return a._createExtentBuilder()},createVisibilityFilter:function(){return a._createVisibilityFilter()}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField,
addVisibilityFilter:!0})};e.prototype._createExtentBuilder=function(){var a=this.view.renderSpatialReference,b=this.view.spatialReference,c=E.create(E.NEGATIVE_INFINITY),d=new Float64Array(24);return{add:function(e){N.bufferToBuffer(e.bbCorners,a,0,d,b,0,8)&&E.expandBuffer(c,d,0,8)},getExtent:function(){return new na({xmin:c[0],ymin:c[1],zmin:c[2],xmax:c[3],ymax:c[4],zmax:c[5],spatialReference:b})}}};e.prototype._createVisibilityFilter=function(){var a=this.view._stage.getCamera().frustumPlanes,b=
0;return function(c){c=qa.conservativeFrustumConvexBuffer(a,c.bbCorners,0,8,b);return 0<=c?(b=c,!1):!0}};e.prototype._forAllFeatures=function(a,b){for(var c=0,d=Object.keys(this._nodeId2Meta);c<d.length;c++)for(var e=d[c],n=this._nodeId2Meta[e].engineObjects,h=0;h<n.length;h++){for(var g=n[h],l=g.getMetadata().featureIds,k=g.getGeometryRecords()[0],m=0;m<l.length;m++)g.getComponentVisibility(k,m)&&a(l[m],m,g);b&&b({node:this._controller.nodeIndex[e],bundleNr:h})}};e.prototype._createGraphic=function(a,
b){var c={};c[this._getObjectIdField()]=b.featureIds[a];for(var d=0,e=Object.keys(b.attributeData);d<e.length;d++){var n=e[d];c[n]=D.getCachedAttributeValue(b.attributeData[n],a)}a=new V(null,null,c);a.layer=this.layer;return a};e.prototype._boundingBoxCornerPoints=function(a,b,c){a=b.geometries[0].calculateAABB(0,a);for(var d=0;8>d;++d){var e=[d&1?a[0]:a[3],d&2?a[1]:a[4],d&4?a[2]:a[5]];J.mat4d.multiplyVec3(b.objectTransformation,e);c[3*d]=e[0];c[3*d+1]=e[1];c[3*d+2]=e[2]}return c};return e}(A.declared(la,
pa));z([A.property()],q.prototype,"layer",void 0);z([A.property()],q.prototype,"view",void 0);z([A.property()],q.prototype,"_controller",void 0);z([A.property({dependsOn:["_controller.updating"]})],q.prototype,"updating",void 0);z([A.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],q.prototype,"updatingPercentageValue",void 0);return q=z([A.subclass("esri.views.3d.layers.SceneLayerView3D")],q)});