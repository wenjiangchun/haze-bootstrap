// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define(["require","exports","./Util","./gl-matrix","./ComponentUtils"],function(q,x,r,l,t){q=l.vec3d;var h=l.vec4d,k=l.mat4d;l=function(){function f(){this._context={content:[],near:[],far:[],nearSpecial:[],farSpecial:[],bestNear:0,bestFar:0,bestNear2:0,bestFar2:0};this._boundingInfoHelper=new v}f.prototype._resetContext=function(){var b=this._context;b.content.length=0;b.near.length=0;b.far.length=0;b.nearSpecial.length=0;b.farSpecial.length=0;b.bestNear=Number.MAX_VALUE;b.bestFar=-Number.MAX_VALUE;
return this._context};f.prototype.calculateSceneNearFar=function(b,a,d){var c=this._resetContext(),e=b.viewMatrix,m=e[2],f=e[6],u=e[10],h=e[14],k=0,g;for(g in a)if(e=a[g],!t.isAllHidden(e.instanceParameters.componentVisibilities,e.componentOffsets)&&e.castShadow&&d.get(e.idx)){var l=e.bsRadius,p=e.center,n=m*p[0]+f*p[1]+u*p[2]+h,p=n-l,l=n+l;c.content[k]=e;c.near[k]=-l;c.far[k]=-p;++k}if(0===k)return[c.bestNear,c.bestFar];for(a=0;a<k;++a)c.near[a]>c.bestFar&&(c.bestFar=c.near[a]),2<c.near[a]&&c.far[a]<
c.bestNear&&(c.bestNear=c.far[a]);c.bestNear2=Math.max(.5*c.bestNear,2);c.bestFar2=2*c.bestFar;for(a=m=d=0;a<k;++a)c.near[a]<c.bestNear&&(c.near[a]>=c.bestNear2?c.bestNear=c.near[a]:c.nearSpecial[d++]=a),c.far[a]>c.bestFar&&(c.far[a]<=c.bestFar2?c.bestFar=c.far[a]:c.farSpecial[m++]=a);if(0===d&&0===m)return[c.bestNear,c.bestFar];c.nearSpecial.length=d;c.farSpecial.length=m;c.nearSpecial.sort(function(a,b){return c.near[a]<c.near[b]?-1:c.near[a]>c.near[b]?1:0});c.farSpecial.sort(function(a,b){return c.far[a]<
c.far[b]?1:c.far[a]>c.far[b]?-1:0});this._boundingInfoHelper.init(b,c);for(a=0;a<d;++a)c.near[c.nearSpecial[a]]<c.bestNear&&(e=c.content[c.nearSpecial[a]],b=e.boundingInfo,this._boundingInfoHelper.includeNearBoundingInfoRec(b,e.transformation));for(a=0;a<m;++a)c.far[c.farSpecial[a]]>c.bestFar&&(e=c.content[c.farSpecial[a]],b=e.boundingInfo,this._boundingInfoHelper.includeFarBoundingInfoRec(b,e.transformation));return[c.bestNear,c.bestFar]};return f}();var v=function(){function f(){this._clippingHelper=
new w;this._planes=[h.create(),h.create(),h.create(),h.create(),h.create(),h.create()];this._viewProj=k.create();this._view=k.create()}f.prototype.init=function(b,a){this._context=a;k.set(b.viewMatrix,this._view);k.multiply(b.projectionMatrix,this._view,this._viewProj);b.copyFrustumPlanes(this._planes);this._clippingHelper.init(a)};f.prototype.includeNearBoundingInfoRec=function(b,a){var d=b.getBSRadius(),c=b.getCenter();k.multiplyVec3(a,c,g);var c=g[0],e=g[1],f=g[2],d=d*Math.sqrt(Math.max(Math.max(a[0]*
a[0]+a[4]*a[4]+a[8]*a[8],a[1]*a[1]+a[5]*a[5]+a[9]*a[9]),a[2]*a[2]+a[6]*a[6]+a[10]*a[10]));if(!(this._planes[0][0]*c+this._planes[0][1]*e+this._planes[0][2]*f+this._planes[0][3]>d||this._planes[1][0]*c+this._planes[1][1]*e+this._planes[1][2]*f+this._planes[1][3]>d||this._planes[2][0]*c+this._planes[2][1]*e+this._planes[2][2]*f+this._planes[2][3]>d||this._planes[3][0]*c+this._planes[3][1]*e+this._planes[3][2]*f+this._planes[3][3]>d||(c=this._view[2]*c+this._view[6]*e+this._view[10]*f+this._view[14],
e=c+d,2>-(c-d)||-e>=this._context.bestNear)))if(-e>this._context.bestNear2)this._context.bestNear=-e;else{if(100<d&&(d=b.getChildren(),void 0!==d)){for(b=0;8>b;++b)void 0!==d[b]&&this.includeNearBoundingInfoRec(d[b],a);return}this._clippingHelper.intersectFrustumAABB(this._viewProj,a,b.getBBMin(),b.getBBMax())}};f.prototype.includeFarBoundingInfoRec=function(b,a){var d=b.getBSRadius(),c=b.getCenter();k.multiplyVec3(a,c,g);var c=g[0],e=g[1],f=g[2],d=d*Math.sqrt(Math.max(Math.max(a[0]*a[0]+a[4]*a[4]+
a[8]*a[8],a[1]*a[1]+a[5]*a[5]+a[9]*a[9]),a[2]*a[2]+a[6]*a[6]+a[10]*a[10]));if(!(this._planes[0][0]*c+this._planes[0][1]*e+this._planes[0][2]*f+this._planes[0][3]>d||this._planes[1][0]*c+this._planes[1][1]*e+this._planes[1][2]*f+this._planes[1][3]>d||this._planes[2][0]*c+this._planes[2][1]*e+this._planes[2][2]*f+this._planes[2][3]>d||this._planes[3][0]*c+this._planes[3][1]*e+this._planes[3][2]*f+this._planes[3][3]>d||(c=this._view[2]*c+this._view[6]*e+this._view[10]*f+this._view[14]-d,-c<=this._context.bestFar)))if(-c<
this._context.bestFar2)this._context.bestFar=-c;else{if(100<d&&(d=b.getChildren(),void 0!==d)){for(b=0;8>b;++b)void 0!==d[b]&&this.includeFarBoundingInfoRec(d[b],a);return}this._clippingHelper.intersectFrustumAABB(this._viewProj,a,b.getBBMin(),b.getBBMax())}};return f}(),w=function(){function g(){this._clipP=Array(8);for(var b=0;8>b;++b)this._clipP[b]=h.create()}g.prototype.init=function(b){this._context=b};g.prototype.intersectFrustumAABB=function(b,a,d,c){k.multiply(b,a,f);for(b=0;8>b;++b){a=this._clipP[b];
var e=0===b||3===b||4===b||7===b?d[0]:c[0],g=0===b||1===b||4===b||5===b?d[1]:c[1],h=4>b?d[2]:c[2];a[0]=f[0]*e+f[4]*g+f[8]*h+f[12];a[1]=f[1]*e+f[5]*g+f[9]*h+f[13];a[2]=f[2]*e+f[6]*g+f[10]*h+f[14];a[3]=f[3]*e+f[7]*g+f[11]*h+f[15]}for(b=0;12>b;++b){d=this._clipTriangle(this._clipP[n[b][0]],this._clipP[n[b][1]],this._clipP[n[b][2]]);c=!0;for(a=0;a<d.length;++a)if(e=d[a][3],2<=e){c=!1;break}if(!c)for(a=0;a<d.length;++a)e=d[a][3],e<this._context.bestNear&&(this._context.bestNear=e),e>this._context.bestFar&&
(this._context.bestFar=e)}};g.prototype._inside=function(b,a){if(0===a)return b[0]>=-b[3];if(1===a)return b[1]>=-b[3];if(2===a)return b[0]<=b[3];if(3===a)return b[1]<=b[3];r.assert(!1)};g.prototype._intersect=function(b,a,d){var c=0;0===d?c=(-b[3]-b[0])/(a[0]-b[0]+a[3]-b[3]):1===d?c=(-b[3]-b[1])/(a[1]-b[1]+a[3]-b[3]):2===d?c=(b[3]-b[0])/(a[0]-b[0]-a[3]+b[3]):3===d&&(c=(b[3]-b[1])/(a[1]-b[1]-a[3]+b[3]));return h.lerp(b,a,c,h.create())};g.prototype._clipTriangle=function(b,a,d){b=[b,a,d];for(a=0;4>
a;++a){d=b;b=[];for(var c=0;c<d.length;++c){var e=d[c],f=d[(c+1)%d.length];this._inside(f,a)?(this._inside(e,a)||b.push(this._intersect(e,f,a)),b.push(f)):this._inside(e,a)&&b.push(this._intersect(e,f,a))}}return b};return g}(),n=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],g=q.create(),f=k.create();return l});