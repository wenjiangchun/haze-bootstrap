// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../InputHandler ./support ../../../core/now".split(" "),function(d,g,h,k,l,m){d=function(d){function b(){var a=d.call(this,"recognizers.Drag",!1)||this;a._startStateModifiers=new Set;a._activePointers=[];a._activePointerMap=new Map;a._isDragging=!1;a._drag=a.registerOutgoing("drag");a.registerIncoming("pointer-drag",a._handlePointerDrag.bind(a));a.registerIncoming("pointer-down",a._handlePointerDown.bind(a));a.registerIncoming("pointer-up",
a._handlePointerUpAndPointerLost.bind(a));a.registerIncoming("pointer-capture-lost",a._handlePointerUpAndPointerLost.bind(a));return a}h(b,d);b.prototype._createPayload=function(a,e){return{action:a,pointers:this._activePointers.map(function(a){return a.data}),startState:this._startState,previousState:this._previousState,currentState:e}};b.prototype._fitCircleLSQ=function(){var a=this._activePointers.map(function(a){return a.data.currentEvent});return l.fitCircleLSQ(a)};b.prototype._createDragState=
function(){for(var a=this._fitCircleLSQ(),e=0,c=0,b=this._activePointers;c<b.length;c++){for(var d=b[c],f=this._pointerAngle(d,a),f=f-d.lastAngle;f>Math.PI;)f-=2*Math.PI;for(;f<-Math.PI;)f+=2*Math.PI;f=d.lastAngle+f;d.lastAngle=f;e+=f-d.initialAngle}e/=this._activePointers.length;return{angle:e,radius:a.radius,center:a.center,timeStamp:m()}};b.prototype._updateMultiPointer=function(a){var e=a.startEvent.native.pointerId,c=this._activePointerMap.get(e),b=!c;b?(c={data:null,initialAngle:0,lastAngle:0},
this._activePointers.push(c),this._activePointerMap.set(e,c),c.data={startEvent:a.startEvent,previousEvent:a.previousEvent,currentEvent:a.currentEvent},a=this._fitCircleLSQ(),c.initialAngle=this._pointerAngle(c,a),c.lastAngle=c.initialAngle):c.data={startEvent:c.data.startEvent,previousEvent:a.previousEvent,currentEvent:a.currentEvent};b&&this._isDragging&&this._updateInitialAngles();return c};b.prototype._pointerAngle=function(a,e){a=a.data.currentEvent;return Math.atan2(a.y-e.center.y,a.x-e.center.x)};
b.prototype._updateInitialAngles=function(){for(var a=this._createDragState(),e=0,c=this._activePointers;e<c.length;e++){var b=c[e];b.initialAngle=this._pointerAngle(b,a)}};b.prototype._emitStart=function(a){this._updateInitialAngles();var b=this._createDragState();this._previousState=this._startState=b;this._startStateModifiers=a.modifiers;this._isDragging=!0;a=0;for(var c=this._activePointers;a<c.length;a++){var d=c[a];d.data={previousEvent:d.data.currentEvent,startEvent:d.data.currentEvent,currentEvent:d.data.currentEvent}}this._drag.emit(this._createPayload("start",
b))};b.prototype._emitUpdate=function(){var a=this._createDragState();this._drag.emit(this._createPayload("update",a),this._startStateModifiers);this._previousState=a};b.prototype._emitEnd=function(){var a=this._createDragState();this._drag.emit(this._createPayload("end",a),this._startStateModifiers);this._startState=this._previousState=null;this._isDragging=!1};b.prototype._handlePointerDown=function(a){a=a.data;this._isDragging&&this._emitEnd();this._updateMultiPointer({startEvent:a,previousEvent:a,
currentEvent:a})};b.prototype._removeMultiPointer=function(a){a=a.pointerId;var b=this._activePointerMap.get(a);b&&(this._isDragging&&this._emitEnd(),this._activePointerMap.delete(a),a=this._activePointers.indexOf(b),this._activePointers.splice(a,1),this._isDragging&&this._updateInitialAngles())};b.prototype._handlePointerUpAndPointerLost=function(a){this._removeMultiPointer(a.data.native)};b.prototype._handlePointerDrag=function(a){var b=a.data;switch(b.action){case "start":this._isDragging||this._emitStart(a);
break;case "update":this._isDragging||this._emitStart(a),this._updateMultiPointer(b),this._emitUpdate()}};return b}(k.InputHandler);g.Drag=d});