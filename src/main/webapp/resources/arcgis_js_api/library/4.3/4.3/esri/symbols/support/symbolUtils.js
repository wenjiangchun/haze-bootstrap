// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports dojo/has dojo/_base/lang ../Symbol3D ./jsonUtils ./Thumbnail ./StyleOrigin ../../core/urlUtils ../../core/promiseUtils ../../core/Error ../../request ../../portal/Portal ../../portal/PortalQueryParams".split(" "),function(K,c,q,A,B,C,r,t,l,h,g,D,E,u){function k(a,b){a=l.normalize(l.makeAbsolute(a,b));b=a.lastIndexOf("/");return-1===b?{url:a,base:a,filename:null}:{url:a,base:a.slice(0,b),filename:a.slice(b+1)}}function F(a,b){v(a,function(a){return k(a,b).url})}function G(a,
b){a.symbolLayers&&a.symbolLayers.forEach(b)}function v(a,b){G(a,function(a){(a=a.resource)&&a.href&&(a.href=b(a.href))})}function H(a){v(a,function(a){return/\.svg$/.test(a)?(a.slice(0,a.length-4)+".png").replace("/resource/","/resource/png/"):a})}function m(a,b){a=A.clone(a);F(a,b);(q("ie")||q("trident"))&&H(a);return C.fromJSON(a)}function w(a,b){var e=k(a,b&&b.url&&b.url.path);return n(e.url).then(function(b){return{reference:{styleUrl:a},data:b.data,base:e.base,filename:e.filename,styleUrl:a}})}
function I(a,b){b=b.portal||E.getDefault();var e,f=b.url+" - "+a;return p[f]?h.resolve(p[f]):J(a,b).then(function(a){e=a;return a.fetchData()}).then(function(b){b={data:b,base:e.itemUrl,filename:"data",styleName:a};return p[f]=b})}function J(a,b){return b.load().then(function(){if(!b.stylesGroupQuery)throw new g("layer-templates:styles-group-query-missing","The styles group query needs to be configured in the portal to query styles");var a=new u({disableExtraQuery:!0,query:b.stylesGroupQuery});return b.queryGroups(a)}).then(function(b){b=
b.results;if(!b||!Array.isArray(b)||0===b.length)throw new g("layer-templates:styles-missing","The styles group does not contain any styles");b=b[0];var e=new u({disableExtraQuery:!0,query:'typekeywords:"'+a+'"'});return b.queryItems(e)}).then(function(b){b=b.results;if(!b||!Array.isArray(b)||0===b.length)throw new g("layer-templates:style-missing","The style '${styleName}' is not part of the styles group",{styleName:a});return b[0].load()})}function x(a,b){return a.styleUrl?w(a.styleUrl,b):a.styleName?
I(a.styleName,b):h.reject(new g("layer-templates:style-url-and-name-missing","Either styleUrl or styleName is required in layerDefinition"))}function y(a,b,e){for(var f=function(f){if(f.name===b){var c=k(f.webRef,a.base);return{value:n(c.url).then(function(d){(d=m(d.data,c.base))&&d.isInstanceOf(B)&&(f.thumbnail&&(f.thumbnail.href?d.thumbnail=new r.default({url:f.thumbnail.href}):f.thumbnail.imageData&&(d.thumbnail=new r.default({url:"data:image/png;base64,"+f.thumbnail.imageData}))),a.styleUrl?d.styleOrigin=
new t({portal:e.portal,styleUrl:a.styleUrl,name:b}):a.styleName&&(d.styleOrigin=new t({portal:e.portal,styleName:a.styleName,name:b})));return d})}}},d=0,c=a.data.items;d<c.length;d++){var z=f(c[d]);if("object"===typeof z)return z.value}return h.reject(new g("layer-templates:symbol-name-not-found","The symbol name '${symbolName}' could not be found",{symbolName:b}))}function n(a){var b={responseType:"json"};/\.json$/.test(a)||(b.query={f:"json"});return D(l.normalize(a),b)}c.fetchStyleFromUrl=w;var p=
{};c.fetchStyle=x;c.fetchStyleSymbol=function(a,b){return a.name?x(a,b).then(function(e){return y(e,a.name,b)}):h.reject(new g("layer-templates:style-symbol-reference-name-missing","Missing name in style symbol reference"))};c.fetchSymbolFromStyle=y;c.fetchSymbolSet=function(a){var b=a.data;if(!b.symbolSetUrl)return h.reject(new g("layer-templates:symbol-set-url-missing","Style does not provide symbol set URL",{style:b}));var e=k(b.symbolSetUrl,a.base);return n(e.url).then(function(a){a=a.data;if(0===
a.length||!a[0].name)throw new g("layer-templates:symbol-set-missing-data","Invalid syntax or missing data in symbol set",{style:b});for(var d={},c=0;c<a.length;c++){var f=m(a[c],e.base);d[a[c].name]=f;a[c].name===b.defaultItem&&(d.defaultSymbol=f)}d.defaultSymbol||(d.defaultSymbol=d[a[0].name]);return d})};c.createSymbol=function(a,b){return a?m(a,b&&b.url&&b.url.path):null};c.styleNameFromItem=function(a){var b=0;for(a=a.typeKeywords;b<a.length;b++){var c=a[b];if(/^Esri.*Style$/.test(c))return c}};
c.isVolumetricSymbol=function(a){return(a=a&&a.symbolLayers)?a.some(function(a){a=a.type;return"Object"===a||"Path"===a||"Extrude"===a}):!1}});