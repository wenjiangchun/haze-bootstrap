// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports dojo/_base/lang ../../../tasks/support/StatisticDefinition ./classBreaks ../../../core/promiseUtils ./support/utils ../support/utils".split(" "),function(B,C,m,q,r,f,d,k){function t(a){if(!(a&&a.layer&&(a.field||a.valueExpression||a.sqlExpression)))return f.reject(d.createError("summary-statistics:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));var b=m.mixin({},a);b.normalizationType=d.getNormalizationType(b);b.layer=
k.createLayerAdapter(b.layer);return b.layer?b.layer.load().then(function(){var a=b.layer,e=b.field,n=b.normalizationType,h="function"===typeof e,p=b.valueExpression||b.sqlExpression,g=e?a.getField(e):null,e=g?"date"===g.type:!1,l=k.getFieldsList({field:b.field,normalizationField:b.normalizationField,valueExpression:b.valueExpression});if(l=d.verifyBasicFieldValidity(a,l,"summary-statistics:invalid-parameters"))return f.reject(l);if(g){if(g=d.verifyFieldType(a,g,"summary-statistics:invalid-parameters",
u))return f.reject(g);if(e&&n)return f.reject(d.createError("summary-statistics:invalid-parameters","Normalization is not allowed for date fields"))}else if(p&&n)return f.reject(d.createError("summary-statistics:invalid-parameters","Normalization is not allowed when 'valueExpression' or 'sqlExpression' is specified"));return a.hasLocalSource||b.features||h?f.reject(d.createError("summary-statistics:not-implemented","Client-side calculation is not implemented yet")):a.supportsSQLExpression||!e&&!p?
b:f.reject(d.createError("summary-statistics:not-supported","Layer does not support standardized SQL expression for queries"))}):f.reject(d.createError("summary-statistics:invalid-parameters","'layer' must be one of these types: "+v))}function w(a){var b=a.normalizationType,c=a.normalizationField;return r({layer:a.layer,field:a.field,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:b,normalizationField:"field"===b?c:void 0,minValue:a.minValue,maxValue:a.maxValue}).then(function(a){var b,
h,c;a.classBreakInfos.some(function(a){a.hasAvg&&(b=a);return!!b});b&&(c=b.maxValue-b.minValue,h=b.minValue+c/2,c*=4);return{min:a.minValue,max:a.maxValue,avg:h,stddev:c}})}function x(a){var b=a.layer,c=a.field,e=a.sqlExpression||c,c=e?d.getRangeExpr(e,a.minValue,a.maxValue):null;a={sqlFormat:a.sqlExpression?"standard":null,where:d.mergeWhereClauses(a.sqlWhere,c),outStatistics:y.map(function(a){var b=new q;b.statisticType=a;b.onStatisticField=e;b.outStatisticFieldName=("var"===a?"variance":a)+"_value";
return b})};return b.queryStatistics(a).then(function(a){a=(a=a&&a.features)&&a[0]&&a[0].attributes;var b={},c;for(c in a)b[c.replace(z,"").toLowerCase()]=a[c];b.min===b.max&&null!=b.min&&null==b.stddev&&(b.stddev=b.variance=0);return b})}function A(a,b){var c,e=a.field,f=a.layer;f.supportsSQLExpression&&b&&(c=m.mixin({},a),delete c.field,c.sqlExpression=d.msSinceUnixEpochSQL(f,e));return x(c||a).then(function(a){b&&("min max avg stddev sum variance".split(" ").forEach(function(b){null!=a[b]&&(a[b]=
Math.ceil(a[b]))}),a.min===a.max&&null!=a.min&&(a.avg=a.min,a.stddev=a.variance=0));return a})}var u=[].concat(["integer","small-integer","single","double"]).concat("date"),z=/_value$/i,y="min max avg stddev count sum var".split(" "),v=k.supportedLayerTypes.join(", ");return function(a){return t(a).then(function(a){var b=a.field?a.layer.getField(a.field):null,b=b?"date"===b.type:!1;return a.normalizationType?w(a):A(a,b)})}});