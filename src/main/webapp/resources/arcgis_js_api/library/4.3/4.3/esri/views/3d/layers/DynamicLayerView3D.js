// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("../../layers/LayerView ../../../geometry/Extent ../../../core/urlUtils ../../../core/promiseUtils ../../../core/HandleRegistry ../../../layers/support/ExportImageParameters ./support/projectExtentUtils ../lib/glMatrix ../webgl-engine/Stage ../webgl-engine/lib/Texture ../webgl-engine/lib/RenderGeometry ../webgl-engine/lib/GeometryData ../webgl-engine/lib/GeometryUtil ../webgl-engine/materials/Material ../webgl-engine/lib/Util".split(" "),function(n,A,p,B,C,D,E,F,f,G,H,I,J,K,q){var r=q.assert,
L=F.mat4d,g=q.VertexAttrConstants;n=n.createSubclass({declaredClass:"esri.views.3d.layers.DynamicLayerView3D",supportsDraping:!0,hasDraped:!0,drawingOrder:0,_updatingOverlay:!1,_handles:null,_exportImageParameters:null,_imageVersion:null,constructor:function(){this._extents=[];this._images=[];this.fullExtentInViewSpatialReference=null;this._handles=new C},initialize:function(){this.drawingOrder=this.view.getDrawingOrder(this.layer.uid);this._handles.add(this.watch("suspended",function(a){if(a)this.clear(),
this.emit("draped-data-change");else{a=this._extents.length;for(var b=0;b<a;b++)this.fetch(b)}}.bind(this)));this._exportImageParameters=new D({layer:this.layer});var a=this.notifyChange.bind(this,"suspended");this._handles.add([this.watch("fullOpacity",this._opacityChangeHandler.bind(this)),this.layer.watch("minScale",a),this.layer.watch("maxScale",a),this._exportImageParameters.watch("version",function(a){this._imageVersion!==a&&(this._imageVersion=a,this._refetch())}.bind(this))],"layer");this.view.resourceController.registerIdleFrameWorker(this,
{idleBegin:function(){this._hasScaleRange()&&this.notifyChange("suspended")}});(a=E.toView(this).then(function(a){this.fullExtentInViewSpatialReference=a}.bind(this)))&&this.addResolvingPromise(a)},destroy:function(){this.clear();this._handles.destroy();this.view.resourceController.deregisterIdleFrameWorker(this);this._exportImageParameters&&(this._exportImageParameters.layer=null,this._exportImageParameters.destroy(),this._exportImageParameters=null)},getPopupData:function(a){var b=this.view.scale;
return this.layer.allSublayers.filter(function(a){var d=0===a.minScale||b<=a.minScale,c=0===a.maxScale||b>=a.maxScale;return a.popupTemplate&&a.visible&&d&&c}).map(function(b){var d=b.createQuery();d.geometry=a;d.outFields=this.getTemplateOutFields(b.popupTemplate);return b.queryFeatures(d).then(function(a){return a.features})},this)},getTemplateOutFields:function(a){if(!a||!a.fieldInfos)return["*"];var b=[];a.fieldInfos.forEach(function(a){var d=a.fieldName&&a.fieldName.toLowerCase();d&&"shape"!==
d&&0!==d.indexOf("relationships/")&&b.push(a.fieldName)});return b},setDrapingExtent:function(a,b,d,e){var c=(b[2]-b[0])/(b[3]-b[1]);this._extents[a]={extent:b,spatialReference:d,imageSize:1.0001<c?[e,e/c]:.9999>c?[e*c,e]:[e,e]};this.suspended||this.fetch(a)},fetch:function(a){var b=this._extents[a],d=b.extent,e=new A(d[0],d[1],d[2],d[3],b.spatialReference);this._exportImageParameters.scale!==this.view.scale&&(this._exportImageParameters.scale=this.view.scale);this._imageVersion=this._exportImageParameters.version;
this._images[a]||(this._images[a]={texture:null,material:null,rendergeometry:null,domImage:null,domImageCancelled:!1,worldExtent:d,loading:!1});var c=this._images[a];c.loading=!0;c.imageUrlPromise&&c.imageUrlPromise.cancel();c.domImageCancelled=!0;var g={extent:e,width:b.imageSize[0],height:b.imageSize[1]};c.imageUrlPromise=B.wrapCallback(function(a){this.layer.getImageUrl(g,a)}.bind(this));c.imageUrlPromise.then(function(b){c.imageUrlPromise=null;c.domImage||(c.domImage=new Image);var e=c.domImage;
0!==b.indexOf("data:")&&p.canUseXhr(b)&&(e.crossOrigin="anonymous");e.src=p.normalize(b);c.domImageCancelled=!1;e.onload=function(){c.domImageCancelled||(c.worldExtent=d,this._createStageObjects(a,e),0===a&&this._images[1]&&this._images[1].rendergeometry&&this._createStageObjects(1,null),c.loading=!1,this._evaluateUpdatingState(),this.emit("draped-data-change"))}.bind(this);e.onerror=function(){c.domImageCancelled||(c.loading=!1,this._clearDomImage(c),this._evaluateUpdatingState())}.bind(this);this._evaluateUpdatingState()}.bind(this))},
clear:function(){for(var a in this._images)this.clearImage(a)},clearImage:function(a){if(a=this._images[a])a.rendergeometry&&(this.view._stage.getTextureGraphicsRenderer().removeRenderGeometries([a.rendergeometry]),a.rendergeometry=null),a.texture&&(this.view._stage.remove(f.ModelContentType.TEXTURE,a.texture.getId()),a.texture=null),a.material&&(this.view._stage.remove(f.ModelContentType.MATERIAL,a.material.getId()),a.material=null),this._clearDomImage(a),a.loading=!1},canResume:function(){if(!this.inherited(arguments))return!1;
var a=this.layer.minScale,b=this.layer.maxScale;if(0<a||0<b){var d=this.view.scale;if(d<b||0<a&&d>a)return!1}return!0},_refetch:function(){for(var a=0;a<this._extents.length;a++)this._extents[a]&&this.fetch(a)},_drawingOrderSetter:function(a){if(a!==this._get("drawingOrder")){this._set("drawingOrder",a);var b={};this._images.forEach(function(d){d&&d.material&&(d.material.setRenderPriority(a),b[d.material.getId()]=!0)});q.objectEmpty(b)||(this.view._stage.getTextureGraphicsRenderer().updateRenderOrder(b),
this.emit("draped-data-change"))}},_hasScaleRange:function(){return 0<this.get("layer.minScale")||0<this.get("layer.maxScale")},_opacityChangeHandler:function(a){this._images.forEach(function(b){b&&b.material&&b.material.setParameterValues({opacity:a})}.bind(this));this.emit("draped-data-change")},_clearDomImage:function(a){a.domImage&&(a.domImage.removeAttribute("src"),a.domImage.removeAttribute("onload"),a.domImage.removeAttribute("onerror"),a.domImage=null)},_evaluateUpdatingState:function(){this.notifyChange("updating")},
isUpdating:function(){if(this._updatingOverlay)return!0;var a=!1,b;for(b in this._images)if(this._images[b].loading){a=!0;break}return a},_createStageObjects:function(a,b){var d=this.view._stage,e=d.getTextureGraphicsRenderer(),c=this._images[a];b?(c.texture&&d.remove(f.ModelContentType.TEXTURE,c.texture.getId()),c.texture=new G(b,"dynamicMapLayer",{width:b.width,height:b.height}),d.add(f.ModelContentType.TEXTURE,c.texture)):r(c.texture);c.material?b&&c.material.setParameterValues({textureId:c.texture.getId()}):
(c.material=new K({ambient:[1,1,1],diffuse:[0,0,0],transparent:!0,opacity:this.fullOpacity,textureId:c.texture.getId(),receiveSSAO:!1},"dynamicMapLayer"),c.material.setRenderPriority(this.drawingOrder),d.add(f.ModelContentType.MATERIAL,c.material));if(0===a)a=c.worldExtent,a=J.createSquareGeometry([[a[0],a[1],-1],[a[2],a[1],-1],[a[2],a[3],-1],[a[0],a[3],-1]]);else{r(1===a);a=this._images[0].worldExtent;if(!a)return;a=M(a,c.worldExtent,-1)}b=new H(a);b.material=c.material;b.origin={vec3:[0,0,0],id:"0_0"};
b.transformation=L.identity();b.name="dynamicMapLayer";b.uniqueName="dynamicMapLayer#"+a.id;e.addRenderGeometries([b]);c.rendergeometry&&e.removeRenderGeometries([c.rendergeometry]);c.rendergeometry=b}});var M=function(){var a=new Float32Array([0,0,1]);return function(b,d,e){var c=[b[1]-d[1],b[3]-b[1],d[3]-b[3],123456],f=[b[0]-d[0],b[2]-b[0],d[2]-b[2],123456],n=d[2]-d[0],q=d[3]-d[1],t=0<f[0]&&0<f[2]?3:2;b=0<c[0]&&0<c[2]?3:2;var l=(b+1)*(t+1),h=new Float32Array(3*l),l=new Float32Array(2*l);b=new Uint32Array(6*
(b*t-1));for(var w=0,x=0,p=0,k=0,m=0,u=0;4>u;u++){var r=c[u];if(!(0>=r)){for(var y=0,v=0;4>v;v++){var z=f[v];0>=z||(h[x++]=d[0]+y,h[x++]=d[1]+w,h[x++]=e,l[p++]=y/n,l[p++]=w/q,3>v&&3>u&&(1!==v||1!==u)&&(b[m++]=k,b[m++]=k+1,b[m++]=k+t+1,b[m++]=k+1,b[m++]=k+t+2,b[m++]=k+t+1),k++,y+=z)}w+=r}}d={};d[g.POSITION]={size:3,data:h};d[g.NORMAL]={size:3,data:a};d[g.UV0]={size:2,data:l};e={};c=new Uint32Array(b.length);for(h=0;h<c.length;h++)c[h]=0;e[g.POSITION]=b;e[g.NORMAL]=c;e[g.UV0]=b;return new I(d,e)}}();
return n});