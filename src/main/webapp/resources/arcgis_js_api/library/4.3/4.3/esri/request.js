// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require dojo/_base/array dojo/_base/config dojo/Deferred dojo/_base/lang dojo/_base/url dojo/request dojo/io-query dojo/when ./kernel ./config ./core/sniff ./core/lang ./core/urlUtils ./core/deferredUtils ./core/promiseUtils dojo/has!host-browser?dojo/io/script dojo/has!host-browser?dojo/io/iframe dojo/has!host-browser?dojo/dom-construct".split(" "),function(Z,C,D,O,r,u,E,P,aa,t,ba,g,B,m,ca,S,da,ea,T){function fa(a,c){var b=P.objectToQuery(a.content);b&&(a.url+=(-1===a.url.indexOf("?")?"?":
"\x26")+b);if(2E3<a.url.length)return S.reject(r.mixin(Error(),{message:"When using responseType 'image', URL length cannot exceed 2000 characters."}));var d=new Image;a.allowImageDataAccess&&(a.withCredentials?d.crossOrigin="use-credentials":c&&(d.crossOrigin="anonymous"));var f=!1,h=new O(function(a){f=!0;d.onload=d.onerror=d.onabort=null;d.src=""});c=function(a){d.onload=d.onerror=d.onabort=null;f||h.reject(a)};d.onload=function(){d.onload=d.onerror=d.onabort=null;f||h.resolve(this)};d.onerror=
c;d.onabort=c;d.alt="";d.src=a.url;return h.promise}function H(a){a=new u(a);return(a.host+(a.port?":"+a.port:"")).toLowerCase()}function U(a,c,b){var d=!!a.useProxy,f=a.method||"auto",h;h=a.crossOrigin;a=r.mixin({},a);a._ssl&&(a.url=a.url.replace(/^http:/i,"https:"));var F=a.content,p=a.url,k=c&&a.form;h=B.isDefined(h)?h:l.useCors;a.load=function(a){var b;a&&(a.error?(b=r.mixin(Error(),a.error),b.log=D.isDebug):"error"===a.status&&(b=r.mixin(Error(),a),b.log=D.isDebug),b&&!B.isDefined(b.httpCode)&&
(b.httpCode=b.code));return b||a};a.error=function(a,b){b&&b.xhr&&b.xhr.abort();a instanceof Error||(a=r.mixin(Error(),a));a.log=D.isDebug;return a};a._token&&(a.content=a.content||{},a.content.token=a._token);var v=0,q;p&&(q=P.objectToQuery(F),v=q.length+p.length+1,g("esri-url-encodes-apostrophe")&&(v=q.replace(/'/g,"%27").length+p.length+1));a.timeout=B.isDefined(a.timeout)?a.timeout:l.timeout;a.handleAs=a.handleAs||"json";try{var w,x,y=h&&m.canUseXhr(a.urlObj)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(a.url),
A=m.hasSameOrigin(a.urlObj,m.appUrl)||y,e="post"===f||c||v>l.maxUrlLength?!0:!1,n=A||-1===a.handleAs.indexOf("json")||!a.callbackParamName||c?!1:!0,G=m.getProxyRule(a.url)||l.forceProxy||d||!("image"===a.handleAs&&!a.allowImageDataAccess||n&&!e||A)?!0:!1;c&&!g("esri-file-upload")&&!G&&y&&(G=!0);if((g("host-browser")||g("host-webworker"))&&G)if(w=m.getProxyUrl(p,h),x=w.path,w._xo&&(y=!0),!e&&x.length+1+v>l.maxUrlLength&&(e=!0),a.url=x+"?"+p,e)a.content=r.mixin(w.query||{},F);else{var V=P.objectToQuery(r.mixin(w.query||
{},F));V&&(a.url+=(-1===p.indexOf("?")?"?":"\x26")+V);a.content=null}if((g("host-browser")||g("host-webworker"))&&n&&!e)return!B.isDefined(a.isAsync)&&4>g("ff")&&(a.isAsync=!0),da.get(z?z(a):a);var I=a.headers;!g("host-browser")&&!g("host-webworker")||I&&I.hasOwnProperty("X-Requested-With")||(I=a.headers=I||{},I["X-Requested-With"]=null);if(g("host-browser")&&c){var L=a.callbackParamName||"callback.html",W=a.callbackElementName||"textarea",J,M,K,N,H=k.elements?k.elements.length:0,Q;if(F=a.content)for(J in F)if(K=
F[J],B.isDefined(K)){M=null;for(N=0;N<H;N++)if(Q=k.elements[N],Q.name===J){M=Q;break}M?M.value=K:b?k.append(J,K):k.appendChild(T.create("input",{type:"hidden",name:J,value:K}))}if(g("esri-file-upload"))C.forEach(k.elements,function(a){a.name===L&&k.removeChild(a)}),a.contentType=!1,a.postData=b?k:new FormData(k),delete a.form;else{k.enctype="multipart/form-data";9>g("ie")&&(k.encoding="multipart/form-data");k.method="post";C.some(k.elements,function(a){return a.name===L})||k.appendChild(T.create("input",
{type:"hidden",name:L,value:W}));if(-1!==p.toLowerCase().indexOf("addattachment")||-1!==p.toLowerCase().indexOf("updateattachment"))a.url=p+(-1===p.indexOf("?")?"?":"\x26")+L+"\x3d"+W,G&&(a.url=x+"?"+a.url);delete a.content}}if(y&&!a.hasOwnProperty("withCredentials")&&"with-credentials"===l.useCors){b=G?x:p;var R=m.getCorsConfig(b);if(R&&R.hasOwnProperty("withCredentials"))R.withCredentials&&(a.withCredentials=!0);else if(t.id){var u=t.id.findServerInfo(b);u&&u.webTierAuth&&(a.withCredentials=!0)}}a=
z?z(a):a;if("image"===a.handleAs)return fa(a,y);if(e){a.data=a.content;if(g("host-browser")&&c&&!g("esri-file-upload"))return ea.send(a);!G&&g("safari")&&(a.url+=(-1===a.url.indexOf("?")?"?":"\x26")+"_ts\x3d"+(new Date).getTime()+ha++);return E.post(a.url,a)}a.query=a.content;return E.get(a.url,a)}catch(ga){return c=new O,c.reject(a.error(ga)),c}}function X(a){var c=l.corsStatus,b=m.getCorsConfig(a,!0);-1<b&&l.corsEnabledServers.splice(b,1);c[H(a)]=1;return b}function Y(a){var c=l.corsStatus;try{var b=
H(a.url);if(l.corsDetection&&l.useCors&&g("esri-cors")&&a.url&&-1!==a.url.toLowerCase().indexOf("/rest/services")&&!m.hasSameOrigin(a.urlObj,m.appUrl)&&!m.canUseXhr(a.urlObj)){if(c[b])return c[b];var d=new O;c[b]=d.promise;var f=a.url.substring(0,a.url.toLowerCase().indexOf("/rest/")+6)+"info";E.get(f,{query:{f:"json"},failOk:!0,handleAs:"json",headers:{"X-Requested-With":null},timeout:1E3*l.corsDetectionTimeout}).then(function(c){c?(m.canUseXhr(a.url)||l.corsEnabledServers.push(b),d.resolve()):d.reject()},
function(a){d.reject()});return d.promise}}catch(h){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}}function A(a,c,b,d){function f(a){a._pendingDfd=U(b,w,u);if(a._pendingDfd){var c=!!a._pendingDfd.response;(a._pendingDfd.response||a._pendingDfd).then(function(b){var n=c?b.data:b;b=c?b.getHeader.bind(b):ia;var e=null;a.ioArgs=a._pendingDfd&&a._pendingDfd.ioArgs;if(n&&(n.error?(e=r.mixin(Error(),n.error),e.log=D.isDebug):"error"===n.status&&(e=r.mixin(Error(),
n),e.log=D.isDebug),e&&!B.isDefined(e.httpCode)&&(e.httpCode=e.code),e))throw e;a.resolve({data:n,url:d.url,requestOptions:d.requestOptions,getHeader:b});a._pendingDfd=null}).then(null,function(c){var e,n,f;c&&(e=c.code,n=c.subcode,f=(f=c.messageCode)&&f.toUpperCase());if(c&&403==e&&(4==n||c.message&&-1<c.message.toLowerCase().indexOf("ssl")&&-1===c.message.toLowerCase().indexOf("permission"))){if(!b._ssl){b._ssl=b._sslFromServer=!0;A(a,!0,b,d);return}}else if(c&&415==c.status){if(X(b.url),!b._err415){b._err415=
1;A(a,!0,b,d);return}}else if(t.id&&-1!==C.indexOf(t.id._errorCodes,e)&&!t.id._isPublic(b.url)&&!q&&(403!=e||-1===C.indexOf(ja,f)&&(!B.isDefined(n)||2==n&&b._token))){ka(a,b,d,c);return}a.ioArgs=a._pendingDfd&&a._pendingDfd.ioArgs;a.reject(c);a._pendingDfd=null})}else{a.ioArgs=a._pendingDfd&&a._pendingDfd.ioArgs;var e=Error("Deferred object is missing");e.log=D.isDebug;a.reject(e);a._pendingDfd=null}}var h=b.form,q=b.disableIdentityLookup,p=b._preLookup,k=!1;if(g("esri-workers")&&!1!==l.useWorkers)if(!0===
b.useWorkers||!0===l.useWorkers)k=!0;else if(b.workerOptions){var v=b.workerOptions;if(v.callback||v.worker&&v.worker.worker instanceof Worker)k=!0}var u=h&&g("esri-file-upload")&&h instanceof FormData,w=h&&(h.elements?C.some(h.elements,function(a){return"file"===a.type}):u),x=-1!==b.url.toLowerCase().indexOf("token\x3d")||b.content&&b.content.token||w&&C.some(h.elements,function(a){return"token"===a.name})?1:0;if(!c){a.then(function(a){if((/\/sharing\/rest\/accounts\/self/i.test(b.url)||/\/sharing\/rest\/portals\/self/i.test(b.url))&&
!x&&!b._token&&a.user&&a.user.username){var c=l.corsEnabledServers,d=m.getCorsConfig(b.url,!0),e={host:H(b.url),withCredentials:!0};if(-1===d)c.push(e);else{var f=c[d];"object"===typeof f?f.withCredentials=!0:c.splice(d,1,e)}}if(c=b._credential)if(d=(d=t.id.findServerInfo(c.server))&&d.owningSystemUrl)d=d.replace(/\/?$/,"/sharing"),(c=t.id.findCredential(d,c.userId))&&-1===t.id._getIdenticalSvcIdx(d,c)&&c.resources.splice(0,0,d);return a}).always(function(a){delete b._credential;a&&(a.ssl=!!b._ssl)});
var y=b.load,z=b.error;y&&a.then(function(b){var c=a._pendingDfd,c=c&&c.ioArgs;return y.call(c&&c.args,b,c)});z&&a.then(null,function(b){var c=a._pendingDfd,c=c&&c.ioArgs;return z.call(c&&c.args,b,c)})}!t.id||x||b._token||t.id._isPublic(b.url)||q&&!p||!(c=t.id.findCredential(b.url))||(b._token=c.token,b._ssl=c.ssl);k?b.workerOptions&&b.workerOptions.worker?(E=b.workerOptions.worker,f(a)):Z(["./workers/RequestClient"],function(c){if(b.workerOptions){var d=b.workerOptions;E=c.getClient(d.callback,d.cbFunction)}else E=
c.getClient();f(a)}):f(a);return a.promise}function ka(a,c,b,d){a._pendingDfd=t.id.getCredential(c.url,{token:c._token,error:d});a._pendingDfd.then(function(d){c._token=d.token;c._credential=d;c._ssl=c._sslFromServer||d.ssl;A(a,!0,c,b)}).then(null,function(b){a.reject(b);a._pendingDfd=null})}function q(a,c){"string"!==typeof a&&console.error("esri/request: the first parameter should be a url string");var b=r.mixin({},c),d={url:a,requestOptions:r.mixin({},c)};b.content=b.query;delete b.query;b.preventCache=
!!b.cacheBust;delete b.cacheBust;b.handleAs=b.responseType;delete b.responseType;"array-buffer"===b.handleAs&&(b.handleAs="arraybuffer");if("image"===b.handleAs){if(g("host-webworker"))return S.reject(r.mixin(Error(),{message:"The responseType 'image' is not supported in Web Workers or Node environment."}));b.preventCache&&(b.content=b.content||{},b.content["request.preventCache"]=Date.now());b.method="auto"}b.url=m.normalize(a);"file"!==m.appUrl.scheme&&(b.url=m.makeAbsolute(b.url));b.urlObj=new u(b.url);
var f=ca.makeDeferredCancellingPending();aa(Y(b)).always(function(){A(f,!1,b,d)});return f.promise}var z,l=ba.request,ja=["COM_0056","COM_0057"],ha=0,ia=function(){return null};q._makeRequest=U;q._processRequest=A;q._disableCors=X;q._detectCors=Y;q.setRequestPreCallback=function(a){z=a};return q});