// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper dojo/_base/lang dojo/Deferred ../../../../request ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Util ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/materials/Material ../../webgl-engine/materials/internal/MaterialUtil ../../webgl-engine/lib/Texture ../../support/aaBoundingBox".split(" "),function(I,A,wa,ka,X,la,E,Y,ma,na,oa,pa,qa,ra,J){function w(c,b){var a=[],e=[],f=[],k=
[],q=[],ha=[],C="meshsymbol_"+c.model.name,g=c.textureDefinitions,ia={},K;for(K in g){var B=g[K],m=B.images[0].data;Z(m,"symbol resources must have embedded texture data (at the moment)");var r="/textureDefinitions/"+K,m=new ra(B.encoding+";base64,"+m,C,{noUnpackFlip:!0});q.push(m);ia[r]={engineTexObj:m,transparent:"rgba"===B.channels}}g=c.model.geometries;K=c.materialDefinitions;for(B=0;B<g.length;B++){r=g[B];if(!r.params.components){var m=r,u=m.params;Z(u.material);u.components=[{id:1,material:m.params.material,
texture:m.params.texture,region:m.params.texture}];u.faces&&(u.faces.componentIndices=[u.faces.position.count])}var m=r.params.components,D=m.length,u=r.params.faces,L=r.params.vertexAttributes,n=r.params.topology||"Indexed",M={},N;for(N in L){var F=L[N],l=F.values;Z(F.values,"symbol resources with external geometry bin not yet supported");if(b.bakeTransformations){if("position"===N){var d=r.transformation,l=l.slice(0);ja(l,3,0,l.length,sa,d)}if("normal"===N){d=ta.create();l=l.slice(0);var t=d,h=
r.transformation,v=h[0],O=h[1],P=h[2],G=h[3],Q=h[4],R=h[5],S=h[6],H=h[7],x=h[8],y=h[9],z=h[10],p=h[11],T=h[12],U=h[13],V=h[14],h=h[15],A=v*R-O*Q,E=v*S-P*Q,w=v*H-G*Q,I=O*S-P*R,ba=O*H-G*R,ca=P*H-G*S,da=x*U-y*T,ea=x*V-z*T,x=x*h-p*T,fa=y*V-z*U,y=y*h-p*U,z=z*h-p*V;if(p=A*z-E*y+w*fa+I*x-ba*ea+ca*da)p=1/p,t[0]=(R*z-S*y+H*fa)*p,t[1]=(S*x-Q*z-H*ea)*p,t[2]=(Q*y-R*x+H*da)*p,t[3]=(P*y-O*z-G*fa)*p,t[4]=(v*z-P*x+G*ea)*p,t[5]=(O*x-v*y-G*da)*p,t[6]=(U*ca-V*ba+h*I)*p,t[7]=(V*w-T*ca-h*E)*p,t[8]=(T*ba-U*w+h*A)*p;ja(l,
3,0,l.length,ua,d)}}M[N]={data:l,size:F.valuesPerElement}}L=void 0;F=Array(D);if("Indexed"===n){var L=u.componentIndices,X;for(X in u);}else"PerAttributeArray"!==n?console.warn("I3S symbol loader: unsupported topology type "+n):1!==D&&console.warn("I3S symbol loader: if topology is not Indexed, only single component geometries are supported");f.push([]);for(D=0;D<m.length;D++){n=m[D];l={type:"triangle",positionKey:"position",indices:{}};if(L)for(var ga in u)"componentIndices"!==ga&&(d=u[ga],Z(d.values,
"symbol resources with external geometry bin not yet supported"),l.indices[ga]=new Uint32Array(d.values));else{d=M.position.data.length/M.position.size;t=new Uint32Array(d);for(v=0;v<d;v++)t[v]=v;var d=t,J;for(J in M)l.indices[J]=d}F[D]=l;l=void 0;n.texture&&(l=ia[n.texture].engineTexObj.getId());d=k[n.material]?k[n.material][n.texture]:null;d||(d=n.material.substring(n.material.lastIndexOf("/")+1),d=K[d].params,1===d.transparency&&(d.transparency=0),l={ambient:d.diffuse,diffuse:d.diffuse,specular:d.specular,
shininess:d.shininess,opacity:1-d.transparency,transparent:0<d.transparency,textureId:l,doubleSided:!0,cullFace:"none",flipV:!1,externalColorMixMode:qa.externalColorMixModes[d.externalColorMixMode||"tint"]},b.materialParamsMixin&&ka.mixin(l,b.materialParamsMixin),d=new pa(l,C),k[n.material]||(k[n.material]={}),k[n.material][n.texture]=d,e.push(d));f[B].push(d)}m=new na(new oa(F,M),C);r=aa.create(r.transformation);b.bakeTransformations&&aa.identity(r);a.push(m);ha.push(r)}return{stageResources:(W=
{},W[Y.ModelContentType.TEXTURE]=q,W[Y.ModelContentType.MATERIAL]=e,W[Y.ModelContentType.GEOMETRY]=a,W),geometryTransformations:ha,materialsByComponent:f,pivotOffset:c.model.pivotOffset};var W}function ua(c,b,a){var e=b[0],f=b[1];b=b[2];c[0]=e*a[0]+f*a[3]+b*a[6];c[1]=e*a[1]+f*a[4]+b*a[7];c[2]=e*a[2]+f*a[5]+b*a[8];return c}function sa(c,b,a){var e=b[0],f=b[1];b=b[2];var k=a[3]*e+a[7]*f+a[11]*b+a[15]||1;c[0]=(a[0]*e+a[4]*f+a[8]*b+a[12])/k;c[1]=(a[1]*e+a[5]*f+a[9]*b+a[13])/k;c[2]=(a[2]*e+a[6]*f+a[10]*
b+a[14])/k;return c}function ja(c,b,a,e,f,k){b||(b=3);a||(a=0);e=e?Math.min(e*b+a,c.length):c.length;for(var q=va;a<e;a+=b)q[0]=c[a],q[1]=c[a+1],q[2]=c[a+2],f(q,q,k),c[a]=q[0],c[a+1]=q[1],c[a+2]=q[2];return c}var aa=E.mat4d,ta=E.mat3d;I=E.vec3d;var Z=ma.assert;A.fetch=function(c,b){b=b||{};if(b.streamDataSupplier){var a=b.streamDataSupplier.request(c,"json"),e=new X(function(){return b.streamDataSupplier.cancelRequest(a)});a.then(function(a,c){a=w(c,b);e.resolve(a)},function(){e.reject()});return e.promise}var f=
la(c),k=new X(function(){return f.cancel()});f.then(function(a){a=w(a.data,b);k.resolve(a)},function(){k.reject()});return k.promise};A.computeBoundingBox=function(c){var b=c.stageResources[Y.ModelContentType.GEOMETRY];c=c.geometryTransformations;for(var a=J.create(J.NEGATIVE_INFINITY),e=[0,0,0],f=[0,0,0],k=0;k<b.length;k++)for(var q=b[k],w=q.getNumGroups(),C=0;C<w;++C){var g=q.getBoundingInfo(C);aa.multiplyVec3(c[k],g.getBBMin(),e);aa.multiplyVec3(c[k],g.getBBMax(),f);for(g=0;3>g;++g){if(e[g]>f[g]){var A=
e[g];e[g]=f[g];f[g]=A}a[g]=Math.min(a[g],e[g]);a[g+3]=Math.max(a[g+3],f[g])}}return a};A.createStageResources=w;var va=I.create()});