// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("../../../../core/declare ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./Graphics3DSymbolCommonCode ./ElevationInfo ../../../../geometry/Polygon ../../support/projectionUtils ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/materials/Material ../../webgl-engine/lib/Util ./earcut/earcut".split(" "),function(L,aa,ba,I,ca,da,ea,P,Q,fa,ga,ha,ia,ja,ka){function la(a,b,c,e,g,d,h,
l,x,t,F,k,m,y){var z=c.length/3,p=0;F+=2*e.count;var f=e.index,A=e.count,n=x,w=F;q.set(m,r);var u=0<k?1:-1,f=3*f,N=n;m=3*N;for(var v=n+A,n=3*v,B=0;B<A;++B)y&&(r[0]=a[f+0],r[1]=a[f+1],r[2]=a[f+2],q.normalize(r)),g[m+0]=a[f+0],g[m+1]=a[f+1],g[m+2]=a[f+2],d[m+0]=b[f+0],d[m+1]=b[f+1],d[m+2]=b[f+2],h[m+0]=-u*r[0],h[m+1]=-u*r[1],h[m+2]=-u*r[2],l[N]=0,g[n+0]=a[f+0]+k*r[0],g[n+1]=a[f+1]+k*r[1],g[n+2]=a[f+2]+k*r[2],d[n+0]=b[f+0],d[n+1]=b[f+1],d[n+2]=b[f+2],h[n+0]=u*r[0],h[n+1]=u*r[1],h[n+2]=u*r[2],l[v]=k,
m+=3,n+=3,f+=3,N+=1,v+=1;f=0;m=3*w;n=3*(w+z);m=3*(w+z);n=3*w;a=R;b=S;0>k&&(a=S,b=R);for(B=0;B<z;++B)t[m+0]=c[f+a[0]],t[m+1]=c[f+a[1]],t[m+2]=c[f+a[2]],t[n+0]=c[f+b[0]]+A,t[n+1]=c[f+b[1]]+A,t[n+2]=c[f+b[2]]+A,m+=3,n+=3,f+=3;x+=2*e.count;F=F+2*z-(2*e.count+2*z);T(g,d,l,h,p,e.pathLengths[0],e.count,x,t,F,k);x+=4*e.pathLengths[0];F+=2*e.pathLengths[0];p+=e.pathLengths[0];for(c=1;c<e.pathLengths.length;++c)T(g,d,l,h,p,e.pathLengths[c],e.count,x,t,F,k),x+=4*e.pathLengths[c],F+=2*e.pathLengths[c],p+=e.pathLengths[c]}
function K(a,b,c,e,g,d,h){e[d]=e[h];h*=3;d*=3;a[d+0]=a[h+0];a[d+1]=a[h+1];a[d+2]=a[h+2];b[d+0]=b[h+0];b[d+1]=b[h+1];b[d+2]=b[h+2];c[d+0]=g[0];c[d+1]=g[1];c[d+2]=g[2]}function T(a,b,c,e,g,d,h,l,x,t,F){var k=g,m=g+1,y=g+h,z=g+h+1,p=l,f=l+1,A=l+2*d;l=l+2*d+1;0>F&&(k=g+h+1,z=g);t*=3;for(var n=0;n<d;++n){n===d-1&&(0<F?(m=g,z=g+h):(m=g,k=g+h));var w=a,u=k,r=m,v=y,B=G,u=3*u,r=3*r,v=3*v;q.set3(w[u++],w[u++],w[u++],M);q.set3(w[r++],w[r++],w[r++],U);q.set3(w[v++],w[v++],w[v++],V);q.subtract(U,M,W);q.subtract(V,
M,X);q.cross(X,W,B);q.normalize(B,B);K(a,b,e,c,G,p,k);K(a,b,e,c,G,f,m);K(a,b,e,c,G,A,y);K(a,b,e,c,G,l,z);x[t++]=p;x[t++]=A;x[t++]=l;x[t++]=p;x[t++]=l;x[t++]=f;k++;m++;y++;z++;p+=2;f+=2;A+=2;l+=2}}var C=ja.VertexAttrConstants,q=P.vec3d,Y=P.mat4d,E=q.create(),r=q.create(),R=[0,2,1],S=[0,1,2],J={},Z={verticalDistanceToGround:0,terrainElevation:0};L=L([aa],{_prepareResources:function(){var a=this._getStageIdHint(),b=this._getMaterialOpacityAndColor(),c=q.create(b),b=b[3],c={diffuse:c,ambient:c,opacity:b,
transparent:1>b||this._isPropertyDriven("opacity"),vertexColors:!0};this._material=new ia(c,a+"_3dlinemat");this._context.stage.add(Q.ModelContentType.MATERIAL,this._material);this.resolve()},destroy:function(){this.isFulfilled()||this.reject();this._material&&this._context.stage.remove(Q.ModelContentType.MATERIAL,this._material.getId())},createGraphics3DGraphic:function(a,b){var c=a.geometry;if("polygon"!==c.type&&"extent"!==c.type)return this._logWarning("unsupported geometry type for extrude symbol: "+
c.type),null;var c="polygon"===c.type||"extent"===c.type?"rings":"paths",e="graphic"+a.uid,g=this._getVertexOpacityAndColor(b,Float32Array,255),d=this._getGraphicElevationInfo(a);return this._createAs3DShape(a,c,b,g,d,e,a.uid)},layerPropertyChanged:function(a,b,c){if("opacity"===a)return b=this._getMaterialOpacity(),c=1>b||this._isPropertyDriven("opacity"),this._material.setParameterValues({opacity:b,transparent:c}),!0;if("elevationInfo"===a){this._updateElevationInfo();a=this._context.elevationProvider;
var e=this._context.renderCoordsHelper,g=I.ELEV_MODES.ABSOLUTE_HEIGHT,d;for(d in b){var h=b[d],l=h._graphics[c];l&&(h=this._getGraphicElevationInfo(h.graphic),l.elevationAligner=h.mode!==g?O:null,l.elevationInfo.set(h),O(l,a,e))}return!0}return!1},_getExtrusionSize:function(a,b){a=a.size&&this._isPropertyDriven("size")?I.getSingleSizeDriver(a.size):this.symbol.size||1;return a/=this._context.renderCoordsHelper.unitInMeters},_createAs3DShape:function(a,b,c,e,g,d,h){var l=a.geometry;"extent"===l.type&&
(l=da.fromExtent(l));var x=l[b],t=l.hasZ;if(0<x.length){b=[];a=[];var r=[],k=q.create(),m=Array(6),y=this._context.renderSpatialReference===ea.SphericalRenderSpatialReference;c=this._getExtrusionSize(c,this.symbol.size);var z=q.create();y||this._context.renderCoordsHelper.worldUpAtPosition(null,z);for(var l=I.getGeometryVertexData3D(x,t,l.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,g),x=l.geometryData.polygons,t=l.eleVertexData,p=l.vertexData,f=p.length/3,
A=new Float64Array(18*f),n=new Float64Array(18*f),w=new Float64Array(18*f),f=new Float64Array(6*f),u=0,C=0;C<x.length;++C){var v=x[C],B=v.count,D=v.index;if(this._context.clippingExtent&&(I.computeBoundingBox(t,D,B,m),I.boundingBoxClipped(m,this._context.clippingExtent)))continue;var E=new Float64Array(t.buffer,3*D*A.BYTES_PER_ELEMENT,3*B),H=v.holeIndices.map(function(a){return a-D}),E=ka(E,H,3);if(0<E.length){I.chooseOrigin(p,D,B,k);var H=new Uint32Array(6*B+2*E.length),G=6*B,J=new Float64Array(A.buffer,
3*u*A.BYTES_PER_ELEMENT,3*G),K=new Float64Array(n.buffer,3*u*n.BYTES_PER_ELEMENT,3*G),L=new Float64Array(w.buffer,3*u*w.BYTES_PER_ELEMENT,3*G),M=new Float64Array(f.buffer,1*u*f.BYTES_PER_ELEMENT,1*G);la(p,t,E,v,J,L,K,M,0,H,0,c,z,y);I.subtractCoordinates(J,0,G,k);u+=6*B;v=this._createExtrudeGeometry(H,{positions:J,elevation:L,normals:K,heights:M},e);v=new ga(v,d+"path"+C);v.singleUse=!0;b.push(v);a.push([this._material]);v=Y.identity();Y.translate(v,k,v);r.push(v)}}return 0<b.length?(e=new fa({geometries:b,
materials:a,transformations:r,castShadow:!0,metadata:{layerId:this._context.layer.id,graphicId:h},idHint:d}),d=null,g.mode!==I.ELEV_MODES.ABSOLUTE_HEIGHT&&(d=O),g=new ba(this,e,b,null,null,d,g),g.alignedTerrainElevation=l.terrainElevation,g):null}this._logWarning("no paths found for extrusion symbol");return null},_createExtrudeGeometry:function(a,b,c){for(var e=a.length,g=new Uint32Array(e),d=0;d<e;d++)g[d]=0;e={};d={};e[C.POSITION]=a;e[C.NORMAL]=a;e[C.COLOR]=g;d[C.POSITION]={size:3,data:b.positions};
d[C.NORMAL]={size:3,data:b.normals};d[C.COLOR]={size:4,data:c};d[C.SIZE]={size:1,data:b.heights};b.elevation&&(d.mapPos={size:3,data:b.elevation},e.mapPos=a);return new ha(d,e)}});var G=q.create(),M=q.create(),U=q.create(),V=q.create(),W=q.create(),X=q.create(),H=q.create(),D=q.create(),O=function(a,b,c){var e=a.stageObject,g=a.elevationInfo,d=c.setAltitude;J.spatialReference=b.spatialReference;for(var h=e.getGeometryRecords(),l=h.length,r=g.mode!==ca.MODES.ABSOLUTE_HEIGHT,t=0,q=0;q<l;q++){var k=
h[q].geometry,m=h[q].transformation;D[0]=m[12];D[1]=m[13];D[2]=m[14];k.invalidateBoundingInfo();for(var y=k.getData().getVertexAttr(),k=y[C.POSITION].data,m=y[C.SIZE].data,y=y.mapPos.data,z=k.length/3,p=0,f=0,A=!1,n=0,w=0;w<z;w++){J.x=y[f];J.y=y[f+1];J.z=y[f+2];H[0]=k[p];H[1]=k[p+1];H[2]=k[p+2];var u=I.computeElevation(b,J,g,r?Z:null);r&&(n+=Z.terrainElevation);E[0]=k[p]+D[0];E[1]=k[p+1]+D[1];E[2]=k[p+2]+D[2];d(u+m[p/3],E,0);k[p]=E[0]-D[0];k[p+1]=E[1]-D[1];k[p+2]=E[2]-D[2];u=.01/c.unitInMeters;if(Math.abs(H[0]-
k[p])>u||Math.abs(H[1]-k[p+1])>u||Math.abs(H[2]-k[p+2])>u)A=!0;f+=3;p+=3}A&&e.geometryVertexAttrsUpdated(q);t+=n/z}a.alignedTerrainElevation=t/l};return L});