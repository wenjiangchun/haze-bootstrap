// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper dojo/_base/lang ../../core/accessorSupport/decorators ../../core/accessorSupport/PropertyOrigin ./ArcGISMapService ../support/Sublayer ../support/sublayerUtils ../../core/Collection ../../core/CollectionFlattener ../support/ExportImageParameters ../../geometry/support/scaleUtils".split(" "),function(c,y,t,d,k,b,l,u,h,m,n,v,w,x){function p(c,b,a){var g=[],r={};c.forEach(function(f){var e=new h;e.read(f,
b);a&&-1===a.indexOf(e.id)&&(e.visible=!1);r[e.id]=e;null!=f.parentLayerId&&-1!==f.parentLayerId?(f=r[f.parentLayerId],f.sublayers||(f.sublayers=[]),f.sublayers.unshift(e)):g.unshift(e)});return g}function q(c,b){var a=b.get(c.id);a?(k.mixin(c.__accessor__.store._values,a.__accessor__.store._values),a.sublayers&&(c.sublayers=a.sublayers.map(function(a){return q(a,b)}))):c.sublayers&&c.sublayers.forEach(function(a){return q(a,b)});return c}c=function(c){function b(){var a=c.call(this)||this;a.allSublayers=
new v({root:a,rootCollectionNames:["sublayers"],getChildrenFunction:function(a){return a.sublayers}});a.dpi=96;a.gdbVersion=null;a.imageFormat="png24";a.imageMaxHeight=2048;a.imageMaxWidth=2048;a.imageTransparency=!0;a.loaded=!1;a.sublayers=null;a.watch("sublayers",function(b,c){c&&(c.forEach(function(a){a.parent=null;a.layer=null}),a._sublayersHandles.forEach(function(a){return a.remove()}),a._sublayersHandles=null);b&&(b.forEach(function(b){b.parent=a;b.layer=a}),a._sublayersHandles=[b.on("after-add",
function(b){b=b.item;b.parent=a;b.layer=a}),b.on("after-remove",function(a){a=a.item;a.parent=null;a.layer=null})])},!0);return a}t(b,c);b.prototype.readCapabilities=function(a,b){a=(a=a&&a.split(",").map(function(a){return a.trim()}))||[];b.supportsDynamicLayers&&a.push("DynamicLayers");return a};b.prototype.readImageFormat=function(a,b){return(a=b.supportedImageFormatTypes)&&-1<a.indexOf("PNG32")?"png32":"png24"};b.prototype.readServiceSublayers=function(a,b,c){return p(b.layers,c)};b.prototype.readSublayersFromItemOrWebMap=
function(a,b,c){return!b.layers&&b.visibleLayers?b.visibleLayers.map(function(a){return{id:a}}):p(b.layers,c,b.visibleLayers)};b.prototype.readSublayers=function(a,b,c){a=p(b.layers,c);this._updateSublayersForOrigin(l.OriginId.PORTAL_ITEM,a);this._updateSublayersForOrigin(l.OriginId.WEB_MAP,a);this._updateSublayersForOrigin(l.OriginId.WEB_SCENE,a);return a};b.prototype.writeSublayers=function(a,b,c,f){a=a.flatten(function(a){return(a=a.sublayers)&&a.toArray().reverse()}).toArray().reverse();var e=
this.serviceSublayers.flatten(function(a){return(a=a.sublayers)&&a.toArray().reverse()}).toArray().reduce(function(a,b){return a.set(b.id,b)},new Map),d=!1,g=!0;this.capabilities&&-1!==this.capabilities.indexOf("DynamicLayers")?(d=m.isExportDynamic(a,this.serviceSublayers,this),g=!d&&m.sameStructureAsService(a,this.serviceSublayers)):g=m.sameStructureAsService(a,this.serviceSublayers);b.layers=[];a.forEach(function(a){var c=e.get(a.id),c=k.mixin({writeAsDynamic:d,writeOverridesOnly:g,serviceSublayer:c},
f);a=a.write({},c);(!g||g&&1<Object.keys(a).length)&&b.layers.push(a)});b.visibleLayers=a.filter(function(a){return a.visible}).map(function(a){return a.id})};b.prototype.findSublayerById=function(a){return this.allSublayers.find(function(b){return b.id===a})};b.prototype.createServiceSublayers=function(){return this.serviceSublayers.map(function(a){return a.clone()})};b.prototype.createExportImageParameters=function(a){var b=a.width,c=a.height,f=a.extent,e=a.exportImageParameters;f&&10<=this.version&&
(f=a.extent.clone().shiftCentralMeridian());e||(e=new w({layer:this,scale:x.getScale({extent:f,width:b})}));var d=e.toJSON();a.exportImageParameters||(e.layer=null,e.destroy());a=null==a.rotation||0===a.rotation||10.3>this.version?{}:{rotation:-a.rotation};e=f&&f.spatialReference;e=e.wkid||JSON.stringify(e.toJSON());return k.mixin({bbox:f&&f.xmin+","+f.ymin+","+f.xmax+","+f.ymax,bboxSR:e,imageSR:e,size:b+","+c},a,d)};b.prototype._updateSublayersForOrigin=function(a,b){var c=this.__accessor__.store;
if(c.has("sublayers",a)){var d=c.get("sublayers",a).flatten(function(a){return a.sublayers});if(d.every(function(a){return!a.__accessor__.store._values.hasOwnProperty("minScale")})){var e=d.reduce(function(a,b){return a.set(b.id,b)},new Map);b=b.map(function(a){return q(a.clone(),e)});c.set("sublayers",new (n.ofType(h))(b),a)}}};return b}(b.declared(u));d([b.property({readOnly:!0})],c.prototype,"allSublayers",void 0);d([b.property({readOnly:!0})],c.prototype,"capabilities",void 0);d([b.reader("service",
"capabilities",["supportsDynamicLayers"])],c.prototype,"readCapabilities",null);d([b.property()],c.prototype,"dpi",void 0);d([b.property()],c.prototype,"gdbVersion",void 0);d([b.property()],c.prototype,"imageFormat",void 0);d([b.reader("imageFormat",["supportedImageFormatTypes"])],c.prototype,"readImageFormat",null);d([b.property({json:{origins:{service:{read:{source:"maxImageHeight"}}}}})],c.prototype,"imageMaxHeight",void 0);d([b.property({json:{origins:{service:{read:{source:"maxImageWidth"}}}}})],
c.prototype,"imageMaxWidth",void 0);d([b.property()],c.prototype,"imageTransparency",void 0);d([b.property()],c.prototype,"loaded",void 0);d([b.property({readOnly:!0,type:n.ofType(h)})],c.prototype,"serviceSublayers",void 0);d([b.reader("service","serviceSublayers",["layers"])],c.prototype,"readServiceSublayers",null);d([b.property({type:n.ofType(h)})],c.prototype,"sublayers",void 0);d([b.reader(["web-map","web-scene","portal-item"],"sublayers",["layers","visibleLayers"])],c.prototype,"readSublayersFromItemOrWebMap",
null);d([b.reader("service","sublayers",["layers"])],c.prototype,"readSublayers",null);d([b.writer(["web-map","web-scene","portal-item"],"sublayers")],c.prototype,"writeSublayers",null);return c=d([b.subclass("esri.layers.mixins.ArcGISDynamicMapService")],c)});