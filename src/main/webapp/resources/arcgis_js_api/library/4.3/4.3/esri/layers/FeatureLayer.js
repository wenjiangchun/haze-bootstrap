// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require dojo/_base/lang dojo/io-query ../Graphic ../PopupTemplate ../request ../core/kebabDictionary ../core/MultiOriginJSONSupport ../core/Collection ../core/Error ../core/Logger ../core/lang ../core/HandleRegistry ../core/promiseUtils ../core/requireUtils ../core/urlUtils ../geometry/Extent ../geometry/SpatialReference ../geometry/support/normalizeUtils ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/support/jsonUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/support/arcadeUtils ../renderers/support/jsonUtils ../renderers/support/styleUtils ../tasks/support/FeatureSet ../tasks/support/Query ./Layer ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/ScaleRangeLayer ./mixins/ArcGISService ./graphics/sources/MemorySource ./support/Field ./support/FeatureType ./support/LabelClass ./support/labelingInfo ./support/arcgisLayerUrl ./support/ElevationInfo".split(" "),
function(t,h,u,v,w,E,l,F,m,e,n,x,G,f,y,k,H,z,I,J,K,L,r,A,M,B,N,O,P,Q,R,S,T,U,V,p,W,X,Y,C,q,Z){l=l({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});var aa=n.getLogger("esri.layers.FeatureLayer");n=function(a,b){a=P.fromJSON(b.featureSet);return new p({layer:this,items:a&&a.features||[]})};var D=R.createSubclass([S,T,U,V,F],{declaredClass:"esri.layers.FeatureLayer",viewModulePaths:{"2d":"../views/2d/layers/FeatureLayerView2D",
"3d":"../views/3d/layers/FeatureLayerView3D"},constructor:function(){this._handles=new G},normalizeCtorArgs:function(a,b){return"string"===typeof a?h.mixin({},{url:a},b):a},load:function(){var a;a=this.source&&(Array.isArray(this.source)||this.source.isInstanceOf&&this.source.isInstanceOf(m));a=this.portalItem&&a?f.resolve():this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection"]}).always(function(){if(this.url&&null==this.layerId&&/FeatureServer\/*$/i.test(this.url))return this._fetchFirstLayerId().then(function(a){null!=
a&&(this.layerId=a)}.bind(this))}.bind(this)).then(function(){if(!this.url&&!this._hasMemorySource())throw new e("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return this.createGraphicsSource().then(this._initLayerProperties.bind(this))}.bind(this));this.addResolvingPromise(a)},_handles:null,_rndProps:"field field2 field3 normalizationField rotationInfo.field proportionalSymbolInfo.field proportionalSymbolInfo.normalizationField colorInfo.field colorInfo.normalizationField".split(" "),
_visVariableProps:["field","normalizationField"],properties:{advancedQueryCapabilities:{json:{origins:{service:{read:{source:["advancedQueryCapabilities","supportsStatistics","supportsAdvancedQueries"],reader:function(a,b){return this._readAdvancedQueryCapabilities(b)}}}},read:{source:["layerDefinition.supportsAdvancedQueries","layerDefinition.supportsStatistics"],reader:function(a,b){return this._readAdvancedQueryCapabilities(b.layerDefinition)}}}},allowGeometryUpdates:{json:{origins:{service:{read:{reader:function(a){return this._readAllowGeometryUpdates(a)}}}},
read:{source:"layerDefinition.allowGeometryUpdates",reader:function(a){return this._readAllowGeometryUpdates(a)}}}},allRenderers:{readOnly:!0,dependsOn:["loaded","renderer","fields"],get:function(){return this._getAllRenderers(this.renderer)}},capabilities:{json:{origins:{service:{read:{reader:function(a){return this._readCapabilities(a)}}}},read:{source:"layerDefinition.capabilities",reader:function(a){return this._readCapabilities(a)}}},dependsOn:["loaded"],get:function(){var a=this._get("capabilities");
!a&&this.loaded&&this._hasMemorySource()&&(a={operations:{supportsAdd:!0,supportsDelete:!0,supportsEditing:!0,supportsQuery:!0,supportsUpdate:!0}});return a}},copyright:{value:null,json:{origins:{service:{read:{source:"copyrightText"}}},read:{source:"layerDefinition.copyrightText"}}},definitionExpression:{value:null,json:{origins:{service:{read:!1,write:!1}},read:{source:"layerDefinition.definitionExpression"},write:{target:"layerDefinition.definitionExpression"}}},defaultSymbol:{json:{read:r.read}},
elevationInfo:{type:Z,value:null,json:{origins:{service:{read:{source:"elevationInfo"},write:{target:"elevationInfo",enabled:!1}}},read:{source:"layerDefinition.elevationInfo"},write:{target:"layerDefinition.elevationInfo"}}},fields:{value:null,type:[W],json:{origins:{service:{read:!0}},read:{source:"layerDefinition.fields"}}},fullExtent:{value:null,type:H,json:{origins:{service:{read:{source:"extent"}}},read:{source:"layerDefinition.extent"}}},gdbVersion:null,generalizeForScale:4E3,geometryType:{json:{origins:{service:{read:l.fromJSON}},
read:{source:"layerDefinition.geometryType",reader:l.fromJSON}}},hasAttachments:{value:!1,readOnly:!0,get:function(){return!this._hasMemorySource()&&this._get("hasAttachments")},json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasAttachments"}}},hasM:{value:!1,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasM"}}},hasZ:{value:!1,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasM"}}},id:{json:{origins:{service:{read:!1},portalItem:{read:!1}}}},isTable:{value:!1,
readOnly:!0,json:{origins:{service:{read:{source:"type",reader:function(a){return"Table"===a}}}},read:{source:"layerDefinition.type",reader:function(a){return"Table"===a}}}},labelsVisible:{value:!1,json:{read:{source:["showLabels"],reader:function(a,b){return!!b.showLabels}},write:function(a,b){a&&(b.showLabels=a)}}},labelingInfo:{value:null,type:[Y],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:C.reader},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",
reader:C.reader},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}},layerId:{json:{origins:{service:{read:{source:["id"],reader:function(a,b){return b.id}}}},read:!1}},legendEnabled:{value:!0,json:{read:{source:["showLegend"],reader:function(a,b){return null!=b.showLegend?b.showLegend:!0}},write:function(a,b){a||(b.showLegend=!1)}}},maxRecordCount:{value:null,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.maxRecordCount"}}},minScale:{json:{origins:{service:{read:{source:["minScale",
"effectiveMinScale"],reader:function(a,b){return b.effectiveMinScale||a}},write:{target:["minScale"],enabled:!1}}},read:{source:"layerDefinition.minScale"},write:{target:"layerDefinition.minScale"}}},maxScale:{json:{origins:{service:{read:{source:["maxScale","effectiveMaxScale"],reader:function(a,b){return b.effectiveMaxScale||a}},write:{target:"maxScale",enabled:!1}}},read:{source:"layerDefinition.maxScale"},write:{target:"layerDefinition.maxScale"}}},objectIdField:{json:{origins:{service:{read:{source:["objectIdField",
"fields"],reader:function(a,b){return this._readObjectIdField(b)}}}},read:{source:["layerDefinition.objectIdField","layerDefinition.fields"],reader:function(a,b){return this._readObjectIdField(b.layerDefinition)}}}},operationalLayerType:"ArcGISFeatureLayer",outFields:{value:null,dependsOn:["requiredFields"],get:function(){var a=this._get("outFields"),b=this.requiredFields;a?-1===a.indexOf("*")&&b.forEach(function(b){-1===a.indexOf(b)&&a.push(b)}):a=b;this.loaded&&(a=a.filter(function(a){return"*"===
a||!!this.getField(a)},this),a=a.map(function(a){return"*"===a?a:this.getField(a).name},this));return a},set:function(a){var b=this.requiredFields;a?-1===a.indexOf("*")&&b.forEach(function(b){-1===a.indexOf(b)&&a.push(b)}):a=b;this.loaded&&(a=a.filter(function(a){return"*"===a||!!this.getField(a)},this),a=a.map(function(a){return"*"===a?a:this.getField(a).name},this));this._set("outFields",a)}},parsedUrl:{dependsOn:["layerId"],get:function(){var a=this.url?k.urlToObject(this.url):null;null!=this.layerId&&
null!=a&&(a.path=k.join(a.path,this.layerId.toString()));return a}},popupEnabled:{value:!0,json:{read:{source:["disablePopup"],reader:function(a,b){return null!=b.disablePopup?!b.disablePopup:!0}},write:function(a,b){a||(b.disablePopup=!0)}}},popupTemplate:{value:null,type:w,json:{read:{source:["popupInfo"],reader:function(a,b){return b.popupInfo?w.fromJSON(b.popupInfo):null}},write:function(a,b){a&&(b.popupInfo=a.toJSON())}}},relationships:null,renderer:{set:function(a){var b=this._getAllRenderers(a);
this._fixRendererFields(b);this._set("renderer",a)},json:{origins:{service:{read:{source:["drawingInfo.renderer","defaultSymbol","type"],reader:function(a,b,c){return this._readRenderer(null,b,c)}},write:{target:"drawingInfo.renderer",enabled:!1}}},read:{source:["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol","layerDefinition.type"],reader:function(a,b,c){return this._readRenderer(null,b.layerDefinition,c)}},write:{target:"layerDefinition.drawingInfo.renderer"}}},requiredFields:{dependsOn:["allRenderers"],
get:function(){var a=this.timeInfo,b=[this.objectIdField,this.typeIdField,this.editFieldsInfo&&this.editFieldsInfo.creatorField,a&&a.startTimeField,a&&a.endTimeField,this.trackIdField],c=this._rndProps,d=[];this.allRenderers.forEach(function(a){c.forEach(function(c){b.push(h.getObject(c,!1,a))});a.valueExpression&&(d=d.concat(B.extractFieldNames(a.valueExpression)));a.visualVariables&&a.visualVariables.forEach(function(a){this._visVariableProps.forEach(function(c){b.push(a[c])});a.valueExpression&&
(d=d.concat(B.extractFieldNames(a.valueExpression)))},this)},this);b=b.concat(d);b=b.concat(this.dataAttributes);return b.filter(function(a,b,c){return!!a&&c.indexOf(a)===b&&"function"!==typeof a})}},returnM:!1,returnZ:!1,source:{json:{origins:{portalItem:{read:{source:["featureSet"],reader:n}},webMap:{read:{source:["featureSet"],reader:n}}}},cast:function(a){return a&&(Array.isArray(a)||a.isInstanceOf&&a.isInstanceOf(m))?new p({layer:this,items:a}):a},set:function(a){var b=this._get("source");b!==
a&&(b&&b.isInstanceOf&&b.isInstanceOf(p)&&this._resetMemorySource(b),a&&a.isInstanceOf&&a.isInstanceOf(p)&&this._initMemorySource(a),this._set("source",a))}},supportsCoordinatesQuantization:!1,serviceDefinitionExpression:{json:{origins:{service:{read:{source:["definitionExpression"],reader:function(a,b){return b.definitionExpression}}}}}},spatialReference:{json:{origins:{service:{read:{source:"extent",reader:function(a){if(a&&a.spatialReference)return z.fromJSON(a.spatialReference)}}}},read:{source:"layerDefinition.extent",
reader:function(a){if(a&&a.spatialReference)return z.fromJSON(a.spatialReference)}}}},title:{json:{origins:{portalItem:{read:{source:["layerDefinition.title","layerDefinition.name","title"],reader:function(a,b){a=b.layerDefinition&&b.layerDefinition.name;b=b.title||b.layerDefinition&&b.layerDefinition.title;if(a)return this._readTitleFromName(a);if("item-title"===this.sublayerTitleMode&&b)return b}}},service:{read:{source:"name",reader:function(a,b){return this._readTitleFromName(a)}}}}}},sublayerTitleMode:{type:String,
value:"item-title"},trackIdField:{json:{read:{source:["timeInfo.trackIdField"],reader:function(a,b){return b.timeInfo.trackIdField}}}},type:{value:"feature",json:{read:!1}},typeIdField:{json:{origins:{service:{read:function(a,b){return this._readTypeIdField(a,b)}}},read:{source:"layerDefinition.typeIdField",reader:function(a,b){return this._readTypeIdField(a,b.layerDefinition)}}}},types:{json:{origins:{service:{read:function(a,b){return this._readTypes(a,b)}}},read:{source:"layerDefinition.types",
reader:function(a,b){return this._readTypes(a,b.layerDefinition)}}}},url:{set:function(a){var b=k.urlToObject(a),c=q.parse(b.path);c&&null!=c.sublayer&&(null==this.layerId&&(this.layerId=c.sublayer),b=u.objectToQuery(b.query),a=c.url.path,b&&(a=a+"?"+b));this._set("url",a)},json:{write:function(a,b){a&&k.isProtocolRelative(a)&&(a="https:"+a);a&&(b.url=a);null!=this.layerId&&(a=k.urlToObject(a))&&(b.url=k.join(a.path,""+this.layerId),a.query&&Object.keys(a.query)&&(b.url+="?"+u.objectToQuery(a.query)))}}},
userIsAdmin:!1,version:{json:{origins:{service:{read:{source:"currentVersion capabilities drawingInfo hasAttachments htmlPopupType relationships timeInfo typeIdField types".split(" "),reader:function(a,b){return this._readVersion(b)}}}},read:{source:"layerDefinition.currentVersion layerDefinition.capabilities layerDefinition.drawingInfo layerDefinition.hasAttachments layerDefinition.htmlPopupType layerDefinition.typeIdField layerDefinition.types".split(" "),reader:function(a,b){return this._readVersion(b.layerDefinition)}}}},
visible:{json:{origins:{portalItem:{read:{source:["visibility","layerDefinition.defaultVisibility"],reader:function(a,b){if(b.layerDefinition&&null!=b.layerDefinition.defaultVisibility)return!!b.layerDefinition.defaultVisibility;if(null!=b.visibility)return!!b.visibility}},write:{target:"layerDefinition.defaultVisibility"}}}}}},applyEdits:function(a){return this.load().then(function(){return this.source.applyEdits?this._processApplyEditsParams(a).then(function(a){return this.source.applyEdits(a).then(function(a){var b=
function(a){return a.filter(function(a){return!a.error}).map(function(a){return x.clone(a)})},b={addedFeatures:b(a.addFeatureResults),updatedFeatures:b(a.updateFeatureResults),deletedFeatures:b(a.deleteFeatureResults)};(b.addedFeatures.length||b.updatedFeatures.length||b.deletedFeatures.length)&&this.emit("edits",b);return a}.bind(this))}.bind(this)):f.reject(new e("FeatureLayer","Layer source does not support applyEdits capability"))}.bind(this))},createGraphicsSource:function(){return this._hasMemorySource()?
(this.emit("graphics-source-create",{graphicsSource:this.source}),f.resolve(this.source)):y.when(t,"./graphics/sources/FeatureLayerSource").then(function(a){return new a({layer:this})}.bind(this)).then(function(a){this.emit("graphics-source-create",{graphicsSource:a});return a}.bind(this))},createGraphicsController:function(a){var b=a.layerView,c=m.ofType(v),d=this.source,g=d&&d.isInstanceOf&&d.isInstanceOf(m),e=h.mixin(a.options||{},{layer:this,layerView:b,graphics:g?d:new c});return g?f.resolve(e):
y.when(t,"2d"===b.view.type?"./graphics/controllers/AutoController2D":"./graphics/controllers/SnapshotController").then(function(a){return new a(e)}.bind(this)).then(function(a){this.emit("graphics-controller-create",{graphicsController:a});return a}.bind(this))},createQuery:function(){var a=new Q;a.returnGeometry=!0;a.returnZ=this.hasZ&&this.returnZ||null;a.returnM=this.hasM&&this.returnM||null;a.outFields=this.outFields;a.where=this.definitionExpression||"1\x3d1";a.multipatchOption="multipatch"===
this.geometryType?"xyFootprint":null;return a},getFieldDomain:function(a,b){var c,d;b=(b=b&&b.feature)&&b.attributes;var g=this.typeIdField&&b&&b[this.typeIdField];null!=g&&this.types&&this.types.some(function(b){return b.id==g?((c=b.domains&&b.domains[a])&&"inherited"===c.type&&(c=this._getLayerDomain(a),d=!0),!0):!1},this);d||c||(c=this._getLayerDomain(a));return c},getField:function(a,b){var c;if(b=b||this.fields)a=a.toLowerCase(),b.some(function(b){b&&b.name.toLowerCase()===a&&(c=b);return!!c});
return c},graphicChanged:function(a){this.emit("graphic-update",a)},queryFeatures:function(a){var b=this;a=a||this.createQuery();if(!this.source.queryFeatures)return f.reject(new e("FeatureLayer","Layer source does not support queryFeatures capability"));var c=this.popupTemplate;return this.source.queryFeatures(a).then(function(a){a&&a.features&&a.features.forEach(function(a){a.popupTemplate=c;a.layer=b});return a})},queryObjectIds:function(a){a=a||this.createQuery();return this.source.queryObjectIds?
this.source.queryObjectIds(a):f.reject(new e("FeatureLayer","Layer source does not support queryObjectIds capability"))},queryFeatureCount:function(a){a=a||this.createQuery();return this.source.queryFeatureCount?this.source.queryFeatureCount(a):f.reject(new e("FeatureLayer","Layer source does not support queryFeatureCount capability"))},queryExtent:function(a){a=a||this.createQuery();return this.source.queryExtent?this.source.queryExtent(a):f.reject(new e("FeatureLayer","Layer source does not support queryExtent capability"))},
read:function(a,b){switch(b&&b.origin){case "web-map":this.inherited(arguments,[{outFields:["*"]},b]);break;case "web-scene":this.inherited(arguments,[{mode:D.MODE_SNAPSHOT,returnZ:!0,outFields:["*"]},b])}var c=a.featureCollection;if(c){var d=c.layers;d&&1===d.length&&(this.inherited(arguments,[d[0],b]),null!=c.showLegend&&this.inherited(arguments,[{showLegend:c.showLegend},b]))}this.inherited(arguments,[a,b]);return this},write:function(a,b){if(b&&"web-scene"===b.origin&&b.messages){if(!this.url)return b.messages.push(new e("layer:unsupported",
"Layers ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' require a url to a service to be written to web scenes",{layer:this})),null;if(this.isTable)return b.messages.push(new e("layer:unsupported","Layers ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' using a Table source cannot written to web scenes",{layer:this})),null}return this.inherited(arguments)},_getLayerDomain:function(a){var b;this.fields&&this.fields.some(function(c){c.name===a&&(b=c.domain);return!!b});
return b},_fetchFirstLayerId:function(){return E(this.url,{query:{f:"json"},callbackParamName:"callback",responseType:"json"}).then(function(a){if(a.data&&Array.isArray(a.data.layers)&&0<a.data.layers.length)return a.data.layers[0].id})},_initLayerProperties:function(a){this.source||(this.source=a);a.url&&(this.url=a.url);a.layerDefinition&&this.read(a.layerDefinition,{origin:"service",url:this.parsedUrl});this._verifySource();this._verifyFields();this._addSymbolUrlTokens();this._fixRendererFields(this._getAllRenderers(this.renderer));
this.watch("token",function(){this._addSymbolUrlTokens()}.bind(this));return O.loadStyleRenderer(this,{origin:"service"})},_findUrlBasedSymbols:function(){var a=this.renderer;if(!a)return[];var b=[];a.symbol&&b.push(a.symbol);a.defaultSymbol&&b.push(a.defaultSymbol);(a=a.classBreakInfos||a.uniqueValueInfos)&&a.forEach(function(a){a.symbol&&b.push(a.symbol)});return b.filter(function(a){return!!a.url})},_addSymbolUrlTokens:function(){var a=this.token;!this._hasMemorySource()&&a&&this._findUrlBasedSymbols().forEach(function(b){var c=
b.url;if(c&&-1!==c.search(/https?\:/i)&&!/[?&]token=/.test(c)){var d=-1===c.indexOf("?")?"?":"\x26",c=c+d+"token\x3d"+a;b.source?(d=x.clone(b.source),d.url=c,b.source=d):b.url=c}})},_getAllRenderers:function(a){var b=[];a&&[a,a.trackRenderer,a.observationRenderer,a.latestObservationRenderer].forEach(function(a){a&&(b.push(a),a.rendererInfos&&a.rendererInfos.forEach(function(a){a.renderer&&b.push(a.renderer)}))});return b},_fixRendererFields:function(a){var b=this.fields;a&&b&&a.forEach(function(a){this._fixFieldName(this._rndProps,
a);a.visualVariables&&a.visualVariables.forEach(function(a){this._fixFieldName(this._visVariableProps,a)},this)},this)},_fixFieldName:function(a,b){a&&a.forEach(function(a){var c=h.getObject(a,!1,b);(c=c&&"function"!==typeof c&&this.getField(c))&&h.setObject(a,c.name,b)},this)},_verifyFields:function(){var a=this.parsedUrl&&this.parsedUrl.path||"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+a+")");this.isTable||this._hasMemorySource()||-1!==
a.search(/\/FeatureServer\//i)||this.fields&&this.fields.some(function(a){return"geometry"===a.type})||console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+a+")")},_fixTemplates:function(a,b){a&&a.forEach(function(a){(a=a.prototype&&a.prototype.attributes)&&b&&delete a[b]})},_verifySource:function(){if(this._hasMemorySource()){if(this.url)throw new e("feature-layer:mixed-source-and-url",
"FeatureLayer cannot be created with both an in-memory source and a url");var a=["geometryType","fields","objectIdField"];if(!a.every(function(a){return this.hasOwnProperty(a)},this))throw new e("feature-layer:missing-property","FeatureLayer created as feature collection requires properties: "+a.join(),{requiredProperties:a});}else{if(this.isTable)throw new e("feature-layer:source-type-not-supported","The table feature service type is not yet supported",{sourceType:"Table"});if(!this.url)throw new e("feature-layer:source-or-url-required",
"FeatureLayer requires either a url, a valid portal item or a source");}},_initMemorySource:function(a){a.forEach(function(a){a.layer=this}.bind(this));this._handles.add([a.on("after-add",function(a){a.item.layer=this}.bind(this)),a.on("after-remove",function(a){a.item.layer=null}.bind(this))],"fl-source")},_resetMemorySource:function(a){a.forEach(function(a){a.layer=null}.bind(this));this._handles.remove("fl-source")},_hasMemorySource:function(){return!(this.url||!this.source)},_readTitleFromName:function(a){var b=
this.portalItem&&this.portalItem.title;if("item-title"===this.sublayerTitleMode)return this.url?q.titleFromUrlAndName(this.url,a):a;if(a=a||this.url&&q.parse(this.url).title)return"item-title-and-service-name"===this.sublayerTitleMode&&b&&(a=b+" - "+a),q.cleanTitle(a)},_readAdvancedQueryCapabilities:function(a){return a.advancedQueryCapabilities||{supportsPagination:!1,supportsQueryWithDistance:!1,supportsReturningQueryExtent:!1,supportsStatistics:a.supportsStatistics,supportsOrderBy:a.supportsAdvancedQueries,
supportsDistinct:a.supportsAdvancedQueries}},_readAllowGeometryUpdates:function(a){return null==a?!0:a},_readCapabilities:function(a){a=a?a.toLowerCase().split(",").map(function(a){return a.trim()}):[];var b=-1!==a.indexOf("editing"),c=b&&-1!==a.indexOf("create"),d=b&&-1!==a.indexOf("delete"),g=b&&-1!==a.indexOf("update");!b||c||d||g||(c=d=g=!0);return{operations:{supportsAdd:c,supportsDelete:d,supportsEditing:b,supportsQuery:-1!==a.indexOf("query"),supportsUpdate:g}}},_readObjectIdField:function(a){if(a.objectIdField)return a.objectIdField;
if(a.fields)for(var b=0;b<a.fields.length;b++){var c=a.fields[b];if("esriFieldTypeOID"===c.type)return c.name}},_readRenderer:function(a,b,c){var d;if(a=b.drawingInfo&&b.drawingInfo.renderer||void 0)(a=N.read(a,b,c)||void 0)||aa.error("Failed to create renderer",{rendererDefinition:b.drawingInfo.renderer,layer:this,context:c});else if(b.defaultSymbol)r.read(b.defaultSymbol,b,c),b.types&&b.types.length?(a=new M({defaultSymbol:d,field:b.typeIdField}),b.types.forEach(function(b){a.addUniqueValueInfo(b.id,
r.read(b.symbol,b,c))})):a=new A({symbol:d});else if("Table"!==b.type){switch(b.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":d=new J;break;case "esriGeometryPolyline":d=new K;break;case "esriGeometryPolygon":d=new L}a=d&&new A({symbol:d})}return a},_readTypeIdField:function(a,b){a&&(b=this.getField(a,b.fields))&&(a=b.name);return a},_readTypes:function(a,b){var c=(b=b.editFieldsInfo)&&b.creatorField,d=b&&b.editorField;return a&&a.map(function(a){a=new X(a);this._fixTemplates(a.templates,
c);this._fixTemplates(a.templates,d);return a},this)},_readVersion:function(a){return a.currentVersion?a.currentVersion:a.hasOwnProperty("capabilities")||a.hasOwnProperty("drawingInfo")||a.hasOwnProperty("hasAttachments")||a.hasOwnProperty("htmlPopupType")||a.hasOwnProperty("relationships")||a.hasOwnProperty("timeInfo")||a.hasOwnProperty("typeIdField")||a.hasOwnProperty("types")?10:9.3},_processApplyEditsParams:function(a){if(!a)return f.reject(new e("feature-layer:missing-parameters","'addFeatures', 'updateFeatures' or 'deleteFeatures' parameter is required"));
a=h.mixin({},a);a.addFeatures=a.addFeatures||[];a.updateFeatures=a.updateFeatures||[];a.deleteFeatures=a.deleteFeatures||[];if(a.addFeatures.length||a.updateFeatures.length||a.deleteFeatures.length){var b=function(a){var b=new v;b.geometry=a.geometry;b.attributes=a.attributes;return b};a.addFeatures=a.addFeatures.map(b);a.updateFeatures=a.updateFeatures.map(b);return this._normalizeGeometries(a).then(function(a){return f.resolve(a)})}return f.reject(new e("feature-layer:missing-parameters","'addFeatures', 'updateFeatures' or 'deleteFeatures' parameter is required"))},
_normalizeGeometries:function(a){var b=a.addFeatures,c=a.updateFeatures,d=b.concat(c).map(function(a){return a.geometry});return I.normalizeCentralMeridian(d).then(function(d){var e=b.length,f=c.length;d.slice(0,e).forEach(function(b,c){a.addFeatures[c].geometry=b});d.slice(e,e+f).forEach(function(b,c){a.updateFeatures[c].geometry=b});return a})}});return D});