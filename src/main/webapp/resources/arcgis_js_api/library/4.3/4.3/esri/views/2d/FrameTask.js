// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define(["require","exports","../../core/Scheduler","./FrameBudget"],function(m,n,k,l){return function(){function d(c){var b=this;this.view=c;this._frameTaskHandle=null;this._layerViewsTrash=[];this._layerViewsToUpdate=[];this._layerViewsState={};this._budget=new l(this.budget);this._updateParameters={budget:this._budget,state:this.view.state,devicePixelRatio:window.devicePixelRatio,stationary:!0};this.budget=6;this.updateEnabled=this.stationary=!0;this.prepare=function(){b._updateParameters.state=
b.view.state;b._updateParameters.stationary=b.view.stationary;b._budget.reset(b.budget)};this.update=function(){if(b.updateEnabled){for(var c=b._budget,a=b.view,f=a.allLayerViews.toArray().filter(function(a){return null==a.layerViews}),d=f.length,g=a.state,e=0;e<f.length;e++)if(a=f[e],a.attached){var h=b._layerViewsState[a.uid];if(null==h||!b.stationary&&!a.moving)a.moving=!0,a.moveStart();h!==g.id&&a.viewChange();b.stationary&&a.moving&&(a.moving=!1,a.moveEnd());b._layerViewsState[a.uid]=g.id}g=
b._layerViewsTrash;for(e=0;e<g.length;e++)a=g[e],a.attached&&(a.detach(),a.attached=!1);for(e=g.length=0;e<d;e++)a=f[e],a.attached||b._attachLayerView(a);f=b._layerViewsToUpdate;d=f.slice();a=b._updateParameters;for(b._layerViewsToUpdate.length=0;!c.done&&0<d.length;)d.shift().processUpdate(a);0<d.length&&f.unshift.apply(f,d);0===f.length&&0===g.length&&b._frameTaskHandle.pause()}}}d.prototype.destroy=function(){this._allLayerViewsChangeHandle.remove();this._frameTaskHandle.remove()};d.prototype.start=
function(){var c=this;this._allLayerViewsChangeHandle=this.view.allLayerViews.on("change",function(b){Array.prototype.push.apply(c._layerViewsTrash,b.removed);c.requestFrame()});this._frameTaskHandle=k.addFrameTask(this);this._frameTaskHandle.pause()};d.prototype.stop=function(){this._allLayerViewsChangeHandle.remove();this._allLayerViewsChangeHandle=null;this._frameTaskHandle.pause()};d.prototype.requestLayerViewUpdate=function(c){this._layerViewsToUpdate.push(c);this.requestFrame()};d.prototype.requestFrame=
function(){this._frameTaskHandle&&this._frameTaskHandle.isPaused()&&this._frameTaskHandle.resume()};d.prototype._attachLayerView=function(c){c.attached||(c.attached=!0,c.attach())};d.prototype._detachLayerView=function(c){c.attached&&(c.detach(),c.attached=!1)};return d}()});