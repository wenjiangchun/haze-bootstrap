// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/accessorSupport/decorators dojo/_base/lang dojo/io-query dojo/errors/CancelError ../core/promiseUtils ../config ../request ./DynamicLayer ./mixins/ArcGISDynamicMapService ./mixins/OperationalLayer ./mixins/PortalLayer".split(" "),function(c,w,m,f,e,g,n,p,h,q,k,r,t,u,v){c=function(c){function b(a,d){a=c.call(this)||this;a.alwaysRefetch=!1;a.legendEnabled=!0;a.operationalLayerType="ArcGISMapServiceLayer";
a.type="map-image";return a}m(b,c);b.prototype.normalizeCtorArgs=function(a,d){return"string"===typeof a?g.mixin({url:a},d):a};b.prototype.load=function(){var a=this;this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Map Service"]}).then(function(){return a._fetchService()}));return this};b.prototype.readLegendEnabled=function(a,d){return null!=d.showLegend?d.showLegend:!0};b.prototype.writeLegendEnabled=function(a,d){a||(d.showLegend=!1)};b.prototype.getImageUrl=function(a,d){var c=this,
l=this.parsedUrl.path+"/export";a=g.mixin({},this.parsedUrl.query,this.createExportImageParameters(a),{f:"image",token:this.token,_ts:this.alwaysRefetch?(new Date).getTime():null});var b=l+"?"+n.objectToQuery(a);b.length>q.request.maxUrlLength?(a.f="json",k(l,{query:a,responseType:"json",callbackParamName:"callback"}).then(function(a){return a.data.href+(c.token?"?token\x3d"+c.token:"")}).then(d)):d(b)};b.prototype.fetchImage=function(a){var c=this,b;10.3>this.version&&delete a.rotation;return h.wrapCallback(function(b){return c.getImageUrl(a,
b)}).then(function(a){b=a;return k(b,{responseType:"image"})}).then(function(b){return{options:a,img:b.data}}).otherwise(function(a){return h.reject(a instanceof p?a:Error("Unable to load image: "+b))})};b.prototype._fetchService=function(){var a=this;return h.resolve().then(function(){return a.resourceInfo?{ssl:!1,data:a.resourceInfo}:k(a.parsedUrl.path,{query:g.mixin({f:"json"},a.parsedUrl.query),responseType:"json",callbackParamName:"callback"})}).then(function(b){b.ssl&&(a.url=a.url.replace(/^http:/i,
"https:"));a.read(b.data,{origin:"service",url:a.parsedUrl})})};return b}(e.declared(r,t,u,v));f([e.property()],c.prototype,"alwaysRefetch",void 0);f([e.property({type:Boolean})],c.prototype,"legendEnabled",void 0);f([e.reader("legendEnabled",["showLegend"])],c.prototype,"readLegendEnabled",null);f([e.writer("legendEnabled")],c.prototype,"writeLegendEnabled",null);f([e.property()],c.prototype,"operationalLayerType",void 0);f([e.property({json:{read:!1}})],c.prototype,"type",void 0);return c=f([e.subclass("esri.layers.MapImageLayer")],
c)});