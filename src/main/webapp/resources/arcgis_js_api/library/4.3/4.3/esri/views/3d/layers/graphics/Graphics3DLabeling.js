// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports dojo/promise/all ../../../../core/HandleRegistry ../../../../core/watchUtils ../../../../layers/support/LabelClass ../../lib/glMatrix ../../webgl-engine/lib/TextTextureAtlas ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/materials/HUDMaterial ./Graphics3DWebStyleSymbol".split(" "),function(n,k,u,v,w,p,l,x,y,z,q){var r=l.vec3d;n=function(){function c(){this.hudMaterialCollection=this.textTextureAtlas=null;this.labelVisibilityDirty=!1;this.labelClasses=[];this.eventHandles=
new v;this.graphicsCore=this.layer=this.layerView=null}c.prototype.initialize=function(b,a,f,d){var c=this;this.layerView=b;this.layer=a;this.graphicsCore=d;this.labelGraphicsCreated=f;this.layerView.view.labelManager.addSceneServiceLayerView(this);this.eventHandles.add(w.whenNot(this.layerView,"suspended",function(){return c.resume()}))};c.prototype.destroy=function(){this.layerView.view.labelManager.removeSceneServiceLayerView(this);this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=
null);this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null);this.labelClasses=null;this.eventHandles.destroy();this.graphicsCore=this.layer=this.layerView=this.eventHandles=null};c.prototype.clear=function(){this.layerView.view.labelManager.setDirty();this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null);this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null)};c.prototype.updateLabelingInfo=
function(){var b=this;this.removeLabels();return this.layer.then(function(){var a=b.layer.labelingInfo&&b.layer.labelingInfo.filter(function(a){return!!a.symbol});if(a&&0<a.length){var f=Array(a.length),a=a.map(function(a,c){var d=b.graphicsCore.getOrCreateGraphics3DSymbol(a.symbol),g;g=d instanceof q?d.graphics3DSymbol:d;f[c]={labelClass:a,graphics3DSymbolLayer:g,options:a.getOptions()};return d});return u(a).then(function(){return f})}return null}).then(function(a){b.labelClasses=a;b.labelVisibilityChanged()})};
c.prototype.createLabelsForGraphic=function(b,a){var f=!1;if(this.labelClasses&&0!==this.labelClasses.length&&a._graphics[0]){for(var d=0;d<this.labelClasses.length;d++){var c=this.labelClasses[d],e=c.labelClass;if(p.evaluateWhere(e.where,b.attributes)&&(e=e.getLabelExpression(),e.expression&&(e=p.buildLabelText(e.expression,b,this.layer.fields,c.options)))){var d=c.graphics3DSymbolLayer.childGraphics3DSymbols[0],h=this.evalLabelPlacementParams(b,a);null==this.textTextureAtlas&&(this.textTextureAtlas=
new x(this.layer.id,this.layerView.view._stage),this.hudMaterialCollection=new y(this.layerView.view._stage));if(d=d.createGraphics3DGraphic(b,{text:e,centerOffset:h.centerOffset,translation:h.translation,screenOffset:h.screenOffset,anchor:h.anchor},this.hudMaterialCollection,this.textTextureAtlas))d._labelClass=c.labelClass,a.addLabelGraphic(d,this.graphicsCore.labelStageLayer,this.graphicsCore.stage),d.setVisibilityFlag("VISIBILITY_LABEL_SHOW",this.layerLabelsEnabled()),this.layerView.view.labelManager.setInitialLabelGraphicState(d),
f=!0;break}}f&&this.labelGraphicsCreated&&this.labelGraphicsCreated(b,a)}};c.prototype.evalLabelPlacementParams=function(b,a){var c=e[this.layer.labelingInfo[0].labelPlacement]||e["default"];if("polygon"===b.geometry.type||"polyline"===b.geometry.type||"extent"===b.geometry.type)return{anchor:"center"};if("point"!==b.geometry.type)return{anchor:c.anchor};b=a.graphics3DSymbol;var d=(b instanceof q?b.graphics3DSymbol:b).symbol.symbolLayers.getItemAt(0);b={screenOffset:[0,0],centerOffset:[0,0,0,-1],
translation:r.create(a.getCenterObjectSpace()),anchor:c.anchor};var g=a._graphics[0];"Icon"===d.type?(d=g.getScreenSize(),a.isDraped()?b.anchor="center":(a=g.stageObject.getGeometryRecords()[0].materials[0],a instanceof z?(a=a.getParams(),b.screenOffset=[d[0]/2*(c.normalizedOffset[0]-2*(a.anchorPos[0]-.5)),d[1]/2*(c.normalizedOffset[1]-2*(a.anchorPos[1]-.5))]):b.screenOffset=[d[0]/2*c.normalizedOffset[0],d[1]/2*c.normalizedOffset[1]])):"Object"===d.type&&(a=g.getBoundingBoxObjectSpace(),d=[a[3]-a[0],
a[4]-a[1],a[5]-a[2]],b.centerOffset[0]=1.1*Math.max(d[0],d[1])/2*c.normalizedOffset[0],b.translation[2]+=1.1*d[2]/2*c.normalizedOffset[1],a=r.length(d),b.centerOffset[2]=1.1*a/2*c.normalizedOffset[2]);return b};c.prototype.layerLabelsEnabled=function(){return this.layer.labelsVisible};c.prototype.getGraphics3DGraphics=function(){return this.graphicsCore.getGraphics3DGraphics()};c.prototype.getGraphics3DGraphicsKeys=function(){return this.graphicsCore.getGraphics3DGraphicsKeys()};c.prototype.labelVisibilityChanged=
function(){var c=this;if(this.layerView.suspended)this.labelVisibilityDirty=!0;else if(this.layerView.loadedGraphics){var a=this.layerLabelsEnabled();this.layerView.loadedGraphics.forEach(function(b){var d=c.graphicsCore.getGraphics3DGraphicById(b.uid);if(d)for(a&&0===d._labelGraphics.length&&c.createLabelsForGraphic(b,d),b=0;b<d._labelGraphics.length;b++)d._labelGraphics[b].setVisibilityFlag("VISIBILITY_LABEL_SHOW",a)});this.layerView.view.labelManager.setDirty();this.labelVisibilityDirty=!1}};c.prototype.elevationInfoChange=
function(){this.labelClasses&&this.labelClasses.forEach(function(b){b.graphics3DSymbolLayer.layerPropertyChanged("elevationInfo",{})})};c.prototype.resume=function(){this.labelVisibilityDirty&&this.labelVisibilityChanged()};c.prototype.removeLabels=function(){var b=this;this.layerView.loadedGraphics&&(this.layerView.loadedGraphics.forEach(function(a){if(a=b.graphicsCore.getGraphics3DGraphicById(a.uid))a._labelGraphics&&a._labelGraphics.forEach(function(a){return a._labelClass=null}),a.clearLabelGraphics()}),
this.labelClasses=null,this.layerView.view.labelManager.setDirty())};return c}();var e={"above-center":{normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{normalizedOffset:[0,0,1],anchor:"center"},
"center-left":{normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{normalizedOffset:[1,0,0],anchor:"left"}};k={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],
"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};var t,m;for(m in k)l=k[m],t=e[m],l.forEach(function(c){e[c]=t});Object.freeze&&(Object.freeze(e),Object.keys(e).forEach(function(c){Object.freeze(e[c]);Object.freeze(e[c].normalizedOffset)}));return n});