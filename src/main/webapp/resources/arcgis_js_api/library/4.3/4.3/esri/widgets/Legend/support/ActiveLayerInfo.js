// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("../../../Color ../../../request ../../../renderers/SimpleRenderer ../../../renderers/ClassBreaksRenderer ../../../renderers/UniqueValueRenderer ../../../renderers/support/jsonUtils ../../../core/Accessor ../../../core/HandleRegistry ../../../core/Logger ../../../core/arrayUtils ../../../core/promiseUtils ../../../layers/support/ExportImageParameters ../../../symbols/support/symbolPreview ./colorRampUtils ./sizeRampUtils dojo/_base/lang".split(" "),function(v,w,r,n,u,x,y,z,A,B,l,C,D,q,E,m){var g=
A.getLogger("esri.widgets.Legend.support.ActiveLayerInfo");return y.createSubclass({declaredClass:"esri.widgets.Legend.support.ActiveLayerInfo",constructor:function(){this._legendResponse=null;this._handles=new z;var a=this.watch("tearingDown",function(){this.destroy()}.bind(this));this._handles.add(a,"tearingDown-watcher")},getDefaults:function(){return{legendElements:[]}},destroy:function(){this._handles.destroy();this._legendResponse=this._handles=null},properties:{layer:null,legendElements:{type:Array},
ready:!1,tearingDown:!1,title:null,scale:null,updating:!1,version:{value:0,readOnly:!0,dependsOn:["updating"],get:function(){return this._get("version")+1}},_hasColorRamp:!1,_hasOpacityRamp:!1,_hasSizeRamp:!1},buildLegendElementsForFeatureCollections:function(){this.layer.featureCollections.forEach(function(a){if(a.featureSet.features.length){var b=a.layerDefinition;(b=(b=b&&b.drawingInfo)&&x.fromJSON(b.renderer))?this._getRendererLegendElements(b,a.name).then(function(a){this.updating=!0;this.ready=
!1;a&&a.length&&(Array.prototype.push.apply(this.legendElements,a),this.ready=!0)}.bind(this)).otherwise(function(a){g.warn("error while building legend for layer!",a)}).always(function(){this.updating=!1}.bind(this)):g.warn("drawingInfo not available!")}},this)},buildLegendElementsForRenderer:function(){this._getRendererLegendElements(this.layer.renderer).then(function(a){this.updating=!0;this.ready=!1;this.legendElements=a;this.legendElements.length&&(this.ready=!0)}.bind(this)).otherwise(function(a){g.warn("error while building legend for layer!",
a)}).always(function(){this.updating=!1}.bind(this))},buildLegendElementsForTools:function(){this.layer.sublayers?this._constructLegendElementsForSublayers():(this._handles.remove("imageryLayers-watcher"),this._getLegendLayers().then(function(a){this.updating=!0;this.ready=!1;this.legendElements=[];a.forEach(function(a){if("esri.layers.ImageryLayer"===this.layer.declaredClass){var b=this.layer.watch("renderingRule, bandIds",function(){this._legendResponse=null;this.buildLegendElementsForTools()}.bind(this));
this._handles.add(b,"imageryLayers-watcher")}(a=this._generateSymbolTableElementForLegendLayer(a))&&a.infos.length&&this.legendElements.push(a)},this);this.legendElements.length&&(this.ready=!0)}.bind(this)).otherwise(function(a){g.warn("Request to server for legend has failed!",a)}).always(function(){this.updating=!1}.bind(this)))},_getLegendLayers:function(a){var b=a&&a.hasDynamicLayers,d=this._legendResponse;return!b&&d?l.resolve(d):this._legendRequest(b?a.dynamicLayers:null).then(function(a){return this._legendResponse=
a=a.data.layers}.bind(this))},_legendRequest:function(a){var b=this.layer,d=b.url.replace(/(\/)+$/,"");a={f:"json",dynamicLayers:a};"esri.layers.ImageryLayer"===b.declaredClass&&(b.renderingRule&&(a.renderingRule=JSON.stringify(b.renderingRule.toJSON())),b.bandIds&&(a.bandIds=b.bandIds.join()));if(10.01<=b.version){var c=d.indexOf("?"),d=-1<c?d.substring(0,c)+"/legend"+d.substring(c):d+"/legend";b.token&&(d+="?token\x3d"+b.token)}else b=d.toLowerCase().indexOf("/rest/"),d=d.substring(0,b)+d.substring(b+
5,d.length),d="https://utility.arcgis.com/sharing/tools/legend?soapUrl\x3d"+window.escape(d)+"\x26returnbytes\x3dtrue";return w(d,{query:a,callbackParamName:"callback"})},_constructLegendElementsForSublayers:function(){this.updating=!0;this.ready=!1;this.legendElements=[];this._handles.remove("sublayers-watcher");var a=new C({layer:this.layer});this._getLegendLayers(a).then(function(a){var b={};a.forEach(function(a){b[a.layerId]=a});this.legendElements=this._generateLegendElementsForSublayers(this.layer.sublayers,
b,this.layer.opacity);this.legendElements.length&&(this.ready=!0)}.bind(this)).otherwise(function(a){g.warn("Request to server for legend has failed!",a)}).always(function(){a.destroy();this.updating=!1}.bind(this))},_generateLegendElementsForSublayers:function(a,b,d){var c=[];this._handles.add(a.on("change",this._constructLegendElementsForSublayers.bind(this)),"sublayers-watcher");a.forEach(function(a){var e=a.watch("renderer, opacity, title, visible",this._constructLegendElementsForSublayers.bind(this));
this._handles.add(e,"sublayers-watcher");a.visible&&a.legendEnabled&&(e=a&&null!=a.opacity?a.opacity:null,(a=this._generateSymbolTableElementForSublayer(a,b,null!=e?e*d:d))&&a.infos.length&&c.unshift(a))},this);return c},_generateSymbolTableElementForSublayer:function(a,b,d){var c=b[a.id];return!c&&a.sublayers?(b=this._generateLegendElementsForSublayers(a.sublayers,b,d),{type:"symbol-table",title:a.title,infos:b}):this._generateSymbolTableElementForLegendLayer(c,a,d)},_generateSymbolTableElementForLegendLayer:function(a,
b,d){if(a){var c=a.layerName,e=b&&b.renderer;e&&(e=b&&b.title?b.title:this._getRendererTitle(e,b))&&(c&&(e.title=c),c=e);c={type:"symbol-table",title:c,infos:[]};a.legendType&&(c.legendType=a.legendType);a.legend&&this._isLegendLayerInScale(a,b)&&(b=b?this._sanitizeLegendForSublayer(a.legend,b):a.legend,c.infos=b.map(function(b){var c=b.url;if(b.imageData&&0<b.imageData.length)c="data:image/png;base64,"+b.imageData;else if(0!==c.indexOf("http")){var c=this.layer.url+"/"+a.layerId+"/images/"+c,e=this.layer.token;
e&&(c+="?token\x3d"+e)}else return null;return{label:b.label,src:c,opacity:d,width:b.width,height:b.height}},this).filter(function(a){return!!a}));return c.infos.length?c:null}},_sanitizeLegendForSublayer:function(a,b){if(10.1>this.layer.version||0===a.length)return a;b=b.renderer;var d,c;a.some(function(a){return a.values})&&a.some(function(a,b){a.values||(d=b,c=a,c.label||(c.label="others"));return null!=c});b?"uniqueValue"===b.type?c&&(a.splice(d,1),a.push(c)):"classBreaks"===b.type&&(c&&a.splice(d,
1),a.reverse(),c&&a.push(c)):c&&(a.splice(d,1),a.push(c));return a},_isLegendLayerInScale:function(a,b){b=b||this.layer;var d=!0,c,e;!b.minScale&&0!==b.minScale||!b.maxScale&&0!==b.maxScale?(0===a.minScale&&b.tileInfo&&(c=b.tileInfo.lods[0].scale),0===a.maxScale&&b.tileInfo&&(e=b.tileInfo.lods[b.tileInfo.lods.length-1].scale)):(c=Math.min(b.minScale,a.minScale)||b.minScale||a.minScale,e=Math.max(b.maxScale,a.maxScale));if(0<c&&c<this.scale||e>this.scale)d=!1;return d},_getRendererLegendElements:function(a,
b){return this._loadRenderer(a).then(function(d){this._hasSizeRamp=this._hasOpacityRamp=this._hasColorRamp=!1;var c=this._getVisualVariableLegendElements(d)||[],e={type:"symbol-table",title:b||this._getRendererTitle(d),infos:[]},k=a.isInstanceOf(r),f=a.isInstanceOf(n),h=a.isInstanceOf(u),t=k||f||h;if(h)d.uniqueValueInfos.forEach(function(a){a.symbol&&e.infos.push({label:a.label||a.value,value:a.value,symbol:a.symbol})},this);else if(f){var p=this._isUnclassedRenderer(d);p&&this._hasSizeRamp||(d.classBreakInfos.forEach(function(a){a.symbol&&
e.infos.unshift({label:a.label||(p?null:a.minValue+" - "+a.maxValue),value:[a.minValue,a.maxValue],symbol:a.symbol})}),p&&(e.title=null))}else k&&d.symbol&&!this._hasSizeRamp&&e.infos.push({label:d.label,symbol:d.symbol});f=!1;t&&(t=d.defaultLabel,(h=d.defaultSymbol)&&!p&&(e.infos.push({label:t||"others",symbol:h}),f=!0));f||k||p&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||c.push({type:"symbol-table",infos:[{label:d.defaultLabel,symbol:d.defaultSymbol}]});e.infos.length&&c.unshift(e);
var g=[],m=this._getSymbolConfig(d.visualVariables);c.forEach(function(a){a.infos.forEach(function(a){a.symbol&&g.push(this._getSymbolPreview(a,m))},this)},this);d=null;return l.eachAlways(g).then(function(){return c})}.bind(this))},_getSymbolConfig:function(a){var b=!1,d=!1;a&&a.forEach(function(a){"size"===a.type&&("height"===a.axis&&(b=!0),"width-and-depth"===a.axis&&(d=!0))});return b&&d?"tall":null},_getSymbolPreview:function(a,b){return D.renderPreviewHTML(a.symbol,{size:a.size,opacity:this.layer.opacity,
symbolConfig:b}).then(function(b){a.preview=b;return a}).otherwise(function(){a.preview=null;return a})},_getVisualVariableLegendElements:function(a){var b=a.visualVariables,d=[],c=[],e=[],k=this.layer.opacity,f=null,h=null;if(!b)return null;b.forEach(function(a){"color"===a.type?d.push(a):"size"===a.type?c.push(a):"opacity"===a.type&&e.push(a)});b=[];Array.prototype.push.apply(b,d);Array.prototype.push.apply(b,c);Array.prototype.push.apply(b,e);0===d.length&&a.isInstanceOf(n)&&a.classBreakInfos&&
1===a.classBreakInfos.length&&(f=(f=a.classBreakInfos[0])&&f.symbol);0===d.length&&a.isInstanceOf(r)&&(f=a.symbol);f&&(-1<f.type.indexOf("3d")?(f=f.symbolLayers.getItemAt(0),f.get("material.color")&&(h=f.material.color)):f.url||(h=f.color),h&&(h=h.toRgba()));return b.map(function(b){if(!b.legendOptions||!1!==b.legendOptions.showLegend){var c=this._getRampTitle(b,this.layer),d=q.getRampBorderColor(a),e=q.getRampOverlayColor(k),f;"color"===b.type?(f={type:"color-ramp",title:c,borderColor:d,overlayColor:e,
infos:q.getRampStops(a,b)},this._hasColorRamp||(this._hasColorRamp=null!=f.infos&&f.infos.length)):"size"===b.type?(f={type:"size-ramp",title:c,infos:E.getRampStops(a,b,this._getMedianColor(a),this.scale)},this._hasSizeRamp||(this._hasSizeRamp=null!=f.infos&&f.infos.length)):"opacity"===b.type&&(f={type:"opacity-ramp",title:c,borderColor:d,overlayColor:e,infos:q.getRampStops(a,b,h)},this._hasOpacityRamp||(this._hasOpacityRamp=null!=f.infos&&f.infos.length));return f.infos&&f}},this).filter(function(a){return!!a})},
_loadRenderer:function(a){var b=a.isInstanceOf(r),d=a.isInstanceOf(n),c=a.isInstanceOf(u),e=[];if(!(b||d||c))return g.warn("Renderer not supported!"),l.reject();a=a.clone();var k=this._getMedianColor(a),f=this.layer.opacity;(d||c)&&(a.classBreakInfos||a.uniqueValueInfos).forEach(function(a){e.push(this._fetchSymbol(a.symbol,k,f).then(function(b){a.symbol=b}).otherwise(function(){a.symbol=null}))},this);e.push(this._fetchSymbol(a.symbol||a.defaultSymbol,a.defaultSymbol?null:k,f).then(function(c){b?
a.symbol=c:a.defaultSymbol=c}).otherwise(function(){b?a.symbol=null:a.defaultSymbol=null}));return l.eachAlways(e).then(function(){return a})},_fetchSymbol:function(a,b,d){return a?"web-style-symbol"===a.type?a.fetchSymbol().then(function(a){return this._getAppliedCloneSymbol(a,b,d)}.bind(this)).otherwise(function(){g.warn("Fetching web-style-symbol failed!");return l.reject()}):l.resolve(this._getAppliedCloneSymbol(a,b,d)):l.reject()},_getMedianColor:function(a){var b,d,c;if(!a.visualVariables)return null;
c=B.find(a.visualVariables,function(a){return"color"===a.type});if(!c)return null;if(c.colors)b=c.minDataValue,d=c.maxDataValue;else if(c.stops){if(1===c.stops.length)return c.stops[0].color;b=c.stops[0].value;d=c.stops[c.stops.length-1].value}if(null!=b&&null!=d)return a.getColor(b+(d-b)/2,{colorInfo:c})},_getAppliedCloneSymbol:function(a,b,d){if(!a)return a;a=a.clone();var c=a.type,e=-1<c.indexOf("3d");b&&(b=new v(b.toRgba()),e?this._applyColorTo3dSymbol(a,b):a.color=b);if("simple-line-symbol"===
c||"text-symbol"===c){if(!a.color)return;b=a.color.toRgba();b[3]*=d;a.color=b}else"simple-marker-symbol"===c||"simple-fill-symbol"===c?(a.color&&(b=a.color.toRgba(),b[3]*=d,a.color=b),a.outline&&a.outline.color&&(b=a.outline.color.toRgba(),b[3]*=d,a.outline.color=b)):e&&this._applyColorTo3dSymbol(a,null,d);return a},_applyColorTo3dSymbol:function(a,b,d){a.symbolLayers.forEach(function(a){if(a&&(b&&(a.material||(a.material={}),a.material.color=b),null!=d)){var c;a.material&&a.material.color&&(c=a.material.color.toRgba(),
c[3]*=d,a.material.color=c);a.outline&&a.outline.color&&(c=a.outline.color.toRgba(),c[3]*=d,a.outline.color=c)}})},_getRampTitle:function(a,b){var d=a.field,c=a.normalizationField,e=!1,k=!1,f=!1,d=m.isFunction(d)?null:d,c=m.isFunction(c)?null:c;if(a.legendOptions&&a.legendOptions.title)b=a.legendOptions.title;else if(a.valueExpressionTitle)b=a.valueExpressionTitle;else{if(b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables){a=b.renderer.authoringInfo.visualVariables;for(var h=0;h<a.length;h++){var g=
a[h];if("colorInfo"===g.type)if("ratio"===g.style){e=!0;break}else if("percent"===g.style){k=!0;break}else if("percentTotal"===g.style){f=!0;break}}}b={field:d&&this._getFieldAlias(d,b),normField:c&&this._getFieldAlias(c,b),ratio:e,ratioPercent:k,ratioPercentTotal:f}}return b},_getRendererTitle:function(a,b){if(a.legendOptions&&a.legendOptions.title)return a.legendOptions.title;if(a.valueExpressionTitle)return a.valueExpressionTitle;var d=this.layer,c=a.field,e,k,f;a instanceof n&&(e=a.normalizationField,
k="percent-of-total"===a.normalizationType);c=m.isFunction(c)?null:c;e=m.isFunction(e)?null:e;if(c||e)f={field:b?c:c&&this._getFieldAlias(c,d),normField:b?e:e&&this._getFieldAlias(e,d),normByPct:k};return f},_getFieldAlias:function(a,b){var d=b.popupTemplate,d=d&&d.fieldInfos;b=m.isFunction(a)?null:b.getField&&b.getField(a);var c,e;d&&d.some(function(b){if(a===b.fieldName)return e=b,!0});(d=e||b)&&(c=e&&e.label||b&&b.alias||d.name||d.fieldName);return c},_isUnclassedRenderer:function(a){var b=!1,
d=a.visualVariables;a.isInstanceOf(n)&&a.classBreakInfos&&1===a.classBreakInfos.length&&d&&(b=a.field?d.some(function(b){return!(!b||a.field!==b.field||a.normalizationField!=b.normalizationField)}):!!d.length);return b}})});