// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/Accessor ../../../core/Evented ../../../core/HandleRegistry ../../../core/Promise ../../../geometry/Extent ./support/TileSet ../../../views/2d/layers/support/TileQueue ../../../views/2d/layers/support/TileStrategy ../../../views/2d/layers/support/TileInfoView ../../../views/2d/layers/support/TileKey ../../support/GraphicsManager ../../support/TileInfo".split(" "),
function(c,z,k,h,g,l,m,n,p,q,r,t,u,v,w,x,y){(function(){function c(){}c.prototype.dispose=function(){};return c})();c=function(c){function e(a){var b=c.call(this)||this;b._handles=new n;b._pendingQueries=new Map;b.layer=a.layer;b.layerView=a.layerView;b.graphics=a.graphics;b._tileInfo=y.create({spatialReference:b.layerView.view.spatialReference,size:512});b._tileInfoView=new v(b._tileInfo);b._tileQueue=new t({tileInfoView:b._tileInfoView,process:function(a){return b._fetchTile(a)}});b._tileSet=new r({layer:b.layer,
tileInfo:b._tileInfo});b._graphicsManager=new x({graphics:b.graphics,objectIdField:b.layer.objectIdField});b._tileStrategy=new u({container:{addTile:function(a){b._graphicsManager.add(a.featureSet.features,a.intentId);b._graphicsManager.removeIntent(a.intentId)},removeTile:function(a){b._graphicsManager.remove(a.featureSet.features)},removeAllTiles:function(){b._graphicsManager.removeAll()}},fetchTile:function(a){return b._tileQueue.push(w.from(a))},requestUpdate:function(){return b.layerView.requestUpdate()},
tileInfoView:b._tileInfoView,cachePolicy:"purge"});b._handles.add([b.layer.watch("definitionExpression",function(){return b._refresh()}),b.layer.on("edits",function(a){return b._editsHandler(a)})],"layer");return b}k(e,c);e.prototype.destroy=function(){this._handles.destroy();this._graphicsManager.destroy();this._tileStrategy.destroy();this._tileQueue.clear();this._pendingQueries.forEach(function(a){a.isFulfilled()||a.cancel()})};Object.defineProperty(e.prototype,"graphics",{set:function(a){var b=
this,d=this._get("graphics");d!==a&&(this._handles.remove("graphics"),d&&d.forEach(function(a){return a.layer=null}),a&&(a.forEach(function(a){return a.layer=b.layer}),this._handles.add([a.on("after-add",function(a){return a.item.layer=b.layer}),a.on("after-remove",function(a){return a.item.layer=null})],"graphics")),this._set("graphics",a))},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"updating",{get:function(){return this._tileStrategy.updating||0<this._pendingQueries.size},
enumerable:!0,configurable:!0});e.prototype.update=function(a){this._tileQueue.pause();this._tileQueue.state=a.state;this._tileStrategy.update(a);this._tileQueue.resume();this.notifyChange("updating")};e.prototype._fetchTile=function(a){var b=this,d=this._graphicsManager.createIntentToAdd(),f=this._tileSet.fetch(a).then(function(b){return{key:a,intentId:d,attached:!0,coords:[0,0],featureSet:b,dispose:function(){}}});f.otherwise(function(){return b._graphicsManager.removeIntent(d)});return f};e.prototype._refresh=
function(){var a=this;this._tileQueue.reset();this._tileStrategy.updateTiles(function(b){var d=a._graphicsManager.createIntentToAdd(),f=a._tileSet.fetch(b.key).then(function(f){a._graphicsManager.remove(b.featureSet.features);b.intentId=d;b.featureSet=f;a._graphicsManager.add(b.featureSet.features,b.intentId);return b});f.always(function(){return a._graphicsManager.removeIntent(d)});return f});this.notifyChange("updating")};e.prototype._editsHandler=function(a){var b=this,d=function(a){return a.objectId},
f=a.deletedFeatures.map(d);this._graphicsManager.delete(f);a=a.addedFeatures.concat(a.updatedFeatures).map(d);if(a.length){d=this.layer.createQuery();d.objectIds=a;d.outSpatialReference=this._tileInfo.spatialReference;var c=this._graphicsManager.createIntentToAdd(a);a=this.layer.queryFeatures(d);this._pendingQueries.set(c,a);this.notifyChange("updating");a.then(function(a){return b._refetchHandler(a,c)}).always(function(){b._graphicsManager.removeIntent(c);b._pendingQueries.delete(c);b.notifyChange("updating")})}};
e.prototype._refetchHandler=function(a,b){var d=this,c=a.features;if(c){var e=this._tileInfo.spatialReference;this._tileStrategy.tiles.forEach(function(a,b){b=a.key.extent;var f=new q({xmin:b[0],ymin:b[1],xmax:b[2],ymax:b[3],spatialReference:e});c.forEach(function(b){b.geometry&&f.intersects(b.geometry)&&d._addFeatureToTile(b,a)})});this._graphicsManager.add(c,b)}};e.prototype._addFeatureToTile=function(a,b){var c=b.featureSet.features||[],f=this.layer.objectIdField,e=a.attributes&&a.attributes[f],
g;c.some(function(a){(a.attributes&&a.attributes[f])===e&&(g=a);return!!g});g?(g.geometry=a.geometry,g.attributes=a.attributes):c.push(a);b.featureSet.features=c};return e}(g.declared(l,p,m));h([g.property()],c.prototype,"graphics",null);h([g.property()],c.prototype,"layer",void 0);h([g.property()],c.prototype,"layerView",void 0);h([g.property()],c.prototype,"updating",null);return c=h([g.subclass("esri.layers.graphics.controllers.OnDemandController2D")],c)});